<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Renato Vargas">
<meta name="author" content="Julie Rozenberg">
<meta name="author" content="Colin Lenoble">
<meta name="author" content="Natsuko Kiso Nozaki">
<meta name="author" content="Thomas Farole">

<title>Armenia CCDR - Armenia CCDR Microsimulation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Armenia CCDR</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../supporting-materials/CCDR-poverty-code-explanation.html">Supporting materials</a></li><li class="breadcrumb-item"><a href="../supporting-materials/microsimulation.html">Armenia CCDR Microsimulation</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Background notes</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../bg-notes/hh-assets-and-fuelwood-use.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Household Assets and Fuelwood Use</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../bg-notes/vulnerability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vulnerability Background Note</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Supporting materials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../supporting-materials/CCDR-poverty-code-explanation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A guide to CCDR Poverty Analysis code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../supporting-materials/microsimulation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Armenia CCDR Microsimulation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../supporting-materials/vulnerability-hh-level-impacts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vulnerability Analysis Calculations</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#preamble" id="toc-preamble" class="nav-link" data-scroll-target="#preamble"><span class="header-section-number">2</span> Preamble</a></li>
  <li><a href="#datasets" id="toc-datasets" class="nav-link" data-scroll-target="#datasets"><span class="header-section-number">3</span> Datasets</a></li>
  <li><a href="#data-preparation-income-outliers-and-missings" id="toc-data-preparation-income-outliers-and-missings" class="nav-link" data-scroll-target="#data-preparation-income-outliers-and-missings"><span class="header-section-number">4</span> Data preparation income outliers and missings</a>
  <ul class="collapse">
  <li><a href="#household-consumption-aggregates-and-characteristics" id="toc-household-consumption-aggregates-and-characteristics" class="nav-link" data-scroll-target="#household-consumption-aggregates-and-characteristics"><span class="header-section-number">4.1</span> Household consumption aggregates and characteristics</a></li>
  <li><a href="#demographic-characteristics-education-labor-force" id="toc-demographic-characteristics-education-labor-force" class="nav-link" data-scroll-target="#demographic-characteristics-education-labor-force"><span class="header-section-number">4.2</span> Demographic characteristics, education, Labor Force</a></li>
  <li><a href="#the-regression" id="toc-the-regression" class="nav-link" data-scroll-target="#the-regression"><span class="header-section-number">4.3</span> The regression</a></li>
  <li><a href="#total-income-and-shares" id="toc-total-income-and-shares" class="nav-link" data-scroll-target="#total-income-and-shares"><span class="header-section-number">4.4</span> Total income and shares</a></li>
  </ul></li>
  <li><a href="#un-population-projections" id="toc-un-population-projections" class="nav-link" data-scroll-target="#un-population-projections"><span class="header-section-number">5</span> UN Population Projections</a></li>
  <li><a href="#macro-scenarios" id="toc-macro-scenarios" class="nav-link" data-scroll-target="#macro-scenarios"><span class="header-section-number">6</span> Macro Scenarios</a></li>
  <li><a href="#reweighting-of-the-dataset" id="toc-reweighting-of-the-dataset" class="nav-link" data-scroll-target="#reweighting-of-the-dataset"><span class="header-section-number">7</span> Reweighting of the dataset</a>
  <ul class="collapse">
  <li><a href="#aggregation-of-population-data" id="toc-aggregation-of-population-data" class="nav-link" data-scroll-target="#aggregation-of-population-data"><span class="header-section-number">7.1</span> Aggregation of population data</a></li>
  <li><a href="#reweigting" id="toc-reweigting" class="nav-link" data-scroll-target="#reweigting"><span class="header-section-number">7.2</span> Reweigting</a></li>
  </ul></li>
  <li><a href="#microsimulation" id="toc-microsimulation" class="nav-link" data-scroll-target="#microsimulation"><span class="header-section-number">8</span> Microsimulation</a>
  <ul class="collapse">
  <li><a href="#baseline" id="toc-baseline" class="nav-link" data-scroll-target="#baseline"><span class="header-section-number">8.1</span> Baseline</a></li>
  <li><a href="#climate-change" id="toc-climate-change" class="nav-link" data-scroll-target="#climate-change"><span class="header-section-number">8.2</span> Climate change</a></li>
  <li><a href="#food-prices" id="toc-food-prices" class="nav-link" data-scroll-target="#food-prices"><span class="header-section-number">8.3</span> Food prices</a></li>
  </ul></li>
  <li><a href="#end" id="toc-end" class="nav-link" data-scroll-target="#end"><span class="header-section-number">9</span> End</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/rvconsulting/armenia-ccdr/edit/master/supporting-materials/microsimulation.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/rvconsulting/armenia-ccdr/issues" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="microsimulation.docx"><i class="bi bi-file-word"></i>MS Word</a></li><li><a href="microsimulation.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../supporting-materials/CCDR-poverty-code-explanation.html">Supporting materials</a></li><li class="breadcrumb-item"><a href="../supporting-materials/microsimulation.html">Armenia CCDR Microsimulation</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Armenia CCDR Microsimulation</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Renato Vargas <a href="mailto:renovargas@gmail.com" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Consultant
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Julie Rozenberg <a href="mailto:jrozenberg@worldbank.org" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            The World Bank
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Colin Lenoble <a href="mailto:clenoble@worldbank.org" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            The World Bank
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Natsuko Kiso Nozaki <a href="mailto:nkiso@worldbank.org" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            The World Bank
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Thomas Farole <a href="mailto:tfarole@worldbank.org" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            The World Bank
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>In this calculation file, we “age” the household survey according to demographic projections and different macroeconomic scenarios to explore the impact of climate-related risks and policy measures on the consumption expenditure distribution.</p>
<p>As a convention, code is presented in the following format in this guide:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Some comment that is not evaluated by R</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>some_variable <span class="ot">&lt;-</span> <span class="fu">some_function</span>(some_object, <span class="at">some_parameter =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We assume that the reader has created an Rstudio project and is familiar with basic R functions. Within that project we recommend the following file structure:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>root/</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>├── scripts</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>│   └── my_script.R</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>├── data/</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>|   ├── my_data.sav</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>|   ├── my_data.dta</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>|   └── my_data.csv</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>└── output</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    ├── my_output1.csv</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    └── my_output2.xlsx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using RStudio project makes it possible to not use <code>setwd()</code> to establish the root directory and refer to subdirectories in a relative manner, making interoperability easier within teams and not hard coding a particular computer’s file structure into the code. If you are not using RStudio, just add <code>setwd(r'(C:\My\path\to\project\root)')</code> at the beginning of your coding session.</p>
</section>
<section id="preamble" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="preamble"><span class="header-section-number">2</span> Preamble</h2>
<p>We start with a clean environment, making sure that any objects from a previous session are not present. We take this opportunity to keep our country ISO code in a variable <code>iso</code> in case we need it later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean workspace</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Armenia country ISO code</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>iso <span class="ot">&lt;-</span> <span class="st">"ARM"</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Survey year</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>surveyyear <span class="ot">&lt;-</span> <span class="dv">2022</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Exchange rate USD per dram</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>er <span class="ot">&lt;-</span> <span class="fl">0.002310</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We call the appropriate libraries.</p>
<p>Rather than calling our libraries as we go, we will make sure we have everything we need from the beginning.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># includes dplyr, ggplot2 and others</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(haven)     <span class="co"># to read SPSS and Stata datasets</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)    <span class="co"># to read from MS-Excel</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(openxlsx)  <span class="co"># to write to MS-Excel.</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)        <span class="co"># pretty tables</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)       <span class="co"># Companion to applied regression</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelr)    <span class="co"># regression models</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">#library(ebal)      # Entropy reweighting</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(anesrake)  <span class="co"># Raking reweighting</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">#library(weights)   # Weigthed survey statistics</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)   <span class="co"># pretty subtotals</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)     <span class="co"># More regressions</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)     <span class="co"># map vectors (aggregation)</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zoo)       <span class="co"># Calculate moving window average and max value</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Geopackages</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)        <span class="co"># to read and write shapefile maps</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)     <span class="co"># to perform geocalculations</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)      <span class="co"># for static and interactive maps</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Stata integration</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RStata)    <span class="co"># stata integration for wentropy function</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"RStata.StataPath"</span> <span class="ot">=</span> <span class="st">"</span><span class="sc">\"</span><span class="st">C:</span><span class="sc">\\</span><span class="st">Program Files (x86)</span><span class="sc">\\</span><span class="st">Stata11</span><span class="sc">\\</span><span class="st">StataMP</span><span class="sc">\"</span><span class="st">"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"RStata.StataVersion"</span> <span class="ot">=</span> <span class="dv">11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="datasets" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="datasets"><span class="header-section-number">3</span> Datasets</h2>
<p>We then load the datasets that we need for this study. The World Bank has processed some of these already for poverty analysis and so we have the original SPSS datasets with all variables for Households <code>hh</code> and for Individuals <code>pp</code>, as well as a consumption aggregate <code>ca</code> and a household income <code>ic</code> dataset, which are Stata datasets. This is for the year 2022. These are imported using the <code>haven</code> package. These are based on Armenia Integrated Living Conditions Survey 2022 <span class="citation" data-cites="armstat_integrated_2023">(<a href="#ref-armstat_integrated_2023" role="doc-biblioref">ARMSTAT, 2023</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original SPSS datasets</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Households (hh)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>hh <span class="ot">&lt;-</span> <span class="fu">read_sav</span>(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data/ARM-HH-survey/original-spss-files/ILCS-ARM-2022-Households.sav"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Persons (pp)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>pp <span class="ot">&lt;-</span> <span class="fu">read_sav</span>(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data/ARM-HH-survey/original-spss-files/ILCS-ARM-2022-Persons.sav"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Processed WB datasets</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumption aggregate at household level (ca)</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>ca  <span class="ot">&lt;-</span> <span class="fu">read_dta</span>(<span class="st">"data/ARM-HH-survey/CONSAGG2022.dta"</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Processed income at household level (ic)</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>ic  <span class="ot">&lt;-</span> <span class="fu">read_dta</span>(<span class="st">"data/ARM-HH-survey/totinc.dta"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will work non-destructively, meaning we will not rewrite these data sets and we will only create intermediate data frame objects from them to perform transformations, selections and other data management tasks. For example, we will keep household assignment to poverty status and consumption deciles handy by creating a subset of our <code>ca</code> data with only our household identifiers, deciles, and poverty.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># From the WB processed dataset, we extract deciles and poverty</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>deciles <span class="ot">&lt;-</span> ca <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>( hhid, decile, poor_Avpovln2022, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>          poor_Foodpovln2022, poor_Lpovln2022, poor_Upovln2022)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our population data comes from UN’s projections.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Population projections UN 2022</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>population_projections <span class="ot">&lt;-</span> <span class="fu">read_dta</span>(<span class="st">"data/UN2022_population.dta"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country <span class="sc">==</span> iso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Macro scenario dataset</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>scenario_file <span class="ot">&lt;-</span> <span class="st">"data/ARM-Microsimulation/ARM_MacroScenarioInformation.xlsx"</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>scenario_varlist <span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data/ARM-Microsimulation/ARM_Macro_varlist.xlsx"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>prices_2030 <span class="ot">&lt;-</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="st">"data/ARM-Microsimulation/prices2030.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Economic sectors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sectors <span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(<span class="st">"data/ARM-HH-survey/economic_activity_codes.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also have geographical information for level 1 in Shapefile format, which we import with the <code>sf</code> package. We rename the column with the name of the administrative region to match our household survey data set conventions to ease mergers. The <code>dplyr</code> package from the <code>tidyverse</code> meta package allows us to “pipe” or link processing steps using the <code>%&gt;%</code> pipe, which can be inserted using <strong>Ctrl + m.</strong> Although there is no geoprocessing in this analysis, this will come in handy for graphical presentations. Let’s have a look at it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Geodata</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Armenia marzes or administrative level 1 shapefile</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>adm1 <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"data/ARM-Geodata/ARM-ADM1.shp"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(NAM_1, COD_HH_SVY, geometry) <span class="sc">%&gt;%</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make sure that names match the rest of datasets</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">NAM_1 =</span> <span class="fu">if_else</span>(NAM_1 <span class="sc">==</span> <span class="st">"Gergharkunik"</span>, <span class="st">"Gegharkunik"</span>, NAM_1))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(adm1)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"hh_02"</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(adm1)<span class="sc">+</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="st">"NAM_1"</span>, <span class="at">legend.show =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_text</span>(<span class="st">"NAM_1"</span>, <span class="at">size =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="microsimulation_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Marzes names are more accurate in the shapefile than in the survey. We will use them from here on instead of the survey factor labels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>hh <span class="ot">&lt;-</span> hh <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(adm1, <span class="fu">join_by</span>(hh_02 <span class="sc">==</span> hh_02)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>geometry)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>ic <span class="ot">&lt;-</span> ic <span class="sc">%&gt;%</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(adm1, <span class="fu">join_by</span>(hh_02 <span class="sc">==</span> hh_02)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>geometry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Labor productivity</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>file <span class="ot">&lt;-</span> r<span class="st">"(data/ARM-Microsimulation/LaborProductivityChanges.xlsx)"</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>sheets <span class="ot">&lt;-</span> <span class="fu">excel_sheets</span>(file)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Use lapply to read and process each sheet</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>heat_l_pdcty <span class="ot">&lt;-</span> <span class="fu">lapply</span>(sheets, <span class="cf">function</span>(sheet) {</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  info <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    file,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sheet =</span> sheet,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_names =</span> <span class="cn">TRUE</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_types =</span> <span class="fu">c</span>(<span class="st">"text"</span>, <span class="st">"text"</span>, <span class="st">"numeric"</span>, <span class="st">"text"</span>, <span class="st">"numeric"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  info<span class="sc">$</span>sector <span class="ot">&lt;-</span> sheet</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(info)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind all data frames in the list into a single data frame</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>heat_l_pdcty <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(heat_l_pdcty)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, but not least important, we have our vulnerability information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>buildings_aal <span class="ot">&lt;-</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_xlsx</span>(<span class="st">"data/ARM-Vulnerability-Analysis/Data_AAL_AAE.xlsx"</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">sheet =</span> <span class="st">"Building_AAL"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make sure that names match the rest of datasets</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">NAM_1 =</span> <span class="fu">if_else</span>(NAM_1 <span class="sc">==</span> <span class="st">"Gergharkunik"</span>, <span class="st">"Gegharkunik"</span>, NAM_1))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>buildings_1in100 <span class="ot">&lt;-</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_xlsx</span>(<span class="st">"data/ARM-Vulnerability-Analysis/Data_AAL_AAE.xlsx"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">sheet =</span> <span class="st">"Building_1in100"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>crops_productivity <span class="ot">&lt;-</span> </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="st">"data/ARM-Vulnerability-Analysis/ARM_crops_combined_REF_shock_admin1.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">NAM_1 =</span> Province)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>crops_aal <span class="ot">&lt;-</span> </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_xlsx</span>(<span class="st">"data/ARM-Vulnerability-Analysis/Data_AAL_AAE.xlsx"</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">sheet =</span> <span class="st">"Agriculture_AAL"</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>crops_1in100 <span class="ot">&lt;-</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_xlsx</span>(<span class="st">"data/ARM-Vulnerability-Analysis/Data_AAL_AAE.xlsx"</span>,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">sheet =</span> <span class="st">"Agriculture_1in100"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-preparation-income-outliers-and-missings" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="data-preparation-income-outliers-and-missings"><span class="header-section-number">4</span> Data preparation income outliers and missings</h2>
<section id="household-consumption-aggregates-and-characteristics" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="household-consumption-aggregates-and-characteristics"><span class="header-section-number">4.1</span> Household consumption aggregates and characteristics</h3>
<p>Initial necessary variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>consumption_aggregates <span class="ot">&lt;-</span> ca <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rural =</span> <span class="fu">ifelse</span>(urb_rur <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>),  <span class="co"># Create rural indicator</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">yhh =</span> totc,              <span class="co"># Total household expenditure</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">wgt_adj =</span> pweight) <span class="sc">%&gt;%</span>        <span class="co"># Make a copy of the weight variable </span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(hhid, rural, hhsize,hhsize_R, marz, aepc, yhh, wgt_adj, weight, </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>         Foodpovln2022, Lpovln2022, Upovln2022, Avpovln2022, </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>         poor_Foodpovln2022, poor_Lpovln2022, poor_Upovln2022, </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>         poor_Avpovln2022, decile )  <span class="co"># Keep only necessary columns</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="demographic-characteristics-education-labor-force" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="demographic-characteristics-education-labor-force"><span class="header-section-number">4.2</span> Demographic characteristics, education, Labor Force</h3>
<p>Here the original code calls for Zone data, which is not present in our dataset, due to the different administrative structure of Armenia. However, we use <code>hh_01_code</code> (settlement) for this purpose.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zone data</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>zone_data <span class="ot">&lt;-</span> hh <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(interview__key, hh_01_code, hh_02, hh_03, NAM_1) <span class="sc">%&gt;%</span> </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">hhid =</span> interview__key, <span class="co"># Household id</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">zone =</span> hh_01_code,     <span class="co"># Settlement</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">marz =</span> hh_02,          <span class="co"># Marz</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">NAM_1 =</span> NAM_1,          <span class="co"># Marz name</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">urb_rur =</span> hh_03        <span class="co"># Urban / rural</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Demographic data, merge with zone data Note that ed_03 (educy) below is not years of education, but education level (primary, general, secondary, etc.) However, it is ordered in a way that higher levels imply more years of education. We perform several steps within the first pipe call.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">hhid =</span> interview__key) <span class="sc">%&gt;%</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(zone_data, <span class="fu">join_by</span>( hhid <span class="sc">==</span> hhid))  <span class="sc">%&gt;%</span>  </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="co"># Demographic characteristics</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">pid =</span> <span class="fu">paste0</span>(interview__key, <span class="st">"-"</span>, </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">str_pad</span>(mem_001__id, <span class="dv">2</span>, <span class="at">pad =</span> <span class="st">"0"</span>)), <span class="co"># Unique person id</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">gender =</span> mem_02,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">age =</span> mem_05,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">head =</span> <span class="fu">ifelse</span>(mem_03 <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Education level</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">educy =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(ed_03) <span class="sc">|</span> ed_03 <span class="sc">==</span> <span class="dv">8</span>, <span class="dv">0</span>, ed_03),</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Labor Force Status</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">lstatus =</span> <span class="fu">case_when</span>(</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>           <span class="co"># 1. Employed</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>           est_03 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> est_04 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> est_05 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> est_06 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> est_08 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span>L,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>           <span class="co"># 2. Unemployed (available, and searching)</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>           est_10 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">2</span>L,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>           <span class="co"># 3. Inactive (available, not searching)</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>           est_10 <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">3</span>L,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>           <span class="co"># Out of the labor force</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">.default =</span> <span class="dv">4</span>L <span class="co"># Default to OLF</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>         ),</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">employed =</span> (lstatus <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Salaried status (1. paid employee; 2 self-employed)</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">salaried =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(emp_11a), <span class="dv">1</span>L, </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">ifelse</span>(<span class="fu">is.na</span>(emp_11a) <span class="sc">&amp;</span> employed <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="dv">0</span>L, <span class="cn">NA_integer_</span>))</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">rel =</span> mem_03) <span class="co"># %&gt;% </span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select(hhid, pid, gender, age, head, rel, zone, marz, urb_rur, educy,</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">#        lstatus, employed, salaried, )  </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Later, when we conduct the reweighting of the dataset, we need to summarise into three levels of education.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calif =</span> <span class="fu">case_when</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    educy <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> educy <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"None - General"</span>,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    educy <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> educy <span class="sc">&lt;=</span> <span class="dv">7</span> <span class="sc">~</span> <span class="st">"Secondary - Vocational"</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    educy <span class="sc">&gt;</span> <span class="dv">7</span> <span class="sc">&amp;</span> educy <span class="sc">&lt;=</span> <span class="dv">11</span> <span class="sc">~</span> <span class="st">"Higher +"</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span>  <span class="co"># This handles any values outside the specified ranges</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># View the first few rows to confirm the recoding</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pp_microsim[,<span class="fu">c</span>(<span class="st">"calif"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 1
  calif                 
  &lt;chr&gt;                 
1 Secondary - Vocational
2 None - General        
3 Secondary - Vocational
4 Secondary - Vocational
5 Secondary - Vocational
6 Secondary - Vocational</code></pre>
</div>
</div>
<p>Count the number of employed persons by household.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">employed =</span> (lstatus <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hhid) <span class="sc">%&gt;%</span> </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">employed_hh =</span> <span class="fu">sum</span>(employed, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span>  <span class="co"># Count within each household </span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here the original Stata code calculates income variables and aggregates them by household. We skip that because the dataset “ic” already has these elements calculated by the WB poverty team. We’ll add them later.</p>
<p><strong>Primary and Secondary Job income</strong></p>
<ul>
<li><strong>emp_11</strong> 11.How much was %rostertitle%’s payment for wages/salary/income for last month?</li>
<li><strong>emp_12</strong> 12.What period of time was the wage/income for?</li>
<li><strong>emp_25</strong> 25.How much was %rostertitle%’s payment for wages/salary/income for last month?</li>
<li><strong>emp_26</strong> 26.What period of time was the wage/income for?</li>
</ul>
<p>Bonus, In-Kind, and food from job was not asked in Armenia, If it were, you should add a mutate() statement like the ones below for each subcategory.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Labor income primary job</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">annual_labor_income_primary =</span> <span class="fu">case_when</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    emp_12 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> emp_11 <span class="sc">*</span> <span class="dv">365</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    emp_12 <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> (emp_11<span class="sc">/</span><span class="dv">7</span>) <span class="sc">*</span> <span class="dv">365</span>,  <span class="co"># Assuming weekly rate </span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    emp_12 <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> (emp_11<span class="sc">/</span><span class="dv">14</span>) <span class="sc">*</span> <span class="dv">365</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    emp_12 <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> emp_11 <span class="sc">*</span> <span class="dv">12</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    emp_12 <span class="sc">==</span> <span class="dv">5</span> <span class="sc">~</span> emp_11 <span class="sc">*</span> <span class="dv">2</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    emp_12 <span class="sc">==</span> <span class="dv">6</span> <span class="sc">~</span> emp_11,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    emp_12 <span class="sc">==</span> <span class="dv">7</span> <span class="sc">~</span> <span class="cn">NA</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  ))   <span class="sc">%&gt;%</span> </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Labor income secondary job</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">annual_labor_income_secondary =</span> <span class="fu">case_when</span>(</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    emp_26 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> emp_25 <span class="sc">*</span> <span class="dv">365</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    emp_26 <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> (emp_25<span class="sc">/</span><span class="dv">7</span>) <span class="sc">*</span> <span class="dv">365</span>,  <span class="co"># Assuming weekly rate </span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    emp_26 <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> (emp_25<span class="sc">/</span><span class="dv">14</span>) <span class="sc">*</span> <span class="dv">365</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    emp_26 <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> emp_25 <span class="sc">*</span> <span class="dv">12</span>,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    emp_26 <span class="sc">==</span> <span class="dv">5</span> <span class="sc">~</span> emp_25 <span class="sc">*</span> <span class="dv">2</span>,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    emp_26 <span class="sc">==</span> <span class="dv">6</span> <span class="sc">~</span> emp_25,</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    emp_26 <span class="sc">==</span> <span class="dv">7</span> <span class="sc">~</span> <span class="cn">NA</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Annual labor total in thousands of dram</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">annual_labor_total =</span> (<span class="fu">coalesce</span>(annual_labor_income_primary, <span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coalesce</span>(annual_labor_income_secondary, <span class="dv">0</span>))<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Restore annual_labor_total to NA if both NA</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span> </span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">annual_labor_total =</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>           <span class="fu">if_else</span>(</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>             <span class="fu">is.na</span>(annual_labor_income_primary)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>             <span class="sc">&amp;</span> <span class="fu">is.na</span>(annual_labor_income_secondary),</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>         <span class="cn">NA</span>, </span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>         annual_labor_total))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>26.23% employed with no labor income reported!!! We calculate this way:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>total_employed_no_income <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(employed <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(annual_labor_total)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>total_employed <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(employed <span class="sc">==</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>percent_employed_no_income <span class="ot">&lt;-</span> (total_employed_no_income <span class="sc">/</span> total_employed) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(percent_employed_no_income)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 28.57496</code></pre>
</div>
</div>
<p>Let’s flag outliers now</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim  <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for employed and positive income </span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#filter(employed == TRUE &amp; annual_labor_total &gt; 0) %&gt;% </span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">sd</span>(annual_labor_total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),   <span class="co"># Calculate standard deviation</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">d =</span> annual_labor_total <span class="sc">/</span> sd,                </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combined outlier condition</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier =</span> (d <span class="sc">&gt;</span> <span class="dv">5</span>) <span class="sc">|</span> (employed <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> annual_labor_total <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark potential missings</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">missings =</span> <span class="fu">if_else</span>(employed <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="fu">is.na</span>(annual_labor_total), <span class="cn">NA</span>)           </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Economic sector</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">emp_04 =</span> <span class="fu">as.integer</span>(emp_04)) <span class="sc">%&gt;%</span> </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(sectors, <span class="fu">join_by</span>(<span class="st">"emp_04"</span> <span class="sc">==</span> <span class="st">"economic_activity_code"</span>) ) <span class="sc">%&gt;%</span> </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">sector =</span> ea_shortcode)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Impute sector for those with missing employed by hh head sector.</p>
<p>Step 1: Impute sector for missing employed by the sector of any other hh member.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hhid) <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a temporary variable 'other_sector' which captures the sector of any employed individual in the household</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">other_sector =</span> <span class="fu">if_else</span>(employed <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(sector), sector, <span class="cn">NA_real_</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use 'fill' to propagate 'other_sector' values within the household</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(other_sector, <span class="at">.direction =</span> <span class="st">"downup"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Impute missing 'sector' values based on the 'other_sector'</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">sector =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(sector) <span class="sc">&amp;</span> employed <span class="sc">==</span> <span class="cn">TRUE</span>, other_sector, sector)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop the temporary 'other_sector' variable</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>other_sector) <span class="sc">%&gt;%</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Step 2: Assign a specific value for missing sectors for those employed with no one else in the hh to assign value. We select services as it’s the heaviest sector in the dataset (we do it like this, instead of say, matching, because it’s only 2 observations).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sector =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(sector) <span class="sc">&amp;</span> employed <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="dv">3</span>, sector))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Step 4: Label the sector variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sector_name =</span> <span class="fu">factor</span>(sector, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Agriculture"</span>, </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Manufacturing"</span>, <span class="st">"Services"</span>))</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>         )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Step 5: No sector for OLF and clonevar industry=sector (this from original Stata code).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lstatus =</span> <span class="fu">as.numeric</span>(lstatus),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">sector =</span> <span class="fu">if_else</span>(lstatus <span class="sc">==</span> <span class="dv">4</span>, <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="fu">as.character</span>(sector)),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">industry =</span> <span class="fu">as.factor</span>(sector)) <span class="sc">%&gt;%</span> </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">sector_w =</span> sector) <span class="co"># We need this for reweighting and not messing up </span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># and not mess up the regression below.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-regression" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="the-regression"><span class="header-section-number">4.3</span> The regression</h3>
<p>Prepare the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">educy2 =</span> educy<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">age2 =</span> age<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">male =</span> <span class="fu">case_when</span>(</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>      gender <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>      gender <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">lnlab =</span> <span class="fu">log</span>(annual_labor_total),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">simuli =</span> <span class="cn">NA_real_</span> <span class="co"># Initialize simuli</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Filter the data for regression conditions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>regression_data <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(employed <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> outlier <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> missings <span class="sc">==</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Regression model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(lnlab <span class="sc">~</span> age <span class="sc">+</span> gender <span class="sc">+</span> educy <span class="sc">+</span> age2 <span class="sc">+</span> marz <span class="sc">+</span> sector, </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> regression_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Predict for specific conditions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">condition =</span> (lstatus <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> (outlier <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">|</span> missings <span class="sc">==</span> <span class="cn">TRUE</span>))</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Applying predictions.</p>
<p>Note: The ‘predict’ function in R does not directly support conditions within the function call, so we handle this by filtering or subsetting the data as needed.</p>
<p>temp2 equivalent - Note: ‘type = “response”’ might be needed depending on model type.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>pp_microsim<span class="sc">$</span>simuli[pp_microsim<span class="sc">$</span>condition<span class="sc">==</span><span class="cn">TRUE</span>] <span class="ot">&lt;-</span> <span class="fu">exp</span>(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(model, pp_microsim[pp_microsim<span class="sc">$</span>condition<span class="sc">==</span><span class="cn">TRUE</span>, ], <span class="at">type =</span> <span class="st">"response"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Handling negative values in ‘simuli’.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">simuli =</span> <span class="fu">if_else</span>(simuli <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="dv">0</span>, simuli)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There were 8 observations that met the criteria:</p>
<p>We will replace <code>annual_labor_total</code> with this value for those observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">annual_labor_total =</span> <span class="fu">if_else</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    employed <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> (outlier <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">|</span> missings <span class="sc">==</span> <span class="cn">TRUE</span>),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    simuli, annual_labor_total))</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co"># And get monthly incomes for everyone</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span> </span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">monthly_labor_income =</span> annual_labor_total <span class="sc">/</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merging datasets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(consumption_aggregates, <span class="at">by =</span> <span class="st">"hhid"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="total-income-and-shares" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="total-income-and-shares"><span class="header-section-number">4.4</span> Total income and shares</h3>
<p>Total labor income at HH level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hhid) <span class="sc">%&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lab_hh =</span> <span class="fu">sum</span>(annual_labor_total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Monthly incomes come from the <code>ic</code> data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>incomes <span class="ot">&lt;-</span> ic <span class="sc">%&gt;%</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(interview__key, inc1, inc2, inc3, inc4, inc5, inc6, inc7, inc8)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Total income at HH level (the commented out portion was a less efficient way of accomplishing the same result of coalescing NAs to 0 so that the sum can be performed). Note that here we need to use the magittr pipe <code>%&gt;%</code> instead of the newer Native Pipe <code>%&gt;%</code> , because we need to reference the correct scope with the dot <code>.</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(incomes, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"hhid"</span> <span class="ot">=</span> <span class="st">"interview__key"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(inc5<span class="sc">:</span>inc8, <span class="sc">~</span><span class="fu">replace_na</span>(., <span class="dv">0</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nli_hh =</span> <span class="dv">12</span> <span class="sc">*</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., inc5<span class="sc">:</span>inc8), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">income_hh =</span> lab_hh <span class="sc">+</span> nli_hh)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co"># pp_microsim &lt;- pp_microsim %&gt;%</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   left_join(incomes, join_by(hhid == interview__key)) %&gt;% </span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(nli_hh = (  coalesce(inc5) + </span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                      coalesce(inc6) +</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">#                      coalesce(inc7) +</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">#                      coalesce(inc8)) * 12) %&gt;% </span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(income_hh = lab_hh + nli_hh)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Calculating shares:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">s_lab =</span> lab_hh <span class="sc">/</span> income_hh,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">s_nli =</span> nli_hh <span class="sc">/</span> income_hh,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lny =</span> <span class="fu">log</span>(income_hh),</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lnc =</span> <span class="fu">log</span>(yhh), <span class="co"># comes from consumption aggregates</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mpc =</span> yhh <span class="sc">/</span> income_hh</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Shares of labor and non-labor income, and additional calculations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">share =</span> <span class="fu">if_else</span>(employed <span class="sc">==</span> <span class="cn">TRUE</span>, annual_labor_total <span class="sc">/</span> lab_hh, <span class="cn">NA_real_</span>),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylb =</span> yhh <span class="sc">*</span> s_lab,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">ynl =</span> yhh <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> s_lab),</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylbi =</span> <span class="fu">if_else</span>(employed <span class="sc">==</span> <span class="cn">TRUE</span>, ylb <span class="sc">*</span> share, <span class="cn">NA_real_</span>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Final subset of data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(hhid, pid, industry, yhh, ylb, ynl, ylbi, salaried,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>         rural, hhsize,hhsize_R, marz.x, aepc, yhh, wgt_adj, weight, </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>         Foodpovln2022, Lpovln2022, Upovln2022, Avpovln2022, </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>         poor_Foodpovln2022, poor_Lpovln2022, poor_Upovln2022, </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>         poor_Avpovln2022, decile, zone, urb_rur,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>         gender, age, head, rel, zone, educy, calif, sector, sector_name,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>         annual_labor_total,annual_labor_income_primary,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>         annual_labor_income_secondary,monthly_labor_income,</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>         lstatus, sector_w, NAM_1 ) <span class="sc">%&gt;%</span> </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">marz =</span> marz.x)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Exporting to Stata (might be necessary for reweigthing with wentropy)</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co"># write_dta(pp_microsim, path = "outputs/pp_microsim.dta", version = 10)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="un-population-projections" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="un-population-projections"><span class="header-section-number">5</span> UN Population Projections</h2>
<p>Now we are ready to move to our demographic projections and macroeconomic model information.</p>
<p>First, filtering based on country (our <code>iso</code> variable).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>population_projections <span class="ot">&lt;-</span> population_projections  <span class="sc">%&gt;%</span>  </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country <span class="sc">==</span> iso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Collapsing data by summing up variables starting with “yf” and “ym” and reshaping data to long format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>population_projections <span class="ot">&lt;-</span> population_projections <span class="sc">%&gt;%</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Variant, country, cohort) <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="fu">c</span>(<span class="st">"yf"</span>, <span class="st">"ym"</span>)), sum)) <span class="sc">%&gt;%</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Variant', 'country'. You can override
using the `.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>population_projections <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(population_projections,</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="fu">c</span>(<span class="st">"yf"</span>, <span class="st">"ym"</span>)),</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">".value"</span>, <span class="st">"year"</span>),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">names_pattern =</span> <span class="st">"(yf|ym)(.*)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creating new variable <code>total_population</code> as the sum of <code>yf</code> and <code>ym</code>. Dropping <code>country</code> variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>population_projections <span class="ot">&lt;-</span> population_projections <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_population =</span> yf <span class="sc">+</span> ym) <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>( <span class="sc">-</span>country) <span class="sc">%&gt;%</span> </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(year))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Summarizing the year to find the range.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>minyear <span class="ot">&lt;-</span> surveyyear <span class="co"># Make sure `surveyyear` is correctly defined</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>maxyear <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">as.numeric</span>(population_projections<span class="sc">$</span>year))</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the year range as a check</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Min Year:"</span>, minyear, <span class="st">"- Max Year:"</span>, maxyear))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Min Year: 2022 - Max Year: 2100"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># With minyear and maxyear defined above</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a list to store growth data</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>pop_growth <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over variants</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>variants <span class="ot">&lt;-</span> <span class="fu">unique</span>(population_projections<span class="sc">$</span>Variant)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (variant <span class="cf">in</span> variants) {</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> minyear<span class="sc">:</span>maxyear) {</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate population for year t</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    pop_t <span class="ot">&lt;-</span> population_projections <span class="sc">%&gt;%</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(year <span class="sc">==</span> t, Variant <span class="sc">==</span> variant) <span class="sc">%&gt;%</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">sum_pop =</span> <span class="fu">sum</span>(total_population)) <span class="sc">%&gt;%</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(sum_pop)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate population for base year</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    pop_base <span class="ot">&lt;-</span> population_projections <span class="sc">%&gt;%</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(year <span class="sc">==</span> minyear, Variant <span class="sc">==</span> variant) <span class="sc">%&gt;%</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">sum_pop =</span> <span class="fu">sum</span>(total_population)) <span class="sc">%&gt;%</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(sum_pop)</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate growth rate and store in list with dynamic naming</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>    growth_rate <span class="ot">&lt;-</span> pop_t <span class="sc">/</span> pop_base</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    pop_growth[[<span class="fu">paste0</span>(t, <span class="st">"_"</span>, variant)]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">growth_rate =</span> growth_rate, <span class="at">pop_t =</span> pop_t</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert list to dataframe</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>pop_growth <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="fu">names</span>(pop_growth), <span class="cf">function</span>(x) {</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract year and variant from the name</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>  parts <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">strsplit</span>(x, <span class="st">"_"</span>))</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>  year <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(parts[<span class="dv">1</span>])</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>  variant <span class="ot">&lt;-</span> parts[<span class="dv">2</span>]</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a tibble for each entry</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">year =</span> year, </span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>         <span class="at">variant =</span> variant, </span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>         <span class="at">total_population =</span> pop_growth[[x]]<span class="sc">$</span>pop_t,</span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">pop_growth_rate =</span> pop_growth[[x]]<span class="sc">$</span>growth_rate)</span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrange the dataframe for better readability</span></span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>pop_growth <span class="ot">&lt;-</span> <span class="fu">arrange</span>(pop_growth, variant, year)</span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the dataframe</span></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>pop_growth[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">09</span>),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 4
   year variant            total_population pop_growth_rate
  &lt;int&gt; &lt;chr&gt;                         &lt;dbl&gt;           &lt;dbl&gt;
1  2022 Constant-fertility            2780.           1    
2  2023 Constant-fertility            2778.           0.999
3  2024 Constant-fertility            2778.           0.999
4  2025 Constant-fertility            2776.           0.998
5  2026 Constant-fertility            2774.           0.998
6  2027 Constant-fertility            2770.           0.996
7  2028 Constant-fertility            2766.           0.995
8  2029 Constant-fertility            2761.           0.993
9  2030 Constant-fertility            2755.           0.991</code></pre>
</div>
</div>
<p>We load elasticities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>elasticities <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.82</span>, <span class="fl">0.9</span>, <span class="fl">0.79</span>) <span class="co"># Agr, Manuf, Services</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>yearsto <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2030</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="macro-scenarios" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="macro-scenarios"><span class="header-section-number">6</span> Macro Scenarios</h2>
<p>The following code accomplishes the following:</p>
<ul>
<li>Import data from Excel sheets corresponding to each scenario and combine them into one data frame.</li>
<li>Rename columns, create a ‘scenid’ to identify scenarios, and merge with population projections.</li>
<li>Calculate real wages and consumption per capita.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Macro Scenario File imported in "Datasets" section (scenario_file) </span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>sheets <span class="ot">&lt;-</span> <span class="fu">excel_sheets</span>(scenario_file)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the names of the scenarios and the variants </span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>scenarios <span class="ot">&lt;-</span> sheets[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)] <span class="co"># modify list with the tab numbers or names with scenarios</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list to store data frames for each scenario</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>scen_data_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Import data for each scenario and store it in the list</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(scenarios)) {</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  sheet_data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(scenario_file, </span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sheet =</span> scenarios[i], </span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>                           <span class="at">range =</span> <span class="st">"B3:AT31"</span>,</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>                           <span class="at">col_names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  sheet_data<span class="sc">$</span>scenario_id <span class="ot">&lt;-</span> scenarios[i]</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(sheet_data) <span class="ot">&lt;-</span> scenario_varlist<span class="sc">$</span>var_short_name</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  scen_data_list[[i]] <span class="ot">&lt;-</span> sheet_data</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
New names:
• `` -&gt; `...1`
• `` -&gt; `...2`
• `` -&gt; `...3`
• `` -&gt; `...4`
• `` -&gt; `...5`
• `` -&gt; `...6`
• `` -&gt; `...7`
• `` -&gt; `...8`
• `` -&gt; `...9`
• `` -&gt; `...10`
• `` -&gt; `...11`
• `` -&gt; `...12`
• `` -&gt; `...13`
• `` -&gt; `...14`
• `` -&gt; `...15`
• `` -&gt; `...16`
• `` -&gt; `...17`
• `` -&gt; `...18`
• `` -&gt; `...19`
• `` -&gt; `...20`
• `` -&gt; `...21`
• `` -&gt; `...22`
• `` -&gt; `...23`
• `` -&gt; `...24`
• `` -&gt; `...25`
• `` -&gt; `...26`
• `` -&gt; `...27`
• `` -&gt; `...28`
• `` -&gt; `...29`
• `` -&gt; `...30`
• `` -&gt; `...31`
• `` -&gt; `...32`
• `` -&gt; `...33`
• `` -&gt; `...34`
• `` -&gt; `...35`
• `` -&gt; `...36`
• `` -&gt; `...37`
• `` -&gt; `...38`
• `` -&gt; `...39`
• `` -&gt; `...40`
• `` -&gt; `...41`
• `` -&gt; `...42`
• `` -&gt; `...43`
• `` -&gt; `...44`
• `` -&gt; `...45`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all data frames into one</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>combined_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(scen_data_list)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename population_m from the data set because we will use </span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co"># UN pop projections from the other data set.</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>combined_data <span class="ot">&lt;-</span> combined_data <span class="sc">%&gt;%</span> </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">population_m_macrodata =</span> population_m)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate real wages</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>combined_data <span class="ot">&lt;-</span> combined_data <span class="sc">%&gt;%</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rwage_agr_m_amd =</span> wage_agr_m_amd <span class="sc">/</span> cpi,</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">rwage_man_m_amd =</span> wage_man_m_amd <span class="sc">/</span> cpi,</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">rwage_ser_m_amd =</span> wage_ser_m_amd <span class="sc">/</span> cpi)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>pop_data <span class="ot">&lt;-</span> population_projections <span class="sc">%&gt;%</span> </span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Variant, year) <span class="sc">%&gt;%</span> </span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">female =</span> <span class="fu">sum</span>(yf),</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">male =</span> <span class="fu">sum</span>(ym),</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">total_population =</span> <span class="fu">sum</span>(total_population) ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Variant'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter population data to macro model years</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>pop_data <span class="ot">&lt;-</span> pop_data <span class="sc">%&gt;%</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&lt;=</span> <span class="fu">max</span>(combined_data<span class="sc">$</span>year),</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>         Variant <span class="sc">==</span> variants[<span class="dv">7</span>])</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the combined data with population projections</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>macro_data <span class="ot">&lt;-</span> combined_data <span class="sc">%&gt;%</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(pop_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>))</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate consumption per capita and other totals</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>macro_data <span class="ot">&lt;-</span> macro_data <span class="sc">%&gt;%</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">consumption_pc =</span> consumption_b_amd <span class="sc">/</span> (total_population),</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_employment =</span> lab_agr_1000p <span class="sc">+</span> lab_man_1000p <span class="sc">+</span> lab_ser_1000p,</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">employment_rate =</span> working_age_pop_m <span class="sc">/</span> total_population</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to add growth rate columns directly in the dataframe</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>calculate_growth <span class="ot">&lt;-</span> <span class="cf">function</span>(data, value_column) {</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>  growth_col_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(value_column, <span class="st">"_growth"</span>) <span class="co"># dynamic name for growth column</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Variant, scenario_id) <span class="sc">%&gt;%</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">base_value =</span> <span class="fu">first</span>(<span class="sc">!!</span><span class="fu">sym</span>(value_column)),</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!!</span><span class="fu">sym</span>(growth_col_name) <span class="sc">:</span><span class="er">=</span> <span class="sc">!!</span><span class="fu">sym</span>(value_column) <span class="sc">/</span> base_value</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>base_value) <span class="sc">%&gt;%</span> <span class="co"># optionally remove base_value column if not needed</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns to calculate growth for</span></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>value_columns <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gdp_b_amd"</span>,           <span class="co"># GDP</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"consumption_b_amd"</span>,   <span class="co"># Consumption</span></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"consumption_pc"</span>,      <span class="co"># Consumption PC</span></span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">"remittances_b_amd"</span>,   <span class="co"># Remittances</span></span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"total_employment"</span>,    <span class="co"># Employment</span></span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">"employment_rate"</span>,     <span class="co"># Employment rate</span></span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">"working_age_pop_m"</span>,   <span class="co"># Working age population</span></span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">"va_agr_b_amd"</span>,        <span class="co"># Value added agriculture</span></span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"va_man_b_amd"</span>,        <span class="co"># Value added manufacturing</span></span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">"va_ser_b_amd"</span>,        <span class="co"># Value added services</span></span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wage_agr_m_amd"</span>,      <span class="co"># Nominal wage agriculture</span></span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wage_man_m_amd"</span>,      <span class="co"># Nominal wage manufacturing</span></span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wage_ser_m_amd"</span>,      <span class="co"># Nominal wage services</span></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">"rwage_agr_m_amd"</span>,     <span class="co"># Real wage agriculture</span></span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"rwage_man_m_amd"</span>,     <span class="co"># Real wage manufacturing</span></span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"rwage_ser_m_amd"</span>      <span class="co"># Real wage services</span></span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying the growth calculation to the macro_data for each column</span></span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (col <span class="cf">in</span> value_columns) {</span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true" tabindex="-1"></a>  macro_data <span class="ot">&lt;-</span> <span class="fu">calculate_growth</span>(macro_data, col)</span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Now `macro_data` will have growth rate columns for each of the variables listed</span></span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true" tabindex="-1"></a><span class="co"># We rearrange the dataset for clarity</span></span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true" tabindex="-1"></a>macro_data <span class="ot">&lt;-</span> macro_data <span class="sc">%&gt;%</span> </span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(scenario_id, Variant, <span class="at">.before =</span> year) <span class="sc">%&gt;%</span> </span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(scenario_id, Variant, year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="reweighting-of-the-dataset" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="reweighting-of-the-dataset"><span class="header-section-number">7</span> Reweighting of the dataset</h2>
<section id="aggregation-of-population-data" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="aggregation-of-population-data"><span class="header-section-number">7.1</span> Aggregation of population data</h3>
<p>This is based on a custom command to reweight the survey according to macroeconomic data for every possible combination of variant, year, and country. In the macro data we know they only used the “medium” variant and we only need to reweight for a specific year (2030) for Armenia (ARM), so we will conduct the reweighting directly with these parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>population_projections <span class="ot">&lt;-</span> population_projections <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(Variant == "Medium") %&gt;%</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recoding cohorts into ordered factors</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">cohort_short =</span> <span class="fu">factor</span>(<span class="fu">case_when</span>(</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"P0004"</span>, <span class="st">"P0509"</span>,<span class="st">"P1014"</span>,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"P1519"</span>,<span class="st">"P2024"</span>, <span class="st">"P2529"</span>) <span class="sc">~</span> <span class="st">"P0029"</span>,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"P3034"</span>, <span class="st">"P3539"</span>) <span class="sc">~</span> <span class="st">"P3039"</span>,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"P4044"</span>, <span class="st">"P4549"</span>) <span class="sc">~</span> <span class="st">"P4049"</span>,</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"P5054"</span>, <span class="st">"P5559"</span>) <span class="sc">~</span> <span class="st">"P5059"</span>,</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"P6064"</span>, <span class="st">"P6569"</span>,<span class="st">"P7074"</span>, <span class="st">"P7579"</span>,</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"P8084"</span>, <span class="st">"P8589"</span>, <span class="st">"P9094"</span>, <span class="st">"P9599"</span>,</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"P100up"</span>) <span class="sc">~</span> <span class="st">"P60up"</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  ), <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"P0029"</span>, <span class="st">"P3039"</span>,</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">"P4049"</span>, <span class="st">"P5059"</span>, <span class="st">"P60up"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate(cohort = factor(case_when(</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cohort %in% c("P0004", "P0509") ~ "P0009",</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cohort %in% c("P1014", "P1519") ~ "P1019",</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cohort %in% c("P2024", "P2529") ~ "P2029",</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   cohort %in% c("P3034", "P3539") ~ "P3039",</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   cohort %in% c("P4044", "P4549") ~ "P4049",</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   cohort %in% c("P5054", "P5559") ~ "P5059",</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   cohort %in% c("P6064", "P6569") ~ "P6069",</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   cohort %in% c("P7074", "P7579", "P8084", "P8589", "P9094", "P9599", "P100up") ~ "P70up"</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ), levels = c("P0009", "P1019", "P2029", "P3039", "P4049", "P5059", "P6069", "P70up"))) %&gt;%</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert factor 'cohort' to numeric codes</span></span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cohort_code =</span> <span class="fu">as.integer</span>(cohort_short))</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Checking the resulting dataset</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pop_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 60 × 5
   Variant  year female  male total_population
   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;            &lt;dbl&gt;
 1 Medium   1991  1867. 1750.            3618.
 2 Medium   1992  1850. 1724.            3575.
 3 Medium   1993  1799. 1658.            3457.
 4 Medium   1994  1763. 1610.            3374.
 5 Medium   1995  1741. 1581.            3323.
 6 Medium   1996  1731. 1568.            3299.
 7 Medium   1997  1719. 1552.            3271.
 8 Medium   1998  1705. 1535.            3241.
 9 Medium   1999  1689. 1517.            3206.
10 Medium   2000  1672. 1496.            3169.
# ℹ 50 more rows</code></pre>
</div>
</div>
<p>Let’s now create cohorts in our <code>pp_microsim</code> data to match our population projection data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert 'age' into 'cohort' factor with levels ordered as specified</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">cohort =</span> <span class="fu">factor</span>(<span class="fu">case_when</span>(</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">0</span>  <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">29</span> <span class="sc">~</span> <span class="st">"P0029"</span>,</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">30</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">39</span> <span class="sc">~</span> <span class="st">"P3039"</span>,</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">40</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">49</span> <span class="sc">~</span> <span class="st">"P4049"</span>,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">50</span> <span class="sc">&amp;</span> age <span class="sc">&lt;=</span> <span class="dv">59</span> <span class="sc">~</span> <span class="st">"P5059"</span>,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    age <span class="sc">&gt;=</span> <span class="dv">60</span>  <span class="sc">~</span> <span class="st">"P60up"</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  ), <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"P0029"</span>, <span class="st">"P3039"</span>, <span class="st">"P4049"</span>, <span class="st">"P5059"</span>, <span class="st">"P60up"</span>)))</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate(cohort = factor(case_when(</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   age &gt;= 0 &amp; age &lt;= 9 ~ "P0009",</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   age &gt;= 10 &amp; age &lt;= 19 ~ "P1019",</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   age &gt;= 20 &amp; age &lt;= 29 ~ "P2029",</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   age &gt;= 30 &amp; age &lt;= 39 ~ "P3039",</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   age &gt;= 40 &amp; age &lt;= 49 ~ "P4049",</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   age &gt;= 50 &amp; age &lt;= 59 ~ "P5059",</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   age &gt;= 60 &amp; age &lt;= 69 ~ "P6069",</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   age &gt;= 70 ~ "P70up"</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ), levels = c("P0009", "P1019", "P2029", "P3039", "P4049", "P5059", "P6069", "P70up")))</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the 'cohort' and 'gender' factor to numeric codes</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cohort_code =</span> <span class="fu">as.integer</span>(cohort)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gender_code =</span> <span class="fu">as.integer</span>(gender))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also need demographic targets for 2030</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure pop_targets_2030 is correctly prepared</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>pop_targets_2030 <span class="ot">&lt;-</span> population_projections  <span class="sc">%&gt;%</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2030</span>, Variant <span class="sc">==</span> variants[<span class="dv">7</span>])  <span class="sc">%&gt;%</span> </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cohort_code, cohort_short) <span class="sc">%&gt;%</span> </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">female =</span> <span class="fu">sum</span>(yf),</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">male   =</span> <span class="fu">sum</span>(ym), </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">total =</span> <span class="fu">sum</span>(total_population),</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'cohort_code'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>pop_total <span class="ot">&lt;-</span> <span class="fu">sum</span>(pop_targets_2030<span class="sc">$</span>total)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>pop_targets_2030 <span class="ot">&lt;-</span> pop_targets_2030 <span class="sc">%&gt;%</span> </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct_total =</span> total <span class="sc">/</span> pop_total)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And economic targets from our macroeconomic scenario data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>economic_targets_2030 <span class="ot">&lt;-</span> macro_data <span class="sc">%&gt;%</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2030</span>, Variant <span class="sc">==</span> <span class="st">"Medium"</span>, scenario_id <span class="sc">==</span> <span class="st">"baseline"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">target_lab_agr =</span> <span class="fu">sum</span>(lab_agr_1000p <span class="sc">*</span> <span class="dv">1000</span>),</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">target_lab_man =</span> <span class="fu">sum</span>(lab_man_1000p <span class="sc">*</span> <span class="dv">1000</span>),</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">target_lab_ser =</span> <span class="fu">sum</span>(lab_ser_1000p <span class="sc">*</span> <span class="dv">1000</span>)</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For a better representation of the labor market, we will take into account the combination between labor status and economic sector of the employed and adjust that combination according to the macrodata so that we can accurately model changes in total employment, sector distribution of the employed and overall population changes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lmarket =</span> <span class="fu">case_when</span>(</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    lstatus <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> sector_w  <span class="sc">==</span> <span class="dv">1</span>  <span class="sc">~</span> <span class="dv">1</span>,   <span class="co"># Agriculture</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    lstatus <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> sector_w  <span class="sc">==</span> <span class="dv">2</span>  <span class="sc">~</span> <span class="dv">2</span>,   <span class="co"># Manufactures</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    lstatus <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> sector_w  <span class="sc">==</span> <span class="dv">3</span>  <span class="sc">~</span> <span class="dv">3</span>,   <span class="co"># Services</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    lstatus <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(sector_w) <span class="sc">~</span> <span class="dv">4</span>,   <span class="co"># Unemployed</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    lstatus <span class="sc">==</span> <span class="dv">3</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(sector_w) <span class="sc">~</span> <span class="dv">4</span>,   <span class="co"># Unemployed</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    lstatus <span class="sc">==</span> <span class="dv">4</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(sector_w) <span class="sc">~</span> <span class="dv">5</span>,   <span class="co"># OLF</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we check the values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  pp_microsim <span class="sc">%&gt;%</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lmarket) <span class="sc">%&gt;%</span> </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_pp =</span> <span class="fu">sum</span>(weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>(), </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"clipboard"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that the differences between the totals of the survey and the macro file for the base year are very much different. We’ll adjust the survey only with relative growth instead of total numbers so that labor income doesn’t change completely.</p>
</section>
<section id="reweigting" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="reweigting"><span class="header-section-number">7.2</span> Reweigting</h3>
<p>We use anesrake to calculate targets from known future proportions of sex, age, economic sector. We first create a target list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Target for each variable</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>gender_code <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(pop_targets_2030<span class="sc">$</span>male)   <span class="sc">/</span> </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">sum</span>(pop_targets_2030<span class="sc">$</span>male)<span class="sc">+</span> <span class="fu">sum</span>(pop_targets_2030<span class="sc">$</span>female)), </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(pop_targets_2030<span class="sc">$</span>female) <span class="sc">/</span> </span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">sum</span>(pop_targets_2030<span class="sc">$</span>male)<span class="sc">+</span> <span class="fu">sum</span>(pop_targets_2030<span class="sc">$</span>female)))</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>cohort_code <span class="ot">&lt;-</span> pop_targets_2030<span class="sc">$</span>pct_total</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Four digits are better than two in this case, raking is quite accurate.</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>lmarket <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1341</span>, <span class="fl">0.0494</span>, <span class="fl">0.2611</span>, <span class="fl">0.2472</span>, <span class="fl">0.3082</span>)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Target list</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>targets <span class="ot">&lt;-</span> <span class="fu">list</span>(gender_code</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>                , cohort_code</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>                , lmarket</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(targets) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"gender_code"</span>, </span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"cohort_code"</span>, </span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"lmarket"</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Since this uses base R, we need to turn the data frame into base R object</span></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>rakedata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(pp_microsim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now we perform the reweighting, using the original weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anesrakefinder</span>(targets, rakedata, <span class="at">choosemethod =</span> <span class="st">"total"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>gender_code cohort_code     lmarket 
 0.03626510  0.09677000  0.07212418 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>outsave <span class="ot">&lt;-</span> <span class="fu">anesrake</span>(targets, </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>                    rakedata, </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">caseid =</span> rakedata<span class="sc">$</span>pid, </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#verbose = FALSE,</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">choosemethod =</span> <span class="st">"total"</span>,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="st">"pctlim"</span>,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#cap = 100,</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pctlim =</span> <span class="fl">0.05</span>,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nlim =</span> <span class="dv">3</span>,</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">iterate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">force1 =</span> <span class="cn">TRUE</span>,</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">weightvec =</span> rakedata<span class="sc">$</span>weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Raking...Iteration 1"
[1] "Current iteration changed total weights by 2336.85909302283"
[1] "Raking...Iteration 2"
[1] "Current iteration changed total weights by 196.013077923158"
[1] "Raking...Iteration 3"
[1] "Current iteration changed total weights by 48.9461383276265"
[1] "Raking...Iteration 4"
[1] "Current iteration changed total weights by 15.2825935005305"
[1] "Raking...Iteration 5"
[1] "Current iteration changed total weights by 4.79740637305395"
[1] "Raking...Iteration 6"
[1] "Current iteration changed total weights by 1.50755591186616"
[1] "Raking...Iteration 7"
[1] "Current iteration changed total weights by 0.473847760331075"
[1] "Raking...Iteration 8"
[1] "Current iteration changed total weights by 0.148945583420334"
[1] "Raking...Iteration 9"
[1] "Current iteration changed total weights by 0.0468190426274527"
[1] "Raking...Iteration 10"
[1] "Current iteration changed total weights by 0.0147169948904372"
[1] "Raking...Iteration 11"
[1] "Current iteration changed total weights by 0.00462611317398909"
[1] "Raking...Iteration 12"
[1] "Current iteration changed total weights by 0.00145416443982054"
[1] "Raking...Iteration 13"
[1] "Current iteration changed total weights by 0.00045709959257946"
[1] "Raking...Iteration 14"
[1] "Current iteration changed total weights by 0.000143683917964627"
[1] "Raking...Iteration 15"
[1] "Current iteration changed total weights by 4.51653621963283e-05"
[1] "Raking...Iteration 16"
[1] "Current iteration changed total weights by 1.41972053157718e-05"
[1] "Raking...Iteration 17"
[1] "Current iteration changed total weights by 4.46272523452196e-06"
[1] "Raking...Iteration 18"
[1] "Current iteration changed total weights by 1.40280532930082e-06"
[1] "Raking...Iteration 19"
[1] "Current iteration changed total weights by 4.40955060437842e-07"
[1] "Raking...Iteration 20"
[1] "Current iteration changed total weights by 1.38610069977396e-07"
[1] "Raking...Iteration 21"
[1] "Current iteration changed total weights by 4.35708336493645e-08"
[1] "Raking...Iteration 22"
[1] "Current iteration changed total weights by 1.36949823009713e-08"
[1] "Raking...Iteration 23"
[1] "Current iteration changed total weights by 4.30483908242518e-09"
[1] "Raking...Iteration 24"
[1] "Current iteration changed total weights by 1.35239161536127e-09"
[1] "Raking...Iteration 25"
[1] "Current iteration changed total weights by 4.25884119636954e-10"
[1] "Raking...Iteration 26"
[1] "Current iteration changed total weights by 1.34918465288791e-10"
[1] "Raking...Iteration 27"
[1] "Current iteration changed total weights by 4.08980349586585e-11"
[1] "Raking...Iteration 28"
[1] "Current iteration changed total weights by 1.39531441956109e-11"
[1] "Raking...Iteration 29"
[1] "Current iteration changed total weights by 4.07238132105192e-12"
[1] "Raking...Iteration 30"
[1] "Current iteration changed total weights by 2.60423627107542e-12"
[1] "Raking...Iteration 31"
[1] "Current iteration changed total weights by 2.40631126136037e-12"
[1] "Raking...Iteration 32"
[1] "Current iteration changed total weights by 0"
[1] "Raking...Iteration 33"
[1] "Current iteration changed total weights by 0"
[1] "Raking converged in 33 iterations"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(outsave)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$convergence
[1] "Complete convergence was achieved after 33 iterations"

$base.weights
[1] "Using Base Weights Provided"

$raking.variables
[1] "cohort_code" "lmarket"    

$weight.summary
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.1103  0.6867  0.9272  1.0000  1.2758  3.2390 

$selection.method
[1] "variable selection conducted using _pctlim_ - discrepancies selected using _total_."

$general.design.effect
[1] 1.241567

$gender_code
         Target Old Weights N Old Weights % Wtd N Wtd % Change in %
&lt;NA&gt;  0.4514133            NA            NA    NA    NA          NA
&lt;NA&gt;  0.5485867            NA            NA    NA    NA          NA
Total 1.0000000             0             0     0     0           0
      Resid. Disc. Orig. Disc.
&lt;NA&gt;            NA          NA
&lt;NA&gt;            NA          NA
Total            0           0

$cohort_code
         Target Old Weights N Old Weights % Wtd N Wtd % Change in %
&lt;NA&gt;  0.3638899            NA            NA    NA    NA          NA
&lt;NA&gt;  0.1420277            NA            NA    NA    NA          NA
&lt;NA&gt;  0.1630905            NA            NA    NA    NA          NA
&lt;NA&gt;  0.1042513            NA            NA    NA    NA          NA
&lt;NA&gt;  0.2267405            NA            NA    NA    NA          NA
Total 1.0000000             0             0     0     0           0
      Resid. Disc. Orig. Disc.
&lt;NA&gt;            NA          NA
&lt;NA&gt;            NA          NA
&lt;NA&gt;            NA          NA
&lt;NA&gt;            NA          NA
&lt;NA&gt;            NA          NA
Total            0           0

$lmarket
      Target Old Weights N Old Weights % Wtd N Wtd % Change in % Resid. Disc.
&lt;NA&gt;  0.1341            NA            NA    NA    NA          NA           NA
&lt;NA&gt;  0.0494            NA            NA    NA    NA          NA           NA
&lt;NA&gt;  0.2611            NA            NA    NA    NA          NA           NA
&lt;NA&gt;  0.2472            NA            NA    NA    NA          NA           NA
&lt;NA&gt;  0.3082            NA            NA    NA    NA          NA           NA
Total 1.0000             0             0     0     0           0            0
      Orig. Disc.
&lt;NA&gt;           NA
&lt;NA&gt;           NA
&lt;NA&gt;           NA
&lt;NA&gt;           NA
&lt;NA&gt;           NA
Total           0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add weights to the dataset</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>rakedata<span class="sc">$</span>weightvec  <span class="ot">&lt;-</span> <span class="fu">unlist</span>(outsave[<span class="dv">1</span>])</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>n  <span class="ot">&lt;-</span> <span class="fu">length</span>(rakedata<span class="sc">$</span>sector)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the sum of original weights</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>original_weight_sum <span class="ot">&lt;-</span> <span class="fu">sum</span>(rakedata<span class="sc">$</span>weight)</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="co"># # Target scaling for original weights</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="co"># In a first version, we used the population scaling from UN,</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="co"># But to match with the labor market given by the scenario, we take</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="co"># the total population from the macro scenario information.</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a><span class="co"># original_weight_scaling_factor &lt;- pop_data$total_population[pop_data$year == 2030] /</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   pop_data$total_population[pop_data$year == 2022]</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a><span class="co"># For year 2030 (Calculated in Excel, but need a more elegant solution from dataset)</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>original_weight_scaling_factor <span class="ot">&lt;-</span> <span class="fl">0.992805755</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Scaled original weights</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>original_weight_sum <span class="ot">&lt;-</span> (original_weight_sum </span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>                        <span class="sc">*</span> original_weight_scaling_factor)</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the sum of the new weights</span></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>new_weight_sum <span class="ot">&lt;-</span> <span class="fu">sum</span>(rakedata<span class="sc">$</span>weightvec)</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale the new weights to match the sum of the original weights</span></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>scaling_factor <span class="ot">&lt;-</span> original_weight_sum <span class="sc">/</span> new_weight_sum</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>rakedata<span class="sc">$</span>weightvec <span class="ot">&lt;-</span> rakedata<span class="sc">$</span>weightvec <span class="sc">*</span> scaling_factor</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify the adjustment</span></span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(rakedata[, <span class="fu">c</span>(<span class="st">"weight"</span>, <span class="st">"weightvec"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    weight weightvec
1 185.7685  182.0355
2 185.7685  196.3028
3 122.7176  107.8986
4 185.7685  182.0355
5 326.8796  257.7991
6 326.8796  320.3109</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rakedata<span class="sc">$</span>weightvec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  16.94  105.46  142.38  153.57  195.92  497.42 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rakedata<span class="sc">$</span>weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  21.48  109.82  156.33  154.68  192.16  326.88 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>rakedata <span class="ot">&lt;-</span> rakedata <span class="sc">%&gt;%</span> </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(weightvec, <span class="at">.after =</span> weight) <span class="sc">%&gt;%</span> </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hh_weight =</span> weightvec <span class="sc">/</span> hhsize)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co"># We calculate new weights for households in the hh database</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>weights_2030 <span class="ot">&lt;-</span> rakedata <span class="sc">%&gt;%</span> </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hhid) <span class="sc">%&gt;%</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">hh_weight_2030 =</span> <span class="fu">sum</span>(hh_weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(rakedata)</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(rakedata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As a last step, we rescale labor income according to changes in the wage bill in the macro scenario.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Wage rescale factor by sector from macro (Agriculture, Manufacturing, Services)</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>wrf <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.269821454</span>, <span class="fl">1.284834838</span>, <span class="fl">1.328623737</span>)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We check the wage bill by sector</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>wages_by_sector <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span> </span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sector_w, <span class="at">.drop =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">wages_2022 =</span> <span class="fu">sum</span>(annual_labor_total <span class="sc">*</span> weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">wages_2030 =</span> <span class="fu">sum</span>(annual_labor_total <span class="sc">*</span> weightvec, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>wages_by_sector <span class="ot">&lt;-</span> wages_by_sector[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>),]</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare how much it changed with reweighting with how it should have changed</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Derive coefficients (wtc_2030) from that</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>wages_by_sector <span class="ot">&lt;-</span> wages_by_sector <span class="sc">%&gt;%</span> </span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">wages_target_2030 =</span> <span class="fu">case_when</span>(</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>      sector_w <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> wages_2022 <span class="sc">*</span> wrf[<span class="dv">1</span>],</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>      sector_w <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> wages_2022 <span class="sc">*</span> wrf[<span class="dv">2</span>],</span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>      sector_w <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> wages_2022 <span class="sc">*</span> wrf[<span class="dv">3</span>],</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="cn">NA</span></span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">wtc_2030 =</span> wages_target_2030 <span class="sc">/</span> wages_2030) </span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>wages_by_sector <span class="sc">%&gt;%</span></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="goyujzfzpm" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#goyujzfzpm table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#goyujzfzpm thead, #goyujzfzpm tbody, #goyujzfzpm tfoot, #goyujzfzpm tr, #goyujzfzpm td, #goyujzfzpm th {
  border-style: none;
}

#goyujzfzpm p {
  margin: 0;
  padding: 0;
}

#goyujzfzpm .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#goyujzfzpm .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#goyujzfzpm .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#goyujzfzpm .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#goyujzfzpm .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#goyujzfzpm .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#goyujzfzpm .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#goyujzfzpm .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#goyujzfzpm .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#goyujzfzpm .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#goyujzfzpm .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#goyujzfzpm .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#goyujzfzpm .gt_spanner_row {
  border-bottom-style: hidden;
}

#goyujzfzpm .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#goyujzfzpm .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#goyujzfzpm .gt_from_md > :first-child {
  margin-top: 0;
}

#goyujzfzpm .gt_from_md > :last-child {
  margin-bottom: 0;
}

#goyujzfzpm .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#goyujzfzpm .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#goyujzfzpm .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#goyujzfzpm .gt_row_group_first td {
  border-top-width: 2px;
}

#goyujzfzpm .gt_row_group_first th {
  border-top-width: 2px;
}

#goyujzfzpm .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#goyujzfzpm .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#goyujzfzpm .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#goyujzfzpm .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#goyujzfzpm .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#goyujzfzpm .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#goyujzfzpm .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#goyujzfzpm .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#goyujzfzpm .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#goyujzfzpm .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#goyujzfzpm .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#goyujzfzpm .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#goyujzfzpm .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#goyujzfzpm .gt_left {
  text-align: left;
}

#goyujzfzpm .gt_center {
  text-align: center;
}

#goyujzfzpm .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#goyujzfzpm .gt_font_normal {
  font-weight: normal;
}

#goyujzfzpm .gt_font_bold {
  font-weight: bold;
}

#goyujzfzpm .gt_font_italic {
  font-style: italic;
}

#goyujzfzpm .gt_super {
  font-size: 65%;
}

#goyujzfzpm .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#goyujzfzpm .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#goyujzfzpm .gt_indent_1 {
  text-indent: 5px;
}

#goyujzfzpm .gt_indent_2 {
  text-indent: 10px;
}

#goyujzfzpm .gt_indent_3 {
  text-indent: 15px;
}

#goyujzfzpm .gt_indent_4 {
  text-indent: 20px;
}

#goyujzfzpm .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="sector_w" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">sector_w</th>
<th id="wages_2022" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">wages_2022</th>
<th id="wages_2030" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">wages_2030</th>
<th id="wages_target_2030" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">wages_target_2030</th>
<th id="wtc_2030" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">wtc_2030</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_right" headers="sector_w">1</td>
<td class="gt_row gt_right" headers="wages_2022">329980600</td>
<td class="gt_row gt_right" headers="wages_2030">332988623</td>
<td class="gt_row gt_right" headers="wages_target_2030">419016446</td>
<td class="gt_row gt_right" headers="wtc_2030">1.258351</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="sector_w">2</td>
<td class="gt_row gt_right" headers="wages_2022">250074262</td>
<td class="gt_row gt_right" headers="wages_2030">262381786</td>
<td class="gt_row gt_right" headers="wages_target_2030">321304124</td>
<td class="gt_row gt_right" headers="wtc_2030">1.224567</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="sector_w">3</td>
<td class="gt_row gt_right" headers="wages_2022">1255196730</td>
<td class="gt_row gt_right" headers="wages_2030">1317702602</td>
<td class="gt_row gt_right" headers="wages_target_2030">1667684171</td>
<td class="gt_row gt_right" headers="wtc_2030">1.265600</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We then add the coefficient to rescale each weight by sector</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign rescale the annual and monthly wage depending on the sector</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>pp_microsim <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span> </span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">monthly_labor_income_old =</span> monthly_labor_income,</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">annual_labor_total_old =</span> annual_labor_total) <span class="sc">%&gt;%</span> </span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">monthly_labor_income =</span> <span class="fu">case_when</span>(</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>      sector_w <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> monthly_labor_income_old <span class="sc">*</span> wages_by_sector<span class="sc">$</span>wtc_2030[<span class="dv">1</span>],</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>      sector_w <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> monthly_labor_income_old <span class="sc">*</span> wages_by_sector<span class="sc">$</span>wtc_2030[<span class="dv">2</span>],</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>      sector_w <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> monthly_labor_income_old <span class="sc">*</span> wages_by_sector<span class="sc">$</span>wtc_2030[<span class="dv">3</span>],</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">annual_labor_total =</span> <span class="fu">case_when</span>(</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>      sector_w <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> annual_labor_total_old <span class="sc">*</span> wages_by_sector<span class="sc">$</span>wtc_2030[<span class="dv">1</span>],</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>      sector_w <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> annual_labor_total_old <span class="sc">*</span> wages_by_sector<span class="sc">$</span>wtc_2030[<span class="dv">2</span>],</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>      sector_w <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> annual_labor_total_old <span class="sc">*</span> wages_by_sector<span class="sc">$</span>wtc_2030[<span class="dv">3</span>],</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a><span class="co"># This takes care of different household members coming from different sectors</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>hh_li_baseline <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span> </span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hhid) <span class="sc">%&gt;%</span> </span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mli_2022 =</span> <span class="fu">sum</span>(monthly_labor_income_old),</span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">mli_2030 =</span> <span class="fu">sum</span>(monthly_labor_income),</span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">mli_coef_2030 =</span> mli_2030 <span class="sc">/</span> mli_2022) <span class="sc">%&gt;%</span> </span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(hhid, mli_coef_2030)</span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>ic_microsim <span class="ot">&lt;-</span> ic <span class="sc">%&gt;%</span> </span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(hh_li_baseline, <span class="fu">join_by</span>(interview__key <span class="sc">==</span> hhid)) <span class="sc">%&gt;%</span></span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">inc2_old =</span> inc2,</span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>         <span class="at">inc3_old =</span> inc3,</span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">totalinc_old =</span> totalinc) <span class="sc">%&gt;%</span> </span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mli_coef_2030 =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(mli_coef_2030), <span class="dv">1</span>,mli_coef_2030)) <span class="sc">%&gt;%</span> </span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inc2 =</span> inc2_old <span class="sc">*</span> mli_coef_2030,</span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>         <span class="at">inc3 =</span> inc3_old <span class="sc">*</span> mli_coef_2030) <span class="sc">%&gt;%</span> </span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totalinc =</span> totalinc_old <span class="sc">-</span> <span class="fu">coalesce</span>(inc2_old,<span class="dv">0</span>) <span class="sc">-</span> <span class="fu">coalesce</span>(inc3_old,<span class="dv">0</span>)</span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a>                         <span class="sc">+</span> <span class="fu">coalesce</span>(inc2,<span class="dv">0</span>) <span class="sc">+</span> <span class="fu">coalesce</span>(inc3,<span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totinc_coef_2030 =</span> <span class="fu">if_else</span>(totalinc_old <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">1</span>, totalinc <span class="sc">/</span> totalinc_old)) <span class="sc">%&gt;%</span> </span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totinc_coef_2030 =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(totinc_coef_2030), <span class="dv">1</span>, totinc_coef_2030))</span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a>ic_coef_2030 <span class="ot">&lt;-</span> ic_microsim <span class="sc">%&gt;%</span> </span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(interview__key, totinc_coef_2030)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="microsimulation" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="microsimulation"><span class="header-section-number">8</span> Microsimulation</h2>
<p>We now implement different shocks according to various scenarios.</p>
<section id="baseline" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="baseline"><span class="header-section-number">8.1</span> Baseline</h3>
<p>For the baseline we only adjust labor income according to the reweighting procedure and rescaling of the wage bill.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>ca_microsim <span class="ot">&lt;-</span> ca <span class="sc">%&gt;%</span> </span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(weights_2030, <span class="fu">join_by</span>(hhid <span class="sc">==</span> hhid)) <span class="sc">%&gt;%</span> </span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ic_coef_2030, <span class="fu">join_by</span>(hhid <span class="sc">==</span> interview__key)) <span class="sc">%&gt;%</span> </span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We adjust total consumption by the income coefficient</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make sure to remember that totc is baseline 2030</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">totc_old =</span> totc,</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Make sure to remember that pov2022 is baseline 2030</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">poor_Avpovln2022_old =</span> poor_Avpovln2022) <span class="sc">%&gt;%</span> </span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totc =</span> totc_old <span class="sc">*</span> totinc_coef_2030 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And recalculate poverty.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>ca_microsim <span class="ot">&lt;-</span> ca_microsim <span class="sc">%&gt;%</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">aec_r_old =</span> aec_r,</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">weight_old =</span> weight,</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">weight =</span> hh_weight_2030) <span class="sc">%&gt;%</span> </span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">aec_r =</span> totc <span class="sc">/</span> ae_r <span class="sc">/</span> PI) <span class="sc">%&gt;%</span> </span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">poor_Avpovln2022 =</span> </span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>           <span class="fu">if_else</span>(aec_r <span class="sc">&lt;</span> <span class="dv">52883</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>         )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Test</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> ca_microsim <span class="sc">%&gt;%</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">poor_original =</span> poor_Avpovln2022_old,</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">poor_2030 =</span> poor_Avpovln2022) <span class="sc">%&gt;%</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(poor_2030) <span class="sc">%&gt;%</span> </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">no_hh =</span> <span class="fu">round</span>(<span class="fu">sum</span>(weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">no_pp =</span> <span class="fu">round</span>(<span class="fu">sum</span>(weight <span class="sc">*</span> hhsize, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> ca_microsim <span class="sc">%&gt;%</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">poor_original =</span> poor_Avpovln2022_old,</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">poor_2030 =</span> poor_Avpovln2022) <span class="sc">%&gt;%</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(poor_original) <span class="sc">%&gt;%</span> </span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">no_hh =</span> <span class="fu">round</span>(<span class="fu">sum</span>(weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">no_pp =</span> <span class="fu">round</span>(<span class="fu">sum</span>(weight <span class="sc">*</span> hhsize, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>test <span class="sc">%&gt;%</span> </span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="vipxgqsjys" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#vipxgqsjys table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#vipxgqsjys thead, #vipxgqsjys tbody, #vipxgqsjys tfoot, #vipxgqsjys tr, #vipxgqsjys td, #vipxgqsjys th {
  border-style: none;
}

#vipxgqsjys p {
  margin: 0;
  padding: 0;
}

#vipxgqsjys .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#vipxgqsjys .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#vipxgqsjys .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#vipxgqsjys .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#vipxgqsjys .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#vipxgqsjys .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vipxgqsjys .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#vipxgqsjys .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#vipxgqsjys .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#vipxgqsjys .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#vipxgqsjys .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#vipxgqsjys .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#vipxgqsjys .gt_spanner_row {
  border-bottom-style: hidden;
}

#vipxgqsjys .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#vipxgqsjys .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#vipxgqsjys .gt_from_md > :first-child {
  margin-top: 0;
}

#vipxgqsjys .gt_from_md > :last-child {
  margin-bottom: 0;
}

#vipxgqsjys .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#vipxgqsjys .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#vipxgqsjys .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#vipxgqsjys .gt_row_group_first td {
  border-top-width: 2px;
}

#vipxgqsjys .gt_row_group_first th {
  border-top-width: 2px;
}

#vipxgqsjys .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#vipxgqsjys .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#vipxgqsjys .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#vipxgqsjys .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vipxgqsjys .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#vipxgqsjys .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#vipxgqsjys .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#vipxgqsjys .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#vipxgqsjys .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vipxgqsjys .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#vipxgqsjys .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#vipxgqsjys .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#vipxgqsjys .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#vipxgqsjys .gt_left {
  text-align: left;
}

#vipxgqsjys .gt_center {
  text-align: center;
}

#vipxgqsjys .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#vipxgqsjys .gt_font_normal {
  font-weight: normal;
}

#vipxgqsjys .gt_font_bold {
  font-weight: bold;
}

#vipxgqsjys .gt_font_italic {
  font-style: italic;
}

#vipxgqsjys .gt_super {
  font-size: 65%;
}

#vipxgqsjys .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#vipxgqsjys .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#vipxgqsjys .gt_indent_1 {
  text-indent: 5px;
}

#vipxgqsjys .gt_indent_2 {
  text-indent: 10px;
}

#vipxgqsjys .gt_indent_3 {
  text-indent: 15px;
}

#vipxgqsjys .gt_indent_4 {
  text-indent: 20px;
}

#vipxgqsjys .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="Poor, Avpovln2022" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col">Poor, Avpovln2022</th>
<th id="no_hh" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">no_hh</th>
<th id="no_pp" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">no_pp</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_center" headers="poor_original">0</td>
<td class="gt_row gt_right" headers="no_hh">638528</td>
<td class="gt_row gt_right" headers="no_pp">2126723</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="poor_original">1</td>
<td class="gt_row gt_right" headers="no_hh">143033</td>
<td class="gt_row gt_right" headers="no_pp">707267</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">#write.table(test, "clipboard", sep="\t", row.names=FALSE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="climate-change" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="climate-change"><span class="header-section-number">8.2</span> Climate change</h3>
<p>In the climate change scenario, we ask ourselves, what would happen if agriculture revenues from crops and livestock are reduced due to losses in productivity due to heat. For this, we use crops data.</p>
<p>We add a moving window average and max value for our labor productivity data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First calculate moving window average</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>heat_l_pdcty <span class="ot">&lt;-</span> heat_l_pdcty <span class="sc">%&gt;%</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ADM1_EN, clim_scenario) <span class="sc">%&gt;%</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Moving window average 5 years before, 5 after</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">moving_avg =</span> <span class="fu">rollapply</span>(</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>      pct_change_productivity, </span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">width =</span> <span class="dv">11</span>,</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">FUN =</span> mean,</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">partial =</span> <span class="cn">TRUE</span>,</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">"center"</span>, </span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Moving window max value 5 years before, 5 after</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Since it's expressed in negative values (min) is the maximum</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">moving_max =</span> <span class="fu">rollapply</span>(</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>      pct_change_productivity, </span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">width =</span> <span class="dv">11</span>,</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">FUN =</span> min,</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">partial =</span> <span class="cn">TRUE</span>,</span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">"center"</span>, </span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Clim scenarios to select</span></span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>cs <span class="ot">&lt;-</span> <span class="fu">unique</span>(heat_l_pdcty<span class="sc">$</span>clim_scenario)</span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Moving average for year of interest</span></span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>lab_loss_avg <span class="ot">&lt;-</span> heat_l_pdcty <span class="sc">%&gt;%</span> </span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(clim_scenario <span class="sc">==</span> cs[<span class="dv">1</span>], year <span class="sc">==</span> yearsto[<span class="dv">1</span>] ) <span class="sc">%&gt;%</span></span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>pct_change_productivity,<span class="sc">-</span>ADM1_PCODE,</span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>year,<span class="sc">-</span>clim_scenario, <span class="sc">-</span>moving_max) <span class="sc">%&gt;%</span> </span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> sector,</span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> moving_avg) <span class="sc">%&gt;%</span> </span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">agr_avg =</span> Agriculture,</span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a>         <span class="at">man_avg =</span> Manufacturing,</span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a>         <span class="at">ser_avg =</span> Services)</span>
<span id="cb88-40"><a href="#cb88-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-41"><a href="#cb88-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Max value for year of interest</span></span>
<span id="cb88-42"><a href="#cb88-42" aria-hidden="true" tabindex="-1"></a>lab_loss_max <span class="ot">&lt;-</span> heat_l_pdcty <span class="sc">%&gt;%</span> </span>
<span id="cb88-43"><a href="#cb88-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(clim_scenario <span class="sc">==</span> cs[<span class="dv">1</span>], year <span class="sc">==</span> yearsto[<span class="dv">1</span>] ) <span class="sc">%&gt;%</span></span>
<span id="cb88-44"><a href="#cb88-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>pct_change_productivity, <span class="sc">-</span>ADM1_PCODE,</span>
<span id="cb88-45"><a href="#cb88-45" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>year,<span class="sc">-</span>clim_scenario,<span class="sc">-</span>moving_avg) <span class="sc">%&gt;%</span> </span>
<span id="cb88-46"><a href="#cb88-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> sector,</span>
<span id="cb88-47"><a href="#cb88-47" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> moving_max) <span class="sc">%&gt;%</span> </span>
<span id="cb88-48"><a href="#cb88-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">agr_max =</span> Agriculture,</span>
<span id="cb88-49"><a href="#cb88-49" aria-hidden="true" tabindex="-1"></a>         <span class="at">man_max =</span> Manufacturing,</span>
<span id="cb88-50"><a href="#cb88-50" aria-hidden="true" tabindex="-1"></a>         <span class="at">ser_max =</span> Services)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We add a moving window average and max value for our crops and livestock productivity data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First calculate moving window average</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>crops_productivity <span class="ot">&lt;-</span> crops_productivity <span class="sc">%&gt;%</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(NAM_1, climate_scenario) <span class="sc">%&gt;%</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Moving window average </span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">moving_avg =</span> <span class="fu">rollapply</span>(</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>      pct_change_prod, </span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">width =</span> <span class="dv">11</span>,    <span class="co"># 5 years before, 5 after + reference year = 11</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">FUN =</span> mean,</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">partial =</span> <span class="cn">TRUE</span>,</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">"center"</span>, </span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Moving window max value 5 years before, 5 after</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Since it's expressed in negative values (min) is the maximum</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">moving_max =</span> <span class="fu">rollapply</span>(</span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>      pct_change_prod, </span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">width =</span> <span class="dv">11</span>,</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">FUN =</span> min,</span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">partial =</span> <span class="cn">TRUE</span>,</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">"center"</span>, </span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Clim scenarios to select</span></span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>cs <span class="ot">&lt;-</span> <span class="fu">unique</span>(crops_productivity<span class="sc">$</span>climate_scenario)</span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Moving average for year of interest</span></span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a>ag_pdcvty_loss <span class="ot">&lt;-</span> crops_productivity <span class="sc">%&gt;%</span> </span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(climate_scenario <span class="sc">==</span> cs[<span class="dv">1</span>], year <span class="sc">==</span> yearsto[<span class="dv">1</span>] ) <span class="sc">%&gt;%</span></span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>pct_change_prod,<span class="sc">-</span>GID_1, <span class="sc">-</span>year,<span class="sc">-</span>climate_scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">crops_avg_loss =</span> moving_avg,</span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a>         <span class="at">crops_max_loss =</span> moving_max)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then we introduce these values in our ag income and labor income data. First, we attach the percentage losses to the appropriate data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Persons processed dataset</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>pp_microsim_cc <span class="ot">&lt;-</span> pp_microsim <span class="sc">%&gt;%</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(lab_loss_avg, <span class="fu">join_by</span>(NAM_1<span class="sc">==</span>ADM1_EN)) <span class="sc">%&gt;%</span> </span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(lab_loss_max, <span class="fu">join_by</span>(NAM_1<span class="sc">==</span>ADM1_EN))</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Household income processed dataset</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>ic_microsim_cc <span class="ot">&lt;-</span> ic_microsim <span class="sc">%&gt;%</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ag_pdcvty_loss, <span class="fu">join_by</span>(NAM_1<span class="sc">==</span>NAM_1)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we first shock labor income.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Labor income according to sector</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>pp_microsim_cc <span class="ot">&lt;-</span> pp_microsim_cc <span class="sc">%&gt;%</span> </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sector =</span> <span class="fu">as.numeric</span>(sector)) <span class="sc">%&gt;%</span> </span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mli_cc_avg =</span> <span class="fu">case_when</span>(</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1000 because its thousands of Dram</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    sector <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> monthly_labor_income <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> agr_avg)<span class="sc">*</span> <span class="dv">1000</span>,   </span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    sector <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> monthly_labor_income <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> man_avg)<span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>    sector <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> monthly_labor_income <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> ser_avg)<span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mli_cc_max =</span> <span class="fu">case_when</span>(</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1000 because its thousands of Dram</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>    sector <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> monthly_labor_income <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> agr_max)<span class="sc">*</span> <span class="dv">1000</span>,   </span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>    sector <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> monthly_labor_income <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> man_max)<span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>    sector <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> monthly_labor_income <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> ser_max)<span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA</span></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We aggregate at household level and register the percent difference between the two labor incomes, so that we can impact labor income by that amount. We don’t do it with absolute numbers because we don’t know the assumptions made by the poverty team to construct the income variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>ic_new_incomes <span class="ot">&lt;-</span> pp_microsim_cc <span class="sc">%&gt;%</span> </span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hhid) <span class="sc">%&gt;%</span> </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mli_cc_avg =</span> <span class="fu">sum</span>(mli_cc_avg, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mli_cc_max =</span> <span class="fu">sum</span>(mli_cc_max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mli_original =</span> <span class="fu">sum</span>(monthly_labor_income<span class="sc">*</span><span class="dv">1000</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mli_avg_coef =</span> </span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>           <span class="fu">if_else</span>(mli_original <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> <span class="fu">is.na</span>(mli_original), <span class="dv">1</span>,</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>                   mli_cc_avg <span class="sc">/</span> mli_original),</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">mli_max_coef =</span> </span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>           <span class="fu">if_else</span>(mli_original <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> <span class="fu">is.na</span>(mli_original), <span class="dv">1</span>, </span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>                   mli_cc_max <span class="sc">/</span> mli_original)</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>ic_microsim_cc <span class="ot">&lt;-</span> ic_microsim_cc <span class="sc">%&gt;%</span> </span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ic_new_incomes, <span class="fu">join_by</span>(interview__key <span class="sc">==</span> hhid)) <span class="sc">%&gt;%</span> </span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inc2_cc_avg =</span> inc2 <span class="sc">*</span> mli_avg_coef,</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">inc2_cc_max =</span> inc2 <span class="sc">*</span> mli_max_coef,</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">inc3_cc_avg =</span> inc3 <span class="sc">*</span> mli_avg_coef,</span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">inc3_cc_max =</span> inc3 <span class="sc">*</span> mli_max_coef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now we impact agricultural income <code>inc4</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>ic_microsim_cc <span class="ot">&lt;-</span> ic_microsim_cc <span class="sc">%&gt;%</span> </span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inc4_cc_avg =</span> inc4 <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> crops_avg_loss),</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">inc4_cc_max =</span> inc4 <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> crops_max_loss))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And recalculate total income.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>ic_microsim_cc <span class="ot">&lt;-</span> ic_microsim_cc <span class="sc">%&gt;%</span> </span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totalinc_cc_avg =</span> totalinc <span class="sc">-</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., <span class="fu">c</span>(inc2, inc3, inc4)), </span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">rowSums</span>(<span class="fu">select</span>(., <span class="fu">c</span>(inc2_cc_avg, inc3_cc_avg, inc4_cc_avg)), </span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">totalinc_cc_max =</span> totalinc <span class="sc">-</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., <span class="fu">c</span>(inc2, inc3, inc4)), </span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">rowSums</span>(<span class="fu">select</span>(., <span class="fu">c</span>(inc2_cc_max, inc3_cc_max, inc4_cc_max)), </span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totalinc_cc_avg_coef =</span> </span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>           <span class="fu">if_else</span>(totalinc <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">1</span>,</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>                   totalinc_cc_avg <span class="sc">/</span> totalinc),</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">totalinc_cc_max_coef =</span> </span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>           <span class="fu">if_else</span>(totalinc <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">1</span>, </span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>                   totalinc_cc_max <span class="sc">/</span> totalinc)</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totalinc_cc_avg_coef =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(totalinc_cc_avg_coef), <span class="dv">1</span>, totalinc_cc_avg_coef),</span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">totalinc_cc_max_coef =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(totalinc_cc_max_coef), <span class="dv">1</span>, totalinc_cc_max_coef))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We assume that the loss in income translates in a loss of expenditure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>income_losses <span class="ot">&lt;-</span> ic_microsim_cc <span class="sc">%&gt;%</span> </span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(interview__key,totalinc_cc_avg_coef, totalinc_cc_max_coef)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim <span class="sc">%&gt;%</span> </span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(income_losses, <span class="fu">join_by</span>(hhid <span class="sc">==</span> interview__key))</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="co"># And now reduce total consumption</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span> </span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totc_cc_avg =</span> totc <span class="sc">*</span> totalinc_cc_avg_coef,</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">totc_cc_max =</span> totc <span class="sc">*</span> totalinc_cc_max_coef) <span class="sc">%&gt;%</span> </span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">aec_r_cc_avg =</span> totc_cc_avg <span class="sc">/</span> ae_r <span class="sc">/</span> PI,</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">aec_r_cc_max =</span> totc_cc_max <span class="sc">/</span> ae_r <span class="sc">/</span> PI) <span class="sc">%&gt;%</span> </span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">poor_cc_avg =</span> </span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>           <span class="fu">if_else</span>(aec_r_cc_avg <span class="sc">&lt;</span> <span class="dv">52883</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">poor_cc_max =</span> </span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>           <span class="fu">if_else</span>(aec_r_cc_max <span class="sc">&lt;</span> <span class="dv">52883</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a><span class="co"># We make a table to see who became poor. </span></span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">poor_original =</span> poor_Avpovln2022,</span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">poor_cc =</span> poor_cc_avg) <span class="sc">%&gt;%</span></span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(poor_original, poor_cc) <span class="sc">%&gt;%</span> </span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">no_hh =</span> <span class="fu">round</span>(<span class="fu">sum</span>(weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">no_pp =</span> <span class="fu">round</span>(<span class="fu">sum</span>(weight <span class="sc">*</span> hhsize, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'poor_original'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co">#write.table(test, "clipboard", sep="\t", row.names=FALSE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="food-prices" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="food-prices"><span class="header-section-number">8.3</span> Food prices</h3>
<p>We start by looking at the differences of food prices between scenarios.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>scenarios <span class="ot">&lt;-</span> <span class="fu">unique</span>(macro_data<span class="sc">$</span>scenario_id)</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We extract and reformat the price data</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>price_data <span class="ot">&lt;-</span> macro_data <span class="sc">%&gt;%</span> </span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, scenario_id, <span class="fu">starts_with</span>( <span class="fu">c</span>(<span class="st">"fpi"</span> , <span class="st">"epi"</span>) )) <span class="sc">%&gt;%</span> </span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">scenario =</span> scenario_id) <span class="sc">%&gt;%</span> </span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">starts_with</span>( <span class="fu">c</span>(<span class="st">"fpi"</span> , <span class="st">"epi"</span>) ), </span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"type_decile"</span>, </span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"index"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">decile =</span> <span class="fu">parse_number</span>(type_decile)) <span class="sc">%&gt;%</span> </span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">commodity_group =</span> </span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>           <span class="fu">case_when</span>(</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>             <span class="fu">str_starts</span>(type_decile, <span class="st">"fpi"</span>) <span class="sc">~</span> <span class="st">"food"</span>,</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>             <span class="fu">str_starts</span>(type_decile, <span class="st">"epi"</span>) <span class="sc">~</span> <span class="st">"energy"</span>,</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>             <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>           )) <span class="sc">%&gt;%</span> </span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>type_decile) <span class="sc">%&gt;%</span> </span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(index, <span class="at">.after =</span> commodity_group)</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a><span class="co"># We take a look at price information in 2030</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>price_data <span class="sc">%&gt;%</span> </span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2030</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(commodity_group, scenario) <span class="sc">%&gt;%</span> </span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">index =</span> <span class="fu">mean</span>(index, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'commodity_group'. You can override using
the `.groups` argument.</code></pre>
</div>
<div class="cell-output-display">
<div id="sjxqcsobva" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#sjxqcsobva table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#sjxqcsobva thead, #sjxqcsobva tbody, #sjxqcsobva tfoot, #sjxqcsobva tr, #sjxqcsobva td, #sjxqcsobva th {
  border-style: none;
}

#sjxqcsobva p {
  margin: 0;
  padding: 0;
}

#sjxqcsobva .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#sjxqcsobva .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#sjxqcsobva .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#sjxqcsobva .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#sjxqcsobva .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#sjxqcsobva .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#sjxqcsobva .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#sjxqcsobva .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#sjxqcsobva .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#sjxqcsobva .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#sjxqcsobva .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#sjxqcsobva .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#sjxqcsobva .gt_spanner_row {
  border-bottom-style: hidden;
}

#sjxqcsobva .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#sjxqcsobva .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#sjxqcsobva .gt_from_md > :first-child {
  margin-top: 0;
}

#sjxqcsobva .gt_from_md > :last-child {
  margin-bottom: 0;
}

#sjxqcsobva .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#sjxqcsobva .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#sjxqcsobva .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#sjxqcsobva .gt_row_group_first td {
  border-top-width: 2px;
}

#sjxqcsobva .gt_row_group_first th {
  border-top-width: 2px;
}

#sjxqcsobva .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#sjxqcsobva .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#sjxqcsobva .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#sjxqcsobva .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#sjxqcsobva .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#sjxqcsobva .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#sjxqcsobva .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#sjxqcsobva .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#sjxqcsobva .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#sjxqcsobva .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#sjxqcsobva .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#sjxqcsobva .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#sjxqcsobva .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#sjxqcsobva .gt_left {
  text-align: left;
}

#sjxqcsobva .gt_center {
  text-align: center;
}

#sjxqcsobva .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#sjxqcsobva .gt_font_normal {
  font-weight: normal;
}

#sjxqcsobva .gt_font_bold {
  font-weight: bold;
}

#sjxqcsobva .gt_font_italic {
  font-style: italic;
}

#sjxqcsobva .gt_super {
  font-size: 65%;
}

#sjxqcsobva .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#sjxqcsobva .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#sjxqcsobva .gt_indent_1 {
  text-indent: 5px;
}

#sjxqcsobva .gt_indent_2 {
  text-indent: 10px;
}

#sjxqcsobva .gt_indent_3 {
  text-indent: 15px;
}

#sjxqcsobva .gt_indent_4 {
  text-indent: 20px;
}

#sjxqcsobva .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="scenario" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">scenario</th>
<th id="index" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">index</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd gt_group_heading_row">
<td colspan="2" id="energy" class="gt_group_heading" data-quarto-table-cell-role="th" scope="colgroup">energy</td>
</tr>
<tr class="even gt_row_group_first">
<td class="gt_row gt_left" headers="energy  scenario">Dry-hot scenario</td>
<td class="gt_row gt_right" headers="energy  index">1.124883</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="energy  scenario">baseline</td>
<td class="gt_row gt_right" headers="energy  index">1.129182</td>
</tr>
<tr class="even gt_group_heading_row">
<td colspan="2" id="food" class="gt_group_heading" data-quarto-table-cell-role="th" scope="colgroup">food</td>
</tr>
<tr class="odd gt_row_group_first">
<td class="gt_row gt_left" headers="food  scenario">Dry-hot scenario</td>
<td class="gt_row gt_right" headers="food  index">1.075696</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="food  scenario">baseline</td>
<td class="gt_row gt_right" headers="food  index">1.009986</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>So, we will assign a price index depending on which decile the household belonged to in the base year 2022. We will have a column for each scenario. So we manipulate our price data according to our years of interest (in this case, only 2030).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter `price_data` for the years of interest</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>price_data_yearsto <span class="ot">&lt;-</span> price_data <span class="sc">%&gt;%</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> yearsto)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a named vector for scenario indices</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>scenario_indices <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">seq_along</span>(scenarios), scenarios)</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the composite string column</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>price_data_yearsto <span class="ot">&lt;-</span> price_data_yearsto <span class="sc">%&gt;%</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">scenario_index =</span> scenario_indices[scenario],</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">composite_column =</span> <span class="fu">paste</span>(commodity_group, scenario_index, year, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(decile,index,composite_column)</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>composite_column_names <span class="ot">&lt;-</span> <span class="fu">unique</span>(price_data_yearsto<span class="sc">$</span>composite_column)</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>price_data_yearsto <span class="ot">&lt;-</span> price_data_yearsto <span class="sc">%&gt;%</span> </span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from=</span><span class="st">"composite_column"</span>, <span class="at">values_from =</span> index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we join with our household’s dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PP microsim already has decile information from previous join</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span> </span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(price_data_yearsto, <span class="fu">join_by</span>(decile<span class="sc">==</span>decile))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we don’t have quantities for the aggregate food expenditure category or for the aggregate energy bundle, we assume a price of 1 in the survey year. We estimate elasticitiesand assign them to homes by decile.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate implicit price as total expenditure on food divided by food consumption</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">implicit_price =</span> aec_r <span class="sc">/</span> food1)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-transform the relevant variables</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_food1 =</span> <span class="fu">log</span>(food1),</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_implicit_price =</span> <span class="fu">log</span>(implicit_price),</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_aec_r =</span> <span class="fu">log</span>(aec_r))</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing values and data distribution</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(ca_microsim_cc)</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise the data for variability within each decile</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>ca_summary <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(decile) <span class="sc">%&gt;%</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_food1_mean =</span> <span class="fu">mean</span>(log_food1, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_food1_sd =</span> <span class="fu">sd</span>(log_food1, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_implicit_price_mean =</span> <span class="fu">mean</span>(log_implicit_price, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_implicit_price_sd =</span> <span class="fu">sd</span>(log_implicit_price, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ca_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   decile log_food1_mean log_food1_sd log_implicit_price_mean
    &lt;dbl&gt;          &lt;dbl&gt;        &lt;dbl&gt;                   &lt;dbl&gt;
 1      1           11.1        0.415                 -0.562 
 2      2           11.1        0.459                 -0.397 
 3      3           11.2        0.510                 -0.329 
 4      4           11.3        0.528                 -0.250 
 5      5           11.3        0.541                 -0.153 
 6      6           11.3        0.577                 -0.0370
 7      7           11.3        0.580                 -0.0258
 8      8           11.3        0.592                  0.0875
 9      9           11.3        0.620                  0.283 
10     10           11.2        0.582                  0.761 
# ℹ 1 more variable: log_implicit_price_sd &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visual inspection</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ca_microsim_cc, <span class="fu">aes</span>(<span class="at">x =</span> log_implicit_price, <span class="at">y =</span> log_food1)) <span class="sc">+</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> decile) <span class="sc">+</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Log Food Consumption vs. Log Implicit Price by Decile"</span>,</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Log Implicit Price"</span>, <span class="at">y =</span> <span class="st">"Log Food Consumption"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="microsimulation_files/figure-html/unnamed-chunk-72-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a function to fit the simplified model and extract the price elasticity</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>fit_model <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">lm</span>(log_food1 <span class="sc">~</span> log_implicit_price, <span class="at">data =</span> data)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>(model)</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the simplified model fitting function by decile</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>decile_models <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(decile) <span class="sc">%&gt;%</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">%&gt;%</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">map</span>(data, fit_model)) <span class="sc">%&gt;%</span></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"log_implicit_price"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(decile, <span class="at">price_elasticity =</span> estimate)</span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting the price elasticity for each decile</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>food_decile_elasticities <span class="ot">&lt;-</span> decile_models <span class="sc">%&gt;%</span></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(decile, price_elasticity)</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the results</span></span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(food_decile_elasticities)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
# Groups:   decile [10]
   decile price_elasticity
    &lt;dbl&gt;            &lt;dbl&gt;
 1      9           -0.964
 2      7           -0.971
 3      2           -0.980
 4      4           -0.977
 5     10           -0.759
 6      8           -0.968
 7      5           -0.984
 8      6           -0.977
 9      3           -0.972
10      1           -0.929</code></pre>
</div>
</div>
<p>Let’s apply the elasticities to the new data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge elasticities</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(food_decile_elasticities, <span class="at">by =</span> <span class="st">"decile"</span>)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the implicit price</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming implicit_price can be calculated from the expenditure (food1)</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="co"># If we assume baseline quantity consumed is proportional to expenditure/price</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">implicit_price =</span> food1 <span class="sc">/</span> food1,  <span class="co"># This is 1 as we don't have baseline price</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">food_quantity =</span> food1 <span class="sc">/</span> implicit_price)</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the percentage change in prices for each decile</span></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">food_1_dprice =</span> (food_1_2030 <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">food_2_dprice =</span> (food_2_2030 <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the new food consumption levels</span></span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">food_q1_sim =</span> food_quantity <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> food_1_dprice <span class="sc">*</span> price_elasticity),</span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">food_q2_sim =</span> food_quantity <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> food_2_dprice <span class="sc">*</span> price_elasticity))</span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the new expenditure levels</span></span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">food_exp1_sim =</span> food_q1_sim <span class="sc">*</span> food_1_2030,</span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">food_exp2_sim =</span> food_q2_sim <span class="sc">*</span> food_2_2030)</span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a><span class="co"># View the results</span></span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ca_microsim_cc <span class="sc">%&gt;%</span> <span class="fu">select</span>(decile, food1, food_1_2030, food_1_dprice, food_q1_sim, food_exp1_sim, food_2_dprice, food_q2_sim, food_exp2_sim))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,184 × 9
   decile   food1 food_1_2030 food_1_dprice food_q1_sim food_exp1_sim
    &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;         &lt;dbl&gt;
 1      9  92178.        1.07        0.0749      85520.        91925.
 2      7 105290.        1.07        0.0743      97691.       104953.
 3      2  22733.        1.08        0.0761      21039.        22640.
 4      2 163379.        1.08        0.0761     151199.       162705.
 5      4 102718.        1.08        0.0774      94956.       102303.
 6     10 208995.        1.08        0.0777     196678.       211958.
 7      8 116151.        1.08        0.0759     107620.       115788.
 8      5  67911.        1.07        0.0742      62954.        67626.
 9      6 152144.        1.07        0.0749     141003.       151568.
10      8  80033.        1.08        0.0759      74155.        79783.
# ℹ 5,174 more rows
# ℹ 3 more variables: food_2_dprice &lt;dbl&gt;, food_q2_sim &lt;dbl&gt;,
#   food_exp2_sim &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Let’s plot the distributions to see changes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic density plot comparing food1 and food_exp_sim</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ca_microsim_cc, <span class="fu">aes</span>(<span class="at">x =</span> food1, <span class="at">fill =</span> <span class="st">'Initial Food Expenditure'</span>)) <span class="sc">+</span> </span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> ca_microsim_cc, </span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> food_exp1_sim, <span class="at">fill =</span> <span class="st">'Food Expenditure + Dry-Hot'</span>), </span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span><span class="fu">geom_density</span>(</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> ca_microsim_cc, </span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> food_exp2_sim, <span class="at">fill =</span> <span class="st">'Food Expenditure + Baseline'</span>), </span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Consumption Type"</span>, </span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of Food Expenditure Distributions"</span>, </span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Food Expenditure"</span>, </span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">150000</span>)) <span class="sc">+</span> <span class="co"># Adjust the xlim for zoom</span></span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>comma) <span class="sc">+</span></span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>comma)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="microsimulation_files/figure-html/unnamed-chunk-74-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Calculate losses in consumer surplus and purchasing power loss.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the implicit price (assuming baseline implicit price is 1 for simplicity)</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">implicit_price =</span> <span class="dv">1</span>,  <span class="co"># Simplified assumption</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">food_quantity =</span> food1 <span class="sc">/</span> implicit_price)</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the percentage change in prices for each decile</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">food_1_dprice =</span> (food_1_2030 <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">food_2_dprice =</span> (food_2_2030 <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the existing new food consumption levels (already calculated)</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ca_microsim_cc &lt;- ca_microsim_cc %&gt;%</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(food_q1_sim = food_quantity * (1 + food_1_dprice * price_elasticity),</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a><span class="co">#          food_q2_sim = food_quantity * (1 + food_2_dprice * price_elasticity))</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Consumer Surplus loss for food1 and food2 scenarios</span></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">food1_CSloss =</span> ((food_quantity <span class="sc">*</span> implicit_price) <span class="sc">/</span> totc) <span class="sc">*</span> food_1_dprice <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> (price_elasticity <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">*</span> food_1_dprice),</span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">food2_CSloss =</span> ((food_quantity <span class="sc">*</span> implicit_price) <span class="sc">/</span> totc) <span class="sc">*</span> food_2_dprice <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> (price_elasticity <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">*</span> food_2_dprice),</span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">ttl_CSloss_1 =</span> food1_CSloss,</span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">ttl_CSloss_2 =</span> food2_CSloss)</span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Purchasing Power loss for food1 and food2 scenarios</span></span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">food1_PPloss =</span> (food1 <span class="sc">/</span> totc) <span class="sc">*</span> food_1_dprice,</span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">food2_PPloss =</span> (food1 <span class="sc">/</span> totc) <span class="sc">*</span> food_2_dprice,</span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">ttl_PPloss_1 =</span> food1_PPloss,</span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">ttl_PPloss_2 =</span> food2_PPloss)</span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust total expenditure (totc) based on the purchasing power loss</span></span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totc_cc_avg_food1 =</span> totc_cc_avg <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> ttl_PPloss_1),</span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a>         <span class="at">totc_cc_avg_food2 =</span> totc_cc_avg <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> ttl_PPloss_2))</span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a><span class="co"># View the results</span></span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ca_microsim_cc <span class="sc">%&gt;%</span> <span class="fu">select</span>(decile, food1, food_1_2030, food_1_dprice, food_q1_sim, food_exp1_sim, food_2_dprice, food_q2_sim, food_exp2_sim, food1_CSloss, food2_CSloss, ttl_CSloss_1, ttl_CSloss_2, food1_PPloss, food2_PPloss, ttl_PPloss_1, ttl_PPloss_2, totc_cc_avg_food1, totc_cc_avg_food2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,184 × 19
   decile   food1 food_1_2030 food_1_dprice food_q1_sim food_exp1_sim
    &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;         &lt;dbl&gt;
 1      9  92178.        1.07        0.0749      85520.        91925.
 2      7 105290.        1.07        0.0743      97691.       104953.
 3      2  22733.        1.08        0.0761      21039.        22640.
 4      2 163379.        1.08        0.0761     151199.       162705.
 5      4 102718.        1.08        0.0774      94956.       102303.
 6     10 208995.        1.08        0.0777     196678.       211958.
 7      8 116151.        1.08        0.0759     107620.       115788.
 8      5  67911.        1.07        0.0742      62954.        67626.
 9      6 152144.        1.07        0.0749     141003.       151568.
10      8  80033.        1.08        0.0759      74155.        79783.
# ℹ 5,174 more rows
# ℹ 13 more variables: food_2_dprice &lt;dbl&gt;, food_q2_sim &lt;dbl&gt;,
#   food_exp2_sim &lt;dbl&gt;, food1_CSloss &lt;dbl&gt;, food2_CSloss &lt;dbl&gt;,
#   ttl_CSloss_1 &lt;dbl&gt;, ttl_CSloss_2 &lt;dbl&gt;, food1_PPloss &lt;dbl&gt;,
#   food2_PPloss &lt;dbl&gt;, ttl_PPloss_1 &lt;dbl&gt;, ttl_PPloss_2 &lt;dbl&gt;,
#   totc_cc_avg_food1 &lt;dbl&gt;, totc_cc_avg_food2 &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Okay so now we estimate new welfare and poverty.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>ca_microsim_cc <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">aec_r_cc_avg_food1 =</span> totc_cc_avg_food1 <span class="sc">/</span> ae_r <span class="sc">/</span> PI,</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">aec_r_cc_avg_food2 =</span> totc_cc_avg_food2 <span class="sc">/</span> ae_r <span class="sc">/</span> PI) <span class="sc">%&gt;%</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">poor_cc_avg_food1 =</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>           <span class="fu">if_else</span>(aec_r_cc_avg_food1 <span class="sc">&lt;</span> <span class="dv">52883</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">poor_cc_avg_food2 =</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>           <span class="fu">if_else</span>(aec_r_cc_avg_food2 <span class="sc">&lt;</span> <span class="dv">52883</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now we see who became poor</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We make a table to see who became poor. </span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> ca_microsim_cc</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>ones <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test<span class="sc">%&gt;%</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">poor_original =</span> poor_Avpovln2022,</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">poor_cc =</span> poor_cc_avg,</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">poor_cc_food1 =</span> poor_cc_avg_food1,</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">poor_cc_food2 =</span> poor_cc_avg_food2) <span class="sc">%&gt;%</span></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(poor_original, poor_cc) <span class="sc">%&gt;%</span> </span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">no_hh =</span> <span class="fu">round</span>(<span class="fu">sum</span>(weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">no_pp =</span> <span class="fu">round</span>(<span class="fu">sum</span>(weight<span class="sc">*</span>hhsize, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'poor_original'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>test <span class="sc">%&gt;%</span> </span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="qlcgvumjcy" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#qlcgvumjcy table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#qlcgvumjcy thead, #qlcgvumjcy tbody, #qlcgvumjcy tfoot, #qlcgvumjcy tr, #qlcgvumjcy td, #qlcgvumjcy th {
  border-style: none;
}

#qlcgvumjcy p {
  margin: 0;
  padding: 0;
}

#qlcgvumjcy .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#qlcgvumjcy .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#qlcgvumjcy .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#qlcgvumjcy .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#qlcgvumjcy .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#qlcgvumjcy .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#qlcgvumjcy .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#qlcgvumjcy .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#qlcgvumjcy .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#qlcgvumjcy .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#qlcgvumjcy .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#qlcgvumjcy .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#qlcgvumjcy .gt_spanner_row {
  border-bottom-style: hidden;
}

#qlcgvumjcy .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#qlcgvumjcy .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#qlcgvumjcy .gt_from_md > :first-child {
  margin-top: 0;
}

#qlcgvumjcy .gt_from_md > :last-child {
  margin-bottom: 0;
}

#qlcgvumjcy .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#qlcgvumjcy .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#qlcgvumjcy .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#qlcgvumjcy .gt_row_group_first td {
  border-top-width: 2px;
}

#qlcgvumjcy .gt_row_group_first th {
  border-top-width: 2px;
}

#qlcgvumjcy .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#qlcgvumjcy .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#qlcgvumjcy .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#qlcgvumjcy .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#qlcgvumjcy .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#qlcgvumjcy .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#qlcgvumjcy .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#qlcgvumjcy .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#qlcgvumjcy .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#qlcgvumjcy .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#qlcgvumjcy .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#qlcgvumjcy .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#qlcgvumjcy .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#qlcgvumjcy .gt_left {
  text-align: left;
}

#qlcgvumjcy .gt_center {
  text-align: center;
}

#qlcgvumjcy .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#qlcgvumjcy .gt_font_normal {
  font-weight: normal;
}

#qlcgvumjcy .gt_font_bold {
  font-weight: bold;
}

#qlcgvumjcy .gt_font_italic {
  font-style: italic;
}

#qlcgvumjcy .gt_super {
  font-size: 65%;
}

#qlcgvumjcy .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#qlcgvumjcy .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#qlcgvumjcy .gt_indent_1 {
  text-indent: 5px;
}

#qlcgvumjcy .gt_indent_2 {
  text-indent: 10px;
}

#qlcgvumjcy .gt_indent_3 {
  text-indent: 15px;
}

#qlcgvumjcy .gt_indent_4 {
  text-indent: 20px;
}

#qlcgvumjcy .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="poor_cc" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">poor_cc</th>
<th id="no_hh" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">no_hh</th>
<th id="no_pp" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">no_pp</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd gt_group_heading_row">
<td colspan="3" id="0" class="gt_group_heading" data-quarto-table-cell-role="th" scope="colgroup">0</td>
</tr>
<tr class="even gt_row_group_first">
<td class="gt_row gt_right" headers="0  poor_cc">0</td>
<td class="gt_row gt_right" headers="0  no_hh">635512</td>
<td class="gt_row gt_right" headers="0  no_pp">2102222</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="0  poor_cc">1</td>
<td class="gt_row gt_right" headers="0  no_hh">6156</td>
<td class="gt_row gt_right" headers="0  no_pp">33962</td>
</tr>
<tr class="even gt_group_heading_row">
<td colspan="3" id="1" class="gt_group_heading" data-quarto-table-cell-role="th" scope="colgroup">1</td>
</tr>
<tr class="odd gt_row_group_first">
<td class="gt_row gt_right" headers="1  poor_cc">1</td>
<td class="gt_row gt_right" headers="1  no_hh">139892</td>
<td class="gt_row gt_right" headers="1  no_pp">697806</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co">#write.table(test, "clipboard", sep="\t", row.names=FALSE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we map these results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>foodpoor <span class="ot">&lt;-</span> ca_microsim_cc <span class="sc">%&gt;%</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">new_poor_food_base =</span> <span class="fu">if_else</span>(</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    poor_cc_avg_food2 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> poor_cc_avg <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">new_poor_food_dryhot =</span> <span class="fu">if_else</span>(</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>           poor_cc_avg_food1 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> poor_cc_avg <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">NAM_1 =</span> <span class="fu">as_factor</span>(marz)) <span class="sc">%&gt;%</span> </span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">NAM_1 =</span> <span class="fu">if_else</span>(NAM_1 <span class="sc">==</span> <span class="st">"VayotsDzor"</span>, <span class="st">"Vayots Dzor"</span>, NAM_1)) <span class="sc">%&gt;%</span> </span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">NAM_1 =</span> <span class="fu">if_else</span>(NAM_1 <span class="sc">==</span> <span class="st">"Sjunik"</span>, <span class="st">"Syunik"</span>, NAM_1)) <span class="sc">%&gt;%</span> </span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(NAM_1, poor_Avpovln2022, poor_cc_avg, poor_cc_max,</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>         poor_cc_avg_food1, poor_cc_avg_food2, new_poor_food_base,</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>         new_poor_food_dryhot, weight, hhsize)</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>fp <span class="ot">&lt;-</span>foodpoor <span class="sc">%&gt;%</span> </span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(NAM_1) <span class="sc">%&gt;%</span> </span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">new_poor =</span> <span class="fu">round</span>(<span class="fu">sum</span>(new_poor_food_dryhot <span class="sc">*</span> weight<span class="sc">*</span>hhsize, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">paste0</span>(NAM_1,<span class="st">" ("</span>, new_poor, <span class="st">")"</span>))</span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a><span class="co">#write.table(fp, "clipboard", sep="\t", row.names=FALSE)</span></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>fp_map <span class="ot">&lt;-</span> adm1 <span class="sc">|&gt;</span> </span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fp, <span class="fu">join_by</span>(NAM_1 <span class="sc">==</span> NAM_1))</span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>fp_map <span class="ot">&lt;-</span><span class="fu">tm_shape</span>(fp_map)<span class="sc">+</span></span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="st">"new_poor"</span>, <span class="at">legend.show =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_text</span>(<span class="st">"label"</span>, <span class="at">size =</span> .<span class="dv">7</span>, <span class="at">col =</span> <span class="st">"black"</span>)<span class="sc">+</span></span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"top"</span>), </span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">title=</span> <span class="st">"Additional Poor Dry-Hot Scenario"</span>, </span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">title.position =</span> <span class="fu">c</span>(<span class="st">'left'</span>, <span class="st">'bottom'</span>),</span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true" tabindex="-1"></a>            <span class="at">title.size =</span> <span class="fl">0.9</span>)</span>
<span id="cb117-30"><a href="#cb117-30" aria-hidden="true" tabindex="-1"></a>fp_map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="microsimulation_files/figure-html/unnamed-chunk-78-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We check that our reweighting was successful</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>table <span class="ot">&lt;-</span> pp_microsim_cc <span class="sc">%&gt;%</span> </span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lmarket,sector_w) <span class="sc">%&gt;%</span> </span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_pp =</span> <span class="fu">sum</span>(weightvec, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'lmarket'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>table <span class="sc">%&gt;%</span> </span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> total_pp, <span class="at">decimals =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="bpysodrvzy" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#bpysodrvzy table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#bpysodrvzy thead, #bpysodrvzy tbody, #bpysodrvzy tfoot, #bpysodrvzy tr, #bpysodrvzy td, #bpysodrvzy th {
  border-style: none;
}

#bpysodrvzy p {
  margin: 0;
  padding: 0;
}

#bpysodrvzy .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#bpysodrvzy .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#bpysodrvzy .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#bpysodrvzy .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#bpysodrvzy .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bpysodrvzy .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bpysodrvzy .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bpysodrvzy .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#bpysodrvzy .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#bpysodrvzy .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#bpysodrvzy .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#bpysodrvzy .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#bpysodrvzy .gt_spanner_row {
  border-bottom-style: hidden;
}

#bpysodrvzy .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#bpysodrvzy .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#bpysodrvzy .gt_from_md > :first-child {
  margin-top: 0;
}

#bpysodrvzy .gt_from_md > :last-child {
  margin-bottom: 0;
}

#bpysodrvzy .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#bpysodrvzy .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#bpysodrvzy .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#bpysodrvzy .gt_row_group_first td {
  border-top-width: 2px;
}

#bpysodrvzy .gt_row_group_first th {
  border-top-width: 2px;
}

#bpysodrvzy .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bpysodrvzy .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#bpysodrvzy .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#bpysodrvzy .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bpysodrvzy .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bpysodrvzy .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#bpysodrvzy .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#bpysodrvzy .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#bpysodrvzy .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bpysodrvzy .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bpysodrvzy .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#bpysodrvzy .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bpysodrvzy .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#bpysodrvzy .gt_left {
  text-align: left;
}

#bpysodrvzy .gt_center {
  text-align: center;
}

#bpysodrvzy .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#bpysodrvzy .gt_font_normal {
  font-weight: normal;
}

#bpysodrvzy .gt_font_bold {
  font-weight: bold;
}

#bpysodrvzy .gt_font_italic {
  font-style: italic;
}

#bpysodrvzy .gt_super {
  font-size: 65%;
}

#bpysodrvzy .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#bpysodrvzy .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#bpysodrvzy .gt_indent_1 {
  text-indent: 5px;
}

#bpysodrvzy .gt_indent_2 {
  text-indent: 10px;
}

#bpysodrvzy .gt_indent_3 {
  text-indent: 15px;
}

#bpysodrvzy .gt_indent_4 {
  text-indent: 20px;
}

#bpysodrvzy .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="lmarket" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">lmarket</th>
<th id="sector_w" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">sector_w</th>
<th id="total_pp" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">total_pp</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_right" headers="lmarket">1</td>
<td class="gt_row gt_right" headers="sector_w">1</td>
<td class="gt_row gt_right" headers="total_pp">380,038</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="lmarket">2</td>
<td class="gt_row gt_right" headers="sector_w">2</td>
<td class="gt_row gt_right" headers="total_pp">139,999</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="lmarket">3</td>
<td class="gt_row gt_right" headers="sector_w">3</td>
<td class="gt_row gt_right" headers="total_pp">739,955</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="lmarket">4</td>
<td class="gt_row gt_right" headers="sector_w">NA</td>
<td class="gt_row gt_right" headers="total_pp">700,562</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="lmarket">5</td>
<td class="gt_row gt_right" headers="sector_w">NA</td>
<td class="gt_row gt_right" headers="total_pp">873,436</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  table, </span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"clipboard"</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">row.names=</span><span class="cn">FALSE</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="end" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="end"><span class="header-section-number">9</span> End</h2>
<p>Tasks for today:</p>
<p>Reweight the dataset</p>
<ul>
<li>Determine the numbers for the labor market reweighting for 2030. [v]</li>
<li>Reweight and rescale the weights. [v]</li>
<li>Determine by how much to rescale the wage bill. [v]</li>
<li>Recalculate labor income. [v]</li>
<li>Recalculate total income. [v]</li>
<li>Determine delta total income and change total expenditure. [v]</li>
<li>Poverty [v]</li>
</ul>
<p>Review price elasticities</p>
<ul>
<li>Look for average prices in underlying data.</li>
<li>Reestimate based on adjusted food expenditure by family members.</li>
<li>Rerun elasticities.</li>
<li>Reestimate poverty.</li>
</ul>
<p>Bring back poverty to people’s dataset.</p>
<ul>
<li>Evaluate poverty among women.</li>
<li>Poverty among urban rural.</li>
<li>Poverty by marz.</li>
<li>Youth?</li>
</ul>
<p>Write draft.</p>
<ul>
<li>Make tables of everything.</li>
<li>Make maps of everything.</li>
</ul>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-armstat_integrated_2023" class="csl-entry" role="listitem">
ARMSTAT. (2023). <em>Integrated <span>Living</span> <span>Conditions</span> <span>Survey</span> 2022</em>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/rvconsulting/armenia-ccdr/edit/master/supporting-materials/microsimulation.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/rvconsulting/armenia-ccdr/issues" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>