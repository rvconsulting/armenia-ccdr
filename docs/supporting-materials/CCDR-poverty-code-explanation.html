<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stata Code: Juan Manuel Monroy, Ercio Muñoz. Interpreted by Renato Vargas">

<title>Armenia CCDR - A guide to CCDR Poverty Analysis code</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Armenia CCDR</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../supporting-materials/CCDR-poverty-code-explanation.html">Supporting materials</a></li><li class="breadcrumb-item"><a href="../supporting-materials/CCDR-poverty-code-explanation.html">A guide to CCDR Poverty Analysis code</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Background notes</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../bg-notes/hh-assets-and-fuelwood-use.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Household Assets and Fuelwood Use</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../bg-notes/vulnerability-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vulnerability analysis</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Supporting materials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../supporting-materials/CCDR-poverty-code-explanation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">A guide to CCDR Poverty Analysis code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../supporting-materials/vulnerability-hh-level-impacts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vulnerability Analysis Calculations</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#master-file" id="toc-master-file" class="nav-link active" data-scroll-target="#master-file"><span class="header-section-number">1</span> Master file</a></li>
  <li><a href="#data-preparation-file" id="toc-data-preparation-file" class="nav-link" data-scroll-target="#data-preparation-file"><span class="header-section-number">2</span> Data Preparation file</a>
  <ul class="collapse">
  <li><a href="#program-setup" id="toc-program-setup" class="nav-link" data-scroll-target="#program-setup"><span class="header-section-number">2.1</span> Program setup</a></li>
  <li><a href="#hh-consumption-aggregates-and-characteristics" id="toc-hh-consumption-aggregates-and-characteristics" class="nav-link" data-scroll-target="#hh-consumption-aggregates-and-characteristics"><span class="header-section-number">2.2</span> HH consumption aggregates and characteristics</a></li>
  <li><a href="#demographic-characteristics" id="toc-demographic-characteristics" class="nav-link" data-scroll-target="#demographic-characteristics"><span class="header-section-number">2.3</span> Demographic characteristics</a></li>
  <li><a href="#years-of-education" id="toc-years-of-education" class="nav-link" data-scroll-target="#years-of-education"><span class="header-section-number">2.4</span> Years of education</a></li>
  <li><a href="#non-labor-income" id="toc-non-labor-income" class="nav-link" data-scroll-target="#non-labor-income"><span class="header-section-number">2.5</span> Non labor income</a>
  <ul class="collapse">
  <li><a href="#pensions-rents-and-dividends" id="toc-pensions-rents-and-dividends" class="nav-link" data-scroll-target="#pensions-rents-and-dividends"><span class="header-section-number">2.5.1</span> Pensions, rents, and dividends</a></li>
  <li><a href="#individual-transfers" id="toc-individual-transfers" class="nav-link" data-scroll-target="#individual-transfers"><span class="header-section-number">2.5.2</span> Individual transfers</a></li>
  <li><a href="#public-transfers" id="toc-public-transfers" class="nav-link" data-scroll-target="#public-transfers"><span class="header-section-number">2.5.3</span> Public Transfers</a></li>
  </ul></li>
  <li><a href="#labor-market-variables" id="toc-labor-market-variables" class="nav-link" data-scroll-target="#labor-market-variables"><span class="header-section-number">2.6</span> Labor market variables</a>
  <ul class="collapse">
  <li><a href="#labor-force-status" id="toc-labor-force-status" class="nav-link" data-scroll-target="#labor-force-status"><span class="header-section-number">2.6.1</span> Labor Force Status:</a></li>
  <li><a href="#employed-population-and-salaried-status" id="toc-employed-population-and-salaried-status" class="nav-link" data-scroll-target="#employed-population-and-salaried-status"><span class="header-section-number">2.6.2</span> Employed Population and Salaried Status:</a></li>
  <li><a href="#labor-income-computations" id="toc-labor-income-computations" class="nav-link" data-scroll-target="#labor-income-computations"><span class="header-section-number">2.6.3</span> Labor Income Computations:</a></li>
  <li><a href="#treatment-of-missing-data-and-outliers" id="toc-treatment-of-missing-data-and-outliers" class="nav-link" data-scroll-target="#treatment-of-missing-data-and-outliers"><span class="header-section-number">2.6.4</span> Treatment of Missing Data and Outliers:</a></li>
  <li><a href="#merge-with-demographic-characteristics" id="toc-merge-with-demographic-characteristics" class="nav-link" data-scroll-target="#merge-with-demographic-characteristics"><span class="header-section-number">2.6.5</span> Merge with Demographic Characteristics:</a></li>
  <li><a href="#sector-categorization" id="toc-sector-categorization" class="nav-link" data-scroll-target="#sector-categorization"><span class="header-section-number">2.6.6</span> Sector Categorization:</a></li>
  </ul></li>
  <li><a href="#model-for-predicting-labor-income" id="toc-model-for-predicting-labor-income" class="nav-link" data-scroll-target="#model-for-predicting-labor-income"><span class="header-section-number">2.7</span> Model for Predicting Labor Income:</a></li>
  <li><a href="#shares-and-total-income-to-the-model" id="toc-shares-and-total-income-to-the-model" class="nav-link" data-scroll-target="#shares-and-total-income-to-the-model"><span class="header-section-number">2.8</span> Shares and total income to the model</a></li>
  <li><a href="#final-datasets" id="toc-final-datasets" class="nav-link" data-scroll-target="#final-datasets"><span class="header-section-number">2.9</span> Final datasets</a></li>
  </ul></li>
  <li><a href="#creation-of-inputs-for-microsimulation" id="toc-creation-of-inputs-for-microsimulation" class="nav-link" data-scroll-target="#creation-of-inputs-for-microsimulation"><span class="header-section-number">3</span> Creation of inputs for microsimulation</a>
  <ul class="collapse">
  <li><a href="#import-population-data-to-be-used-in-the-creation-of-globals" id="toc-import-population-data-to-be-used-in-the-creation-of-globals" class="nav-link" data-scroll-target="#import-population-data-to-be-used-in-the-creation-of-globals"><span class="header-section-number">3.1</span> Import population data to be used in the creation of globals</a></li>
  <li><a href="#import-data-from-the-excel-file-received-from-macroeconomic-modelers" id="toc-import-data-from-the-excel-file-received-from-macroeconomic-modelers" class="nav-link" data-scroll-target="#import-data-from-the-excel-file-received-from-macroeconomic-modelers"><span class="header-section-number">3.2</span> Import data from the excel file received from macroeconomic modelers</a></li>
  <li><a href="#creating-globals-by-yearscenario-to-be-used-later-in-the-microsimulation" id="toc-creating-globals-by-yearscenario-to-be-used-later-in-the-microsimulation" class="nav-link" data-scroll-target="#creating-globals-by-yearscenario-to-be-used-later-in-the-microsimulation"><span class="header-section-number">3.3</span> Creating globals by year/scenario to be used later in the microsimulation</a></li>
  </ul></li>
  <li><a href="#reweighting-using-education-projections-un-age-projections-and-sectoral-shares-from-mfmod" id="toc-reweighting-using-education-projections-un-age-projections-and-sectoral-shares-from-mfmod" class="nav-link" data-scroll-target="#reweighting-using-education-projections-un-age-projections-and-sectoral-shares-from-mfmod"><span class="header-section-number">4</span> Reweighting using education projections, UN age projections and sectoral shares from MFMOD</a>
  <ul class="collapse">
  <li><a href="#define-key-variables-and-globalsrates" id="toc-define-key-variables-and-globalsrates" class="nav-link" data-scroll-target="#define-key-variables-and-globalsrates"><span class="header-section-number">4.1</span> Define key variables and globals/rates</a></li>
  <li><a href="#main-reweighting-command" id="toc-main-reweighting-command" class="nav-link" data-scroll-target="#main-reweighting-command"><span class="header-section-number">4.2</span> Main reweighting command</a></li>
  <li><a href="#wage-bill-at-baseline" id="toc-wage-bill-at-baseline" class="nav-link" data-scroll-target="#wage-bill-at-baseline"><span class="header-section-number">4.3</span> Wage bill at baseline</a></li>
  <li><a href="#wage-bill-at-simulated-yearscenario" id="toc-wage-bill-at-simulated-yearscenario" class="nav-link" data-scroll-target="#wage-bill-at-simulated-yearscenario"><span class="header-section-number">4.4</span> Wage bill at simulated year/scenario</a></li>
  <li><a href="#re-center-and-simulated-welfare-aggregate" id="toc-re-center-and-simulated-welfare-aggregate" class="nav-link" data-scroll-target="#re-center-and-simulated-welfare-aggregate"><span class="header-section-number">4.5</span> Re-center and simulated welfare aggregate</a></li>
  <li><a href="#adjusting-the-consumption-according-to-the-projection" id="toc-adjusting-the-consumption-according-to-the-projection" class="nav-link" data-scroll-target="#adjusting-the-consumption-according-to-the-projection"><span class="header-section-number">4.6</span> Adjusting the consumption according to the projection</a></li>
  </ul></li>
  <li><a href="#generating-indicators" id="toc-generating-indicators" class="nav-link" data-scroll-target="#generating-indicators"><span class="header-section-number">5</span> Generating indicators</a>
  <ul class="collapse">
  <li><a href="#poverty-statistics-by-regions-urbanrural-and-gender" id="toc-poverty-statistics-by-regions-urbanrural-and-gender" class="nav-link" data-scroll-target="#poverty-statistics-by-regions-urbanrural-and-gender"><span class="header-section-number">5.1</span> Poverty statistics by regions, urban/rural, and gender</a></li>
  <li><a href="#compute-deviations" id="toc-compute-deviations" class="nav-link" data-scroll-target="#compute-deviations"><span class="header-section-number">5.2</span> Compute deviations</a></li>
  <li><a href="#generating-deviations-from-baseline" id="toc-generating-deviations-from-baseline" class="nav-link" data-scroll-target="#generating-deviations-from-baseline"><span class="header-section-number">5.3</span> Generating Deviations from Baseline:</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="CCDR-poverty-code-explanation.docx"><i class="bi bi-file-word"></i>MS Word</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../supporting-materials/CCDR-poverty-code-explanation.html">Supporting materials</a></li><li class="breadcrumb-item"><a href="../supporting-materials/CCDR-poverty-code-explanation.html">A guide to CCDR Poverty Analysis code</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">A guide to CCDR Poverty Analysis code</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Stata Code: Juan Manuel Monroy, Ercio Muñoz.<br>
Interpreted by Renato Vargas </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="master-file" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Master file</h1>
<p><strong>Filename:</strong> 01_Master.do</p>
<p>The master file explains the structured workflow:</p>
<ol type="1">
<li><p><strong>Setup and Preprocessing</strong>: The initial segments define the working environment, set the necessary paths, and import necessary libraries or tools. The globals defined will help in driving the subsequent operations.</p></li>
<li><p><strong>Macro Inputs &amp; Creation of Globals</strong>: Fetches macro inputs from an Excel file and dynamically define some global variables. There are placeholder comments suggesting an alternate approach to fetch scenarios and years, which might have been used in earlier iterations or for debugging purposes.</p></li>
<li><p><strong>MFmod Microsimulation</strong>: Run a microsimulation model to generate simulated weights and welfare aggregate measures.</p></li>
<li><p><strong>Indicator Generation</strong>: Using the simulated data, compute various indicators. These are poverty rates, income measures, and other socio-economic indicators.</p></li>
<li><p><strong>Opening the Excel Scenario File</strong>: Lastly, the main workflow ends by opening an Excel file to inspect or use the scenarios and results interactively.</p></li>
</ol>
</section>
<section id="data-preparation-file" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Data Preparation file</h1>
<p><strong>Filename:</strong> 00_dataprep.do</p>
<section id="program-setup" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="program-setup"><span class="header-section-number">2.1</span> Program setup</h2>
<p>This sets the minimum required Stata version to run the code to 15.1. We also perform some housekeeping:</p>
<ul>
<li><code>drop _all</code> removes all variables from the dataset in memory.</li>
<li><code>clear all</code> removes all data from memory.</li>
<li><code>set more off</code> turns off the ‘more’ feature, which pauses output at the screen every time it’s filled.</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">version</span> 15.1</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="dt">_all</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span> <span class="ot">all</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="kw">more</span> <span class="kw">off</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Checks if the current Stata user’s name is <code>"wb527706"</code>. If it is, it sets the global macro <code>path</code> to the specified directory. This tailors the code to a specific user’s directory structure.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="st">"`c(username)'"</span>==<span class="st">"wb527706"</span> {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> path <span class="st">"C:\Users\WB527706\OneDrive - WBG\Madagascar"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The next lines set up a series of global macros with directory paths based on the earlier-defined <code>path</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> HHsurvey    = <span class="st">"$path\data"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> inputs      = <span class="st">"$path/inputs"</span>    </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> outputs     = <span class="st">"$path/outputs"</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> MAGclimsim    <span class="st">"$path\MagClimSim.xlsx"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="hh-consumption-aggregates-and-characteristics" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="hh-consumption-aggregates-and-characteristics"><span class="header-section-number">2.2</span> HH consumption aggregates and characteristics</h2>
<p>This loads a dataset from the specified directory, which was previously defined in the global macro <code>HHsurvey</code>. The <code>clear</code> option ensures that any current data in memory is replaced. Note that we don’t have access to that survey.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="st">"$HHsurvey\outputdata\ca_real_pl.dta"</span>, <span class="kw">clear</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here, a new variable <code>rural</code> is created, which is equal to 1 if the area is “Rural” and 0 if the area is “Urbain”.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span>     rural   = 1     <span class="kw">if</span>  area==<span class="st">"Rural"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> rural   = 0     <span class="kw">if</span>  area==<span class="st">"Urbain"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The variable <code>pcer</code> is renamed to <code>pcc</code> (indicating per capita expenditure).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ren</span> pcer pcc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A new variable <code>yhh</code> is created by multiplying <code>pcc</code> (per capita expenditure) by <code>hhsize</code> (household size).</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> yhh=pcc*hhsize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These lines rename the variables: <code>wgt</code> becomes <code>wgt0</code> and <code>wgt_adj</code> becomes <code>wgt</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ren</span> wgt wgt0 </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ren</span> wgt_adj wgt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This line keeps only the listed variables in the dataset, dropping all others.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span>  hhid rural hhsize region pcc yhh wgt yhh <span class="co">// </span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>      pline215 pline365 pline685 ubpl lbpl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A temporary file named <code>HHcha</code> is specified, and the current dataset is saved to that file.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">tempfile</span> HHcha</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="ot">`HHcha'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So far:</p>
<ol type="1">
<li>Sets up paths tailored to the user’s directory structure.</li>
<li>Loads a specific dataset related to household consumption aggregates and characteristics.</li>
<li>Manipulates and keeps only select variables of interest.</li>
<li>Saves the modified data to a temporary file for later use.</li>
</ol>
</section>
<section id="demographic-characteristics" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="demographic-characteristics"><span class="header-section-number">2.3</span> Demographic characteristics</h2>
<p>This line loads a dataset related to demographic characteristics from the directory specified by the global macro <code>HHsurvey</code>, replacing data in memory.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="st">"$HHsurvey\outputdata\S01_DEMO_01.dta"</span>, <span class="kw">clear</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here, a new variable <code>hhgrap</code> is created, identical to the <code>cluster</code> variable. The dataset in memory is then merged with the <code>DéfinitionsQuatreMilieux.dta</code> dataset based on the <code>hhgrap</code> variable. The resulting <code>_merge</code> variable (indicating merge success for each observation) is dropped as customary.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> hhgrap = <span class="kw">cluster</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> n:1 hhgrap <span class="kw">using</span> <span class="st">"$HHsurvey\outputdata\DéfinitionsQuatreMilieux.dta"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="dt">_merge</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The variable <code>MILIEU4</code> is renamed to <code>zone</code> and the variable <code>sex</code> is renamed to <code>gender</code>. A new binary variable <code>head</code> is created, which takes a value of 1 when <code>relhead</code> equals 1 (presumably indicating that the individual is the head of the household) and 0 otherwise. The variable <code>relhead</code> is renamed to <code>rel</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ren</span> MILIEU4 zone</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ren</span> sex gender</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="fu">head</span> = relhead == 1</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ren</span> relhead rel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Only the specified variables are retained, and all other variables are dropped.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> hhid pid gender age <span class="fu">head</span> rel zone</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The dataset in memory is saved to a temporary file named <code>demo</code>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">tempfile</span> demo</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="ot">`demo'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="years-of-education" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="years-of-education"><span class="header-section-number">2.4</span> Years of education</h2>
<p>A new dataset related to education is loaded, replacing the current dataset in memory. Note that we don’t have access to that one.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="st">"$HHsurvey\inputdata\EPM21\S02_EDUC.dta"</span>, <span class="kw">clear</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A new variable <code>yos</code> (probably standing for the availability of “years of schooling”) is created based on the variable <code>q2_26</code>. However, its value is set to 0 wherever the variable <code>q2_01</code> is not equal to 1. Note that the consultant made a code annotation explicitly sayin that it is NOT “years of schooling”. Then the variable <code>yos</code> is renamed to <code>educy</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> yos = q2_26</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> yos=0 <span class="kw">if</span> q2_01 != 1</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">rename</span> yos educy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The data is sorted by <code>hhgrap</code> and <code>hhnum</code>. Then, a new variable <code>hhid</code> is created by concatenating <code>hhgrap</code> and <code>hhnum</code>, presumably to create a unique household ID. The variables <code>hhgrap</code> and <code>q2_0x</code> are then renamed to <code>cluster</code> and <code>pid</code>, respectively.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> hhgrap hhnum</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">egen</span> hhid = <span class="fu">concat</span>(hhgrap hhnum), <span class="kw">format</span>(%9.0g) <span class="fu">punct</span>(<span class="st">","</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="kw">rename</span> hhgrap <span class="kw">cluster</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="kw">rename</span> q2_0x pid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Only the specified variables are retained, and all others are dropped. The dataset in memory is saved to a temporary file named <code>edu</code>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> hhid pid educy</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">tempfile</span> edu</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="ot">`edu'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To summarize, this code segment:</p>
<ol type="1">
<li>Loads a dataset related to demographic characteristics.</li>
<li>Merges it with another dataset to enhance the information.</li>
<li>Makes some modifications to the variable names and keeps relevant variables.</li>
<li>Saves the modified dataset to a temporary file.</li>
<li>Loads a new dataset related to years of education.</li>
<li>Makes transformations related to educational years and constructs a unique household ID.</li>
<li>Keeps the necessary variables and saves the modified dataset to another temporary file.</li>
</ol>
</section>
<section id="non-labor-income" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="non-labor-income"><span class="header-section-number">2.5</span> Non labor income</h2>
<section id="pensions-rents-and-dividends" class="level3" data-number="2.5.1">
<h3 data-number="2.5.1" class="anchored" data-anchor-id="pensions-rents-and-dividends"><span class="header-section-number">2.5.1</span> Pensions, rents, and dividends</h3>
<p>This section of code is focused on calculating and aggregating non-labor income. First, we have pensions, rents, dividends, and lotteries. The script loads a dataset related to various revenues.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="st">"$HHsurvey\inputdata\EPM21\S05_REVE.dta"</span>, <span class="kw">clear</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The next series of lines, as before, creates a unique household ID by concatenating <code>hhgrap</code> and <code>hhnum</code>, and then renames some variables.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span>    hhgrap hhnum</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">egen</span>    hhid =  <span class="fu">concat</span>(hhgrap hhnum), <span class="kw">format</span>(%9.0g) <span class="fu">punct</span>(<span class="st">","</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">rename</span>  hhgrap  <span class="kw">cluster</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="kw">rename</span>  q5_0x   pid </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For each type of income (pensions, rents, dividends, and occasional income like lottery winnings), the script creates a new variable only if another corresponding variable is set to 1 (probably indicating that the income source is relevant for that observation).</p>
<p><strong>Survey:</strong> Pension annual basis: <em>retrate/veuvage/dinvalidité/alimentaire.</em></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> nli_pen1=q5_02 <span class="kw">if</span> q5_01==1</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> nli_pen2=q5_04 <span class="kw">if</span> q5_03==1 </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> nli_pen3=q5_06 <span class="kw">if</span> q5_05==1 </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> nli_pen4=q5_08 <span class="kw">if</span> q5_07==1 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Survey:</strong> Rents.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> nli_rent=q5_10 <span class="kw">if</span> q5_09==1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Survey:</strong> Dividends.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> nli_div=q5_12 <span class="kw">if</span> q5_11==1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Survey:</strong> Lottery winnings, inheritance, sale of property, etc.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> nli_occ=q5_14 <span class="kw">if</span> q5_13==1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This line creates a new variable, <code>nli_prdo</code> (presumably non-labor income pensions, rents, dividents, other), that sums up the previously created income variables for each observation. The data is then collapsed (aggregated) by <code>hhid</code>, and saved into a temporary file.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">egen</span> nli_prdo=rsum(nli_pen1 nli_pen2 nli_pen3 nli_pen4 nli_rent nli_div nli_occ)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">collapse</span> (<span class="kw">sum</span>) nli_prdo ,<span class="kw">by</span>(hhid)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">tempfile</span> nli_prdo</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="ot">`nli_prdo'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="individual-transfers" class="level3" data-number="2.5.2">
<h3 data-number="2.5.2" class="anchored" data-anchor-id="individual-transfers"><span class="header-section-number">2.5.2</span> Individual transfers</h3>
<p>The next section focuses on individual transfers. It follows a similar structure: load data, create a unique household ID, create variables for different income sources (in this case, transfers), aggregate by household, and save to a temporary file.</p>
<p>The new variables (<code>nli_hhs1</code> and <code>nli_hhs2</code>) are generated based on conditions related to the frequency of the transfer (monthly, quarterly, etc.), and then aggregated into <code>nli_itrans</code>.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="st">"$HHsurvey\inputdata\EPM21\S13_TRAN_A.dta"</span>, <span class="kw">clear</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">//ID at HH and IND definition </span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span>    hhgrap hhnum</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="kw">egen</span>    hhid =  <span class="fu">concat</span>(hhgrap hhnum), <span class="kw">format</span>(%9.0g) <span class="fu">punct</span>(<span class="st">","</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="kw">rename</span>  hhgrap  <span class="kw">cluster</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span>      nli_hhs1=q13_18a*12     <span class="kw">if</span> q13_18b==1 &amp; (q13_01==1 | q13_02==1) </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  nli_hhs1=q13_18a*4      <span class="kw">if</span> q13_18b==2 &amp; (q13_01==1 | q13_02==1)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  nli_hhs1=q13_18a*2      <span class="kw">if</span> q13_18b==3 &amp; (q13_01==1 | q13_02==1)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  nli_hhs1=q13_18a        <span class="kw">if</span> q13_18b==4 &amp; (q13_01==1 | q13_02==1)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  nli_hhs1=q13_18a        <span class="kw">if</span> q13_18b==5 &amp; (q13_01==1 | q13_02==1)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span>     nli_hhs2=q13_21a*12      <span class="kw">if</span> q13_21b==1 &amp; (q13_01==1 | q13_02==1)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  nli_hhs2=q13_21a*4      <span class="kw">if</span> q13_21b==2 &amp; (q13_01==1 | q13_02==1)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  nli_hhs2=q13_21a*2      <span class="kw">if</span> q13_21b==3 &amp; (q13_01==1 | q13_02==1)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  nli_hhs2=q13_21a        <span class="kw">if</span> q13_21b==4 &amp; (q13_01==1 | q13_02==1)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  nli_hhs2=q13_21a        <span class="kw">if</span> q13_21b==5 &amp; (q13_01==1 | q13_02==1)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="kw">egen</span> nli_itrans=rsum(nli_hhs1 nli_hhs2)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="kw">collapse</span> (<span class="kw">sum</span>) nli_itrans ,<span class="kw">by</span>(hhid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Saved temporarily in:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">tempfile</span> nli_itrans</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="ot">`nli_itrans'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="public-transfers" class="level3" data-number="2.5.3">
<h3 data-number="2.5.3" class="anchored" data-anchor-id="public-transfers"><span class="header-section-number">2.5.3</span> Public Transfers</h3>
<p>This section deals with public transfers. The data handling is quite similar to the previous sections. The income from public transfers is calculated based on the frequency, aggregated by household, and saved into a temporary file <code>nli_gov</code>.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>u <span class="st">"$HHsurvey\inputdata\EPM21\S15_FILE.dta"</span>, <span class="kw">clear</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">//ID at HH and IND definition </span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span>    hhgrap hhnum</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="kw">egen</span>    hhid =  <span class="fu">concat</span>(hhgrap hhnum), <span class="kw">format</span>(%9.0g) <span class="fu">punct</span>(<span class="st">","</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="kw">rename</span>  hhgrap  <span class="kw">cluster</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>g        nli_gov=q15_10a*12     <span class="kw">if</span> q15_10b==1 &amp; (q15_02==1 ) </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  nli_gov=q15_10a*4      <span class="kw">if</span> q15_10b==2 &amp; (q15_02==1 )  </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  nli_gov=q15_10a*2      <span class="kw">if</span> q15_10b==3 &amp; (q15_02==1 ) </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  nli_gov=q15_10a        <span class="kw">if</span> q15_10b==4 &amp; (q15_02==1 )</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  nli_gov=q15_10a        <span class="kw">if</span> q15_10b==5 &amp; (q15_02==1 )    </span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="kw">collapse</span> (<span class="kw">sum</span>) nli_gov ,<span class="kw">by</span>(hhid)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="kw">tempfile</span> nli_gov</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="ot">`nli_gov'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The last piece of code merges the aggregated data from the three previous sections</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>u  <span class="ot">`nli_prdo'</span>, <span class="kw">clear</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:1 hhid <span class="kw">using</span> <span class="ot">`nli_itrans'</span> , nogen</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:1 hhid <span class="kw">using</span> <span class="ot">`nli_gov'</span> , nogen</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here, the script loads the data related to pensions, rents, dividends, etc., and then merges it with the data from individual and public transfers using <code>hhid</code> as the key variable.</p>
<p>A new variable, <code>nli_hh</code>, is created, which is the sum of all non-labor income sources for each household.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">egen</span> nli_hh=rsum(nli_prdo nli_gov nli_itrans)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, this aggregated data is saved into another temporary file.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">tempfile</span> nli</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="ot">`nli'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To summarize, this segment of the code:</p>
<ol type="1">
<li>Loads datasets related to various non-labor income sources: pensions, rents, dividends, individual transfers, and public transfers.</li>
<li>Processes each data source to calculate the total income for each type.</li>
<li>Merges the data from the various sources and aggregates the total non-labor income by household.</li>
<li>Saves the resulting dataset for future use.</li>
</ol>
</section>
</section>
<section id="labor-market-variables" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="labor-market-variables"><span class="header-section-number">2.6</span> Labor market variables</h2>
<p>A dataset related to employment is loaded into Stata.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>u <span class="st">"$HHsurvey\inputdata\EPM21\S04_EMPL_AI.dta"</span>, <span class="kw">clear</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The subsequent lines create a unique household ID by concatenating <code>hhgrap</code> and <code>hhnum</code>, and rename some variables. This pattern has been repeated from the previous chunks of code. The data is then merged with the non-labor income dataset (created in the previous section):</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span>    hhgrap hhnum</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">egen</span>    hhid =  <span class="fu">concat</span>(hhgrap hhnum), <span class="kw">format</span>(%9.0g) <span class="fu">punct</span>(<span class="st">","</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="kw">rename</span>  hhgrap  <span class="kw">cluster</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="kw">rename</span>  q4a_xx  pid</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Merge non-labor income part</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> n:1 hhid <span class="kw">using</span> <span class="ot">`nli'</span> , nogen</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="labor-force-status" class="level3" data-number="2.6.1">
<h3 data-number="2.6.1" class="anchored" data-anchor-id="labor-force-status"><span class="header-section-number">2.6.1</span> Labor Force Status:</h3>
<p>The variable <code>lstatus</code> is created based on different responses to the employment-related questions. This variable categorizes individuals into employed, unemployed and seeking work, unemployed but not seeking work, or outside the labor force (OLF).</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">//employed</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>g lstatus = 1 <span class="kw">if</span>  q4a_01==1 | q4a_02==1 | q4a_03==1 | <span class="co">//</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                  q4a_04==1 | q4a_09&lt;4</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Unemployed - available and searching </span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> lstatus = 2  <span class="kw">if</span> q4a_96==1 </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Unemployed - available, but not searching</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> lstatus = 3  <span class="kw">if</span> q4a_96==2   </span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co">//OLF</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> lstatus = 4  <span class="kw">if</span> <span class="fu">missing</span>(lstatus) </span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>lab <span class="kw">var</span> lstatus <span class="st">"Labor force status"</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>lab def lstatus_lab 1 <span class="st">"employed"</span> 2 <span class="st">"unemployed - seeking"</span> <span class="co">//</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>                    3 <span class="st">"unemployed - not-seeking"</span> 4 <span class="st">"OLF"</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>lab val lstatus lstatus_lab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="employed-population-and-salaried-status" class="level3" data-number="2.6.2">
<h3 data-number="2.6.2" class="anchored" data-anchor-id="employed-population-and-salaried-status"><span class="header-section-number">2.6.2</span> Employed Population and Salaried Status:</h3>
<p>The code identifies which individuals are employed (<code>employed</code> variable) and then aggregates this at the household level. It then determines if employed individuals are salaried or self-employed.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> employed = lstatus==1</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="kw">bysort</span> hhid : <span class="kw">egen</span> employed_hh=<span class="fu">max</span>(employed)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> salaried = .</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> salaried = 1 <span class="kw">if</span> q4a_24 ==1</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co">// self-employed if employed and salary is missing.</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> salaried = 0 <span class="kw">if</span> <span class="fu">mi</span>(salaried) &amp; employed==1 </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>lab <span class="kw">var</span> salaried <span class="st">"Employment status"</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>lab def salaried 1 <span class="st">"paid employee"</span> 0 <span class="st">"self-employed"</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>lab val salaried salaried</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="labor-income-computations" class="level3" data-number="2.6.3">
<h3 data-number="2.6.3" class="anchored" data-anchor-id="labor-income-computations"><span class="header-section-number">2.6.3</span> Labor Income Computations:</h3>
<p>The subsequent part of the code calculates labor income (<code>lab_pri</code>) based on different frequencies of payment (daily, weekly, monthly, etc.). Similar calculations are done for bonuses (<code>lab_ikb</code>), other in-kind incomes (<code>lab_iko</code>, <code>lab_ikf</code>), and incomes from a second job (<code>lab_sec</code>, <code>lab_sik</code>, <code>lab_sit</code>, <code>lab_sif</code>). The total labor income is then aggregated into <code>lab_tot</code>.</p>
<p><strong>Survey:</strong> <em>What was [NAME]’s salary for this job (for the time period considered)?</em></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>g        lab_pri= q4a_46a*365               <span class="kw">if</span> q4a_46b==1  </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_pri= q4a_46a*(365/7)*(1)       <span class="kw">if</span> q4a_46b==2</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_pri= q4a_46a*12                <span class="kw">if</span> q4a_46b==3</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_pri= q4a_46a                   <span class="kw">if</span> q4a_46b==4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Survey:</strong> In-kind bonus. <em>A combien évaluez-vous les primes ( uniquement ceux qui ne sont pas inclus dans le salaire)?</em></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>g        lab_ikb= q4a_48a*365               <span class="kw">if</span> q4a_48b==1  </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_ikb= q4a_48a*(365/7)*(1)       <span class="kw">if</span> q4a_48b==2</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_ikb= q4a_48a*12                <span class="kw">if</span> q4a_48b==3</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_ikb= q4a_48a                   <span class="kw">if</span> q4a_48b==4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Survey:</strong> Other inkind. <em>A combien évaluez-vous ces avantages ( uniquement ceux qui ne sont pas inclus dans le salaire)?</em></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>g        lab_iko= q4a_50a*365               <span class="kw">if</span> q4a_50b==1  </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_iko= q4a_50a*(365/7)*(1)       <span class="kw">if</span> q4a_50b==2</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_iko= q4a_50a*12                <span class="kw">if</span> q4a_50b==3</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_iko= q4a_50a                   <span class="kw">if</span> q4a_50b==4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Survey:</strong> Food from the job.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>g        lab_ikf= q4a_52a*365               <span class="kw">if</span> q4a_52b==1  </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_ikf= q4a_52a*(365/7)*(1)       <span class="kw">if</span> q4a_52b==2</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_ikf= q4a_52a*12                      <span class="kw">if</span> q4a_52b==3</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_ikf= q4a_52a                   <span class="kw">if</span> q4a_52b==4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Survey:</strong> Second activity labor income.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>g        lab_sec= q4a_62a*365               <span class="kw">if</span> q4a_62b==1  </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_sec= q4a_62a*(365/7)*(1)       <span class="kw">if</span> q4a_62b==2</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_sec= q4a_62a*12                <span class="kw">if</span> q4a_62b==3</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_sec= q4a_62a                   <span class="kw">if</span> q4a_62b==4   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Survey:</strong> In-kind second bonus.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>g        lab_sik= q4a_64a*365               <span class="kw">if</span> q4a_64b==1  </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_sik= q4a_64a*(365/7)*(1)       <span class="kw">if</span> q4a_64b==2</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_sik= q4a_64a*12                <span class="kw">if</span> q4a_64b==3</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_sik= q4a_64a                   <span class="kw">if</span> q4a_64b==4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Survey:</strong> Other in-kind, such as transport.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>g        lab_sit= q4a_66a*365               <span class="kw">if</span> q4a_66b==1  </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_sit= q4a_66a*(365/7)*(1)       <span class="kw">if</span> q4a_66b==2</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_sit= q4a_66a*12                <span class="kw">if</span> q4a_66b==3</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_sit= q4a_66a                   <span class="kw">if</span> q4a_66b==4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Survey:</strong> In-kind food.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>g        lab_sif= q4a_68a*365               <span class="kw">if</span> q4a_68b==1  </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_sif= q4a_68a*(365/7)*(1)       <span class="kw">if</span> q4a_68b==2</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_sif= q4a_68a*12                <span class="kw">if</span> q4a_68b==3</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span>  lab_sif= q4a_68a                   <span class="kw">if</span> q4a_68b==4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>All labor aggregated into <code>lab_tot</code>.</p>
<div class="sourceCode" id="annotated-cell-45"><pre class="sourceCode stata code-annotation-code code-with-copy"><code class="sourceCode stata"><span id="annotated-cell-45-1"><a href="#annotated-cell-45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">egen</span> lab_tot=rsum(lab_pri lab_ikb lab_iko lab_ikf <span class="co">//</span></span>
<span id="annotated-cell-45-2"><a href="#annotated-cell-45-2" aria-hidden="true" tabindex="-1"></a>                  lab_sec lab_sik lab_sit lab_sif)</span>
<span id="annotated-cell-45-3"><a href="#annotated-cell-45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-45-4"><a href="#annotated-cell-45-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Code turned off, presumably used with already processed surveys.</span></span>
<span id="annotated-cell-45-5"><a href="#annotated-cell-45-5" aria-hidden="true" tabindex="-1"></a>*<span class="kw">egen</span> lab_tot=rsum(lab_pri  lab_sec)</span>
<span id="annotated-cell-45-6"><a href="#annotated-cell-45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-45-7"><a href="#annotated-cell-45-7" aria-hidden="true" tabindex="-1"></a><span class="co">// All labor income expressed in thousands.</span></span>
<span id="annotated-cell-45-8"><a href="#annotated-cell-45-8" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> lab_tot=lab_tot*1000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="treatment-of-missing-data-and-outliers" class="level3" data-number="2.6.4">
<h3 data-number="2.6.4" class="anchored" data-anchor-id="treatment-of-missing-data-and-outliers"><span class="header-section-number">2.6.4</span> Treatment of Missing Data and Outliers:</h3>
<p>The script examines missing labor income values among employed individuals and identifies outliers. Observations with labor incomes more than 5 standard deviations away from the mean are marked as outliers. There’s an annotation that explains that missings represent 10% of those employed. Mainly primary sector and household workers.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">//Outliers sd&gt;5</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">sum</span> lab_tot <span class="kw">if</span> employed==1 &amp; lab_tot&gt;0</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="kw">d</span> = lab_tot/<span class="fu">r</span>(<span class="fu">sd</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> outlier = 1 <span class="kw">if</span> <span class="kw">d</span>&gt;5</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> outlier = 1 <span class="kw">if</span> employed==1 &amp; lab_tot==0</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> outlier = 0 <span class="kw">if</span> outlier==.</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Missing</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> missings = 1     <span class="kw">if</span> employed==1 &amp; lab_tot==0</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> missings = 0 <span class="kw">if</span> missings==.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="merge-with-demographic-characteristics" class="level3" data-number="2.6.5">
<h3 data-number="2.6.5" class="anchored" data-anchor-id="merge-with-demographic-characteristics"><span class="header-section-number">2.6.5</span> Merge with Demographic Characteristics:</h3>
<p>The dataset is merged with household characteristics (<code>HHcha</code>), demographics (<code>demo</code>), and education (<code>edu</code>) datasets.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> n:1 hhid <span class="kw">using</span> <span class="ot">`HHcha'</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> <span class="kw">if</span> <span class="dt">_merge</span>==3</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:1 hhid pid <span class="kw">using</span> <span class="ot">`demo'</span> , nogen</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:1 hhid pid <span class="kw">using</span> <span class="ot">`edu'</span> , <span class="kw">gen</span>(edu)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="sector-categorization" class="level3" data-number="2.6.6">
<h3 data-number="2.6.6" class="anchored" data-anchor-id="sector-categorization"><span class="header-section-number">2.6.6</span> Sector Categorization:</h3>
<p>The <code>sector</code> variable categorizes individuals into primary, secondary, or tertiary sectors based on their reported economic activity (<code>q4a_230</code>).</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>***Sector</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> sector=1 <span class="kw">if</span> q4a_230==<span class="st">"A"</span> | q4a_230==<span class="st">"B"</span> | q4a_230==<span class="st">"C"</span> | q4a_230==<span class="st">"0"</span> | <span class="co">//</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                q4a_230==<span class="st">"1"</span> | q4a_230==<span class="st">"2"</span> | q4a_230==<span class="st">"3"</span> | q4a_230==<span class="st">"4"</span> | <span class="co">//</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                q4a_230==<span class="st">"5"</span> | q4a_230==<span class="st">"6"</span> | q4a_230==<span class="st">"7"</span> | q4a_230==<span class="st">"8"</span> | <span class="co">//</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                q4a_230==<span class="st">"9"</span> </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sector=2 <span class="kw">if</span>  q4a_230==<span class="st">"D"</span>| q4a_230==<span class="st">"E"</span>| q4a_230==<span class="st">"F"</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sector=3 <span class="kw">if</span>  q4a_230==<span class="st">"G"</span> | q4a_230==<span class="st">"H"</span> | q4a_230==<span class="st">"I"</span> |   <span class="co">//</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>                     q4a_230==<span class="st">"J"</span> |q4a_230==<span class="st">"K"</span>  | q4a_230==<span class="st">"L"</span> |   <span class="co">//</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>                     q4a_230==<span class="st">"M"</span> | q4a_230==<span class="st">"N"</span> | q4a_230==<span class="st">"O"</span> |   <span class="co">//</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>                     q4a_230==<span class="st">"P"</span> | q4a_230==<span class="st">"Q"</span> | q4a_230==<span class="st">"R"</span> |   <span class="co">//</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>                     q4a_230==<span class="st">"S"</span> | q4a_230==<span class="st">"T"</span> | q4a_230==<span class="st">"U"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There’s also imputation logic in place for missing sector information, where an employed individual without a specified sector is assigned the sector of the household head.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> aux = sector <span class="kw">if</span> <span class="fu">head</span>==1</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">bysort</span> hhid : <span class="kw">egen</span> sectorhh=<span class="fu">max</span>(aux)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sector=sectorhh <span class="kw">if</span> sector==. &amp; employed==1</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sector=2 <span class="kw">if</span> sector==. &amp; employed==1 <span class="co">//to check </span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sector=. <span class="kw">if</span> lstatus==2 | lstatus==3</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>lab <span class="kw">var</span> sector <span class="st">"Economic activity sector"</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>lab def sector_lab 0 <span class="st">"unemployed"</span> 1 <span class="st">"primary (Agr)"</span> <span class="co">//</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>                   2 <span class="st">"secondary (Ind)"</span> 3 <span class="st">"tertiary (Ser)"</span> </span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>lab val sector sector_lab</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> sector = . <span class="kw">if</span> lstatus==4 <span class="co">//No sector for OLF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="model-for-predicting-labor-income" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="model-for-predicting-labor-income"><span class="header-section-number">2.7</span> Model for Predicting Labor Income:</h2>
<p>The code calculates squared values for education (<code>educy2</code>) and age (<code>age2</code>) and creates a binary variable for males (<code>male</code>). A natural logarithm of total labor income is then calculated (<code>lnlab</code>).</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clonevar</span> industry = sector</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> educy2   = educy * educy</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> age2     = age*age</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> male     = 1 <span class="kw">if</span> gender==1</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> male = 0 <span class="kw">if</span> gender==2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Subsequently, a regression model (<code>reg</code>) predicts the logarithm of labor income (<code>lnlab</code>) based on various factors, but only for employed individuals who are neither outliers nor missing income values.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> lnlab    = <span class="fu">ln</span>(lab_tot)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="kw">reg</span> lnlab age gender i.educy age2 i.region i.q4a_24 i.sector [iw=wgt]  <span class="co">//</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>          <span class="kw">if</span> employed==1 &amp; outlier==0 &amp; missings==0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using this model, predicted income values (<code>remp2</code> and <code>temp2</code>) are generated for employed outliers or those missing labor income data.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> remp2 <span class="kw">if</span> employed==1 &amp; outlier==1 | missings==1 , <span class="kw">xb</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> temp2 <span class="kw">if</span> employed==1 &amp; outlier==1 | missings==1 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, these predicted values are transformed to actual income scale (<code>simuli</code>) using the exponential function, and negative predictions are set to zero.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> simuli = .</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> simuli = <span class="fu">exp</span>(temp2)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> simuli = 0 <span class="kw">if</span> simuli&lt;0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In summary, this section of the code:</p>
<ol type="1">
<li>Loads and processes labor market data.</li>
<li>Calculates labor force status and categorizes people based on their employment and income details.</li>
<li>Computes and aggregates labor income for different sources.</li>
<li>Treats missing data and outliers for labor income.</li>
<li>Merges the processed labor data with demographic and education datasets.</li>
<li>Categorizes individuals based on their sector of economic activity.</li>
<li>Predicts labor income for those missing data using regression, and adjusts the predictions as needed.</li>
</ol>
</section>
<section id="shares-and-total-income-to-the-model" class="level2" data-number="2.8">
<h2 data-number="2.8" class="anchored" data-anchor-id="shares-and-total-income-to-the-model"><span class="header-section-number">2.8</span> Shares and total income to the model</h2>
<p>This section is focused on computing shares and total income in preparation for a model.</p>
<p>Here, for those individuals who are employed and are either considered outliers or have missing labor income data (<code>lab_tot</code>), their labor income is replaced with the simulated value (<code>simuli</code>) generated in the previous section.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> lab_tot=simuli <span class="kw">if</span>  employed==1 &amp; (outlier==1 | missings==1 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This line calculates the total labor income at the household level, aggregating all individual incomes within each household.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">bysort</span> hhid : <span class="kw">egen</span> lab_hh=<span class="kw">sum</span>(lab_tot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The total income for each household is computed by summing the total labor income (<code>lab_hh</code>) and non-labor income (<code>nli_hh</code>).</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">egen</span>    income_hh=rsum(lab_hh nli_hh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we calculate the share of labor and non-labor income out of the total income for each household.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span>       s_lab    = lab_hh/income_hh</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span>       s_nli    = nli_hh/income_hh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And compute the natural logarithms of total income (<code>income_hh</code>) and household consumption (<code>yhh</code>).</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span>     lny      =<span class="fu">ln</span>(income_hh)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span>     lnc      =<span class="fu">ln</span>(yhh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The marginal propensity to consume (<code>mpc</code>) is calculated as the ratio of household consumption (<code>yhh</code>) to total income (<code>income_hh</code>).</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>g       mpc      = yhh/income_hh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The subsequent lines compute shares and derive other variables related to labor income and consumption:</p>
<ul>
<li><p><code>share</code> captures the individual’s share of labor income in the household’s total labor income, but only for those employed.</p></li>
<li><p><code>ylb</code> gives the portion of household consumption funded by labor income, while <code>ynl</code> represents the portion of household consumption sourced from non-labor income.</p></li>
<li><p><code>ylbi</code> represents the individual’s portion of household consumption funded by their labor income, again limited to the employed.</p></li>
</ul>
<div class="sourceCode" id="cb59"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> share = lab_tot/lab_hh  <span class="kw">if</span> employed==1</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co">// HH Consumption from labor</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> ylb = yhh*s_lab</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>lab <span class="kw">var</span> ylb   <span class="co">//</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Household consumption from labor income -nominal (Ariary/hh/year)"</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co">// HH Consumption from non-labor</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> ynl = yhh*(1-s_lab)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>lab <span class="kw">var</span> ynl  <span class="co">//</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Household consumption from non-labor income - nominal (Ariary/hh/year)"</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>g ylbi=ylb*share <span class="kw">if</span> employed==1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The dataset is then pruned to keep only select variables, and saved to a temporary file.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> hhid pid industry yhh ylb ynl ylbi salaried  </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">tempfile</span> labor</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="ot">`labor'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="final-datasets" class="level2" data-number="2.9">
<h2 data-number="2.9" class="anchored" data-anchor-id="final-datasets"><span class="header-section-number">2.9</span> Final datasets</h2>
<p>The main household characteristics dataset (<code>HHcha</code>) is loaded again. It then gets merged sequentially with the demographic (<code>demo</code>), education (<code>edu</code>), and labor (<code>labor</code>) datasets.</p>
<p>Once all necessary merges are done, the generation variables (<code>dem</code>, <code>edu</code>, <code>labo</code>) are dropped. The resulting final dataset, which combines household characteristics, demographics, education, and labor variables, is then saved as <code>MAG_assigned.dta</code>.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="ot">`HHcha'</span> , <span class="kw">clear</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:n hhid <span class="kw">using</span> <span class="ot">`demo'</span> , <span class="kw">gen</span>(dem)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> <span class="kw">if</span> dem==3</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:1 hhid pid <span class="kw">using</span> <span class="ot">`edu'</span> , <span class="kw">gen</span>(edu)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:1 hhid pid <span class="kw">using</span> <span class="ot">`labor'</span> , <span class="kw">gen</span>(labo)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> dem edu labo</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span>  <span class="st">"$HHsurvey\MAG_assigned.dta"</span>, <span class="kw">replace</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>In summary, this segment:</strong></p>
<ol type="1">
<li>Adjusts individual labor income values based on simulations for outliers and missing data.</li>
<li>Computes various shares related to labor and non-labor incomes.</li>
<li>Creates the logarithm of incomes and computes the marginal propensity to consume.</li>
<li>Derives individual and household-level variables for consumption funded by labor and non-labor income.</li>
<li>Merges several datasets to compile a comprehensive dataset containing household characteristics, demographics, education, and labor information.</li>
<li>Saves the final dataset for subsequent analysis.</li>
</ol>
</section>
</section>
<section id="creation-of-inputs-for-microsimulation" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Creation of inputs for microsimulation</h1>
<p><strong>File:</strong> 02_inputs.do</p>
<section id="import-population-data-to-be-used-in-the-creation-of-globals" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="import-population-data-to-be-used-in-the-creation-of-globals"><span class="header-section-number">3.1</span> Import population data to be used in the creation of globals</h2>
<p>We first load a dataset specified by the global macro <code>popdata</code>, but only for the observations where the variable <code>country</code> matches the value specified by the global macro <code>country</code>. Here, we are aggregating the data by <code>Variant</code> and <code>country</code> using <code>gcollapse</code> (an enhanced version of Stata’s <code>collapse</code> command). The <code>(sum)</code> function sums up all the variables starting with <code>yf</code> and <code>ym</code>. And we reshape the dataset from wide to long format based on the <code>yf</code> and <code>ym</code> variables. The combined identifiers are <code>country</code> and <code>Variant</code>, while the variable <code>year</code> is created to represent the time dimension.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="st">"$popdata"</span> <span class="kw">if</span> country==<span class="st">"$country"</span>, <span class="kw">clear</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> gcollapse (<span class="kw">sum</span>) yf* <span class="fu">ym</span>*, <span class="kw">by</span>(Variant country) </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">reshape</span> <span class="kw">long</span> yf <span class="fu">ym</span>, i(country Variant) j(<span class="fu">year</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here, we generate a new variable named <code>pop</code>, which is the sum of the <code>yf</code> (likely female population) and <code>ym</code> (likely male population) variables, essentially getting the total population. The individual gender-based population variables (<code>yf</code> and <code>ym</code>) are then dropped, as we now have the combined <code>pop</code> variable. The variable <code>country</code> is also dropped from the dataset. The dataset is then saved into a temporary file named <code>pop</code>.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> g pop = yf+<span class="fu">ym</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">drop</span> yf <span class="fu">ym</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> country</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="kw">tempfile</span> pop</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="ot">`pop'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>year</code> variable is summarized to get its basic statistics. Two local macros are defined: <code>minyear</code>, which is assigned the value of the global macro <code>surveyyear</code>, and <code>maxyear</code>, which is assigned the maximum value of the <code>year</code> variable.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">sum</span> <span class="fu">year</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> minyear = <span class="ot">$surveyyear</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> maxyear = <span class="fu">r</span>(<span class="fu">max</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A local macro <code>v</code> is initialized to 1. The subsequent loop then runs over several population projection variants. For each variant and for every year between <code>minyear</code> and <code>maxyear</code>, the total population (<code>pop</code>) for that year (<code>pop_t</code>) and the base year (<code>pop_base</code>) is calculated. The population growth rate is then computed by dividing <code>pop_t</code> by <code>pop_base</code> and saved into a global macro with a naming convention based on the year and variant. The counter <code>v</code> increments for each variant.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> v = 1</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> variant <span class="kw">in</span> <span class="st">"Medium"</span> <span class="st">"Low"</span> <span class="st">"High"</span> <span class="st">"Constant-fertility"</span> <span class="co">//</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Instant-replacement"</span> <span class="st">"Momentum"</span>  <span class="co">//</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Instant-replacement-zero-migration"</span> <span class="co">//</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Constant-mortality"</span> <span class="st">"No-change"</span> {</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">forvalues</span> t = <span class="ot">`minyear'</span>/<span class="ot">`maxyear'</span> {  </span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Population growth */</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> pop <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; Variant==<span class="st">"`variant'"</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> pop_t = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> pop  <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; Variant==<span class="st">"`variant'"</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> pop_base = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> pop_growth_t<span class="ot">`t'</span>_v<span class="ot">`v'</span> = <span class="ot">`pop_t'</span>/<span class="ot">`pop_base'</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> v = <span class="ot">`v'</span>+1</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Lastly, the code imports an Excel file specified by the macro <code>scenario_file</code> from a sheet named <code>elas_rep</code>, clearing the existing data in memory. These are three cells with the elasticities for Agriculture, Manufacturing (Industry), and Services. We put these in a matrix <code>E</code> from the dataset, variable <code>A</code> (first column).</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>import excel <span class="st">"${scenario_file}"</span>, sheet(elas_rep) <span class="kw">clear</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mkmat</span> A  , mat(E)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In summary, this chunk of code:</p>
<ol type="1">
<li>Imports a dataset and reshapes it to long format based on population variables.</li>
<li>Aggregates the data to get total populations by year and variant.</li>
<li>Computes population growth rates for different scenarios across years.</li>
<li>Imports another dataset from Excel related to some scenarios.</li>
<li>Transforms part of the dataset into a matrix for further analysis.</li>
</ol>
</section>
<section id="import-data-from-the-excel-file-received-from-macroeconomic-modelers" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="import-data-from-the-excel-file-received-from-macroeconomic-modelers"><span class="header-section-number">3.2</span> Import data from the excel file received from macroeconomic modelers</h2>
<p>A local macro <code>i</code> is initialized to 0. A loop is then started, iterating over a global macro called <code>scenarios</code>, which presumably contains a list of sheet names from the Excel file to import. For each sheet name in <code>scenarios</code>, the code imports data from the Excel file specified by the <code>scenario_file</code> macro. The data is imported from the cell range <code>A3:N63</code>. This command renames the variables in the dataset using the variable names stored in the global macro <code>$vars</code>. The counter <code>i</code> is incremented by 1, and a new variable <code>scenid</code> is created in the dataset, which is given the current value of <code>i</code>. This acts as an identifier for each scenario. The dataset is saved into a temporary file named based on the current value of <code>i</code> (like <code>scen1</code>, <code>scen2</code>, etc.). The loop then moves on to the next sheet name in <code>scenarios</code>.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> x <span class="kw">of</span> <span class="kw">global</span> scenarios {</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">qui</span> import excel <span class="st">"${scenario_file}"</span>, sheet(<span class="st">"`x'"</span>) cellrange(A3:N63) <span class="kw">clear</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">rename</span> (*) (<span class="ot">$vars</span>)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> i = <span class="ot">`i'</span>+1</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    g scenid = <span class="ot">`i'</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">tempfile</span> scen<span class="ot">`i'</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">qui</span> <span class="kw">save</span> <span class="ot">`scen`i'</span>'</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The dataset from the first scenario (<code>scen1</code>) is loaded into memory. A new local macro <code>num</code> is defined, which calculates the number of items in the <code>scenarios</code> global macro. Then, a loop starts from 2 up to the value of <code>num</code>. For each iteration, the dataset for the scenario corresponding to the current value of <code>i</code> is appended to the dataset in memory.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="ot">`scen1'</span>, <span class="kw">clear</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> num : <span class="ot">list</span> <span class="kw">sizeof</span> <span class="kw">global</span>(scenarios)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="kw">forvalues</span> i = 2/<span class="ot">`num'</span> {</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">append</span> <span class="kw">using</span> <span class="ot">`scen`i'</span>'</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Any observations with a missing value for the <code>year</code> variable are dropped. A new variable <code>rwage</code> is created, which represents the real wage by dividing the <code>wage</code> variable by the <code>cpi</code> (Consumer Price Index) variable. This adjusts the wage for inflation.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>cap <span class="kw">drop</span> <span class="kw">if</span> <span class="fu">year</span>==.</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> g rwage = wage/cpi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The variable <code>Variant</code> is initialized with empty strings. Then, a loop iterates over another global macro named <code>variants</code>. For each iteration, the value of <code>Variant</code> is replaced with the current item from <code>variants</code> where the <code>scenid</code> matches the current value of <code>i</code>. This assigns the appropriate variant name to each observation based on its <code>scenid</code>.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>g Variant = <span class="st">""</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> i = 1</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">foreach</span> variant <span class="kw">of</span> <span class="kw">global</span> variants {</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">replace</span> Variant = <span class="st">"`variant'"</span> <span class="kw">if</span> scenid==<span class="ot">`i'</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> i = <span class="ot">`i'</span> + 1</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The dataset is then merged with the one saved in the temporary file <code>pop</code> based on the <code>year</code> and <code>Variant</code> variables. Observations that didn’t find a match in the <code>pop</code> dataset are dropped, and the <code>_merge</code> variable (created by the <code>merge</code> command) is also dropped. The dataset is sorted by <code>scenid</code> and then <code>year</code>.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> <span class="fu">m</span>:1 <span class="fu">year</span> Variant <span class="kw">using</span> <span class="ot">`pop'</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="kw">if</span> <span class="dt">_merge</span>==2</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="dt">_merge</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> scenid <span class="fu">year</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then a new variable <code>consumption_pc</code> is created, which calculates the per capita consumption. This is done by dividing the <code>consumption</code> variable by 100 times the <code>pop</code> variable.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>g consumption_pc = consumption/(pop*10e2)  </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>In summary:</strong></p>
<ol type="1">
<li>We import various scenarios from an Excel file and save each as a temporary Stata dataset.</li>
<li>Combines all the scenarios into one dataset.</li>
<li>Processes the dataset by calculating real wages, assigning scenario names, merging with population data, and calculating per capita consumption values.</li>
</ol>
</section>
<section id="creating-globals-by-yearscenario-to-be-used-later-in-the-microsimulation" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="creating-globals-by-yearscenario-to-be-used-later-in-the-microsimulation"><span class="header-section-number">3.3</span> Creating globals by year/scenario to be used later in the microsimulation</h2>
<p>These lines determine the range of years in the dataset. The minimum year is set to a predefined global macro (<code>$surveyyear</code>), and the maximum year is the maximum year observed in the dataset.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">sum</span> <span class="fu">year</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> minyear = <span class="ot">$surveyyear</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> maxyear = <span class="fu">r</span>(<span class="fu">max</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This line identifies all the unique values of <code>scenid</code> in the dataset and stores them in a local macro called <code>scenarios</code>.</p>
<pre><code>levelsof scenid, loc(scenarios)</code></pre>
<p>The code then starts a loop, iterating over each unique scenario in the dataset. Inside the loop for each scenario, another loop starts which iterates over the years from the minimum to the maximum year. Within these nested loops, a series of commands calculate global growth rates and other indicators for various economic variables (GDP, consumption, employment, value added in different sectors, wages, etc.). The calculations are typically in the form:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">sum</span> [<span class="kw">variable</span>] <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> [<span class="kw">variable</span>]_t = <span class="fu">r</span>(<span class="kw">sum</span>)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">sum</span> [<span class="kw">variable</span>] <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> [<span class="kw">variable</span>]_base = <span class="fu">r</span>(<span class="kw">sum</span>)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> [<span class="kw">variable</span>]_growth_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`variable_t'</span>/<span class="ot">`variable_base'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For each combination of year and scenario, these commands:</p>
<ol type="1">
<li>Sum up the variable’s value for the current year (<code>t</code>) and scenario (<code>sc</code>).</li>
<li>Save this sum in a local macro.</li>
<li>Sum up the variable’s value for the base year and the current scenario.</li>
<li>Save this sum in another local macro.</li>
<li>Calculate the growth rate by dividing the current year’s sum by the base year’s sum.</li>
<li>Save the growth rate in a global macro.</li>
</ol>
<p>These steps are repeated for several economic indicators. At the end of the nested loops, the Stata dataset will contain a series of global macros capturing the growth rates and other economic indicators for each year and scenario.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="kw">sc</span> <span class="kw">of</span> numlist <span class="ot">`scenarios'</span> {  </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">forvalues</span> t = <span class="ot">`minyear'</span>/<span class="ot">`maxyear'</span> {  </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* GDP */</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> gdp <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> gdp_t = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> gdp  <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> gdp_base = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> gdp_growth_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`gdp_t'</span>/<span class="ot">`gdp_base'</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Consumption */</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> consumption <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> consumption_t = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> consumption  <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> consumption_base = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> c_growth_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`consumption_t'</span>/<span class="ot">`consumption_base'</span> </span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Consumption per capita */</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> consumption_pc <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> consumption_t = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> consumption_pc   <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> consumption_base = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> pcc_growth_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`consumption_t'</span>/<span class="ot">`consumption_base'</span></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Remittances */</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> remittances <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> remittances_t = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> remittances  <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> remittances_base = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> remitt_growth_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`remittances_t'</span>/<span class="ot">`remittances_base'</span>       </span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Employment */</span></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> employment <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> employment_t = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> employment   <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> employment_base = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> emp_growth_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`employment_t'</span>/<span class="ot">`employment_base'</span>        </span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Employment rate */</span></span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> employment    <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> employment_t_n = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> wa_population <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> employment_t_d = <span class="fu">r</span>(<span class="kw">sum</span>)   </span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> emp_rate_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`employment_t_n'</span>/<span class="ot">`employment_t_d'</span> </span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Working age population */</span></span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> wa_population <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> employment_t = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> wa_population    <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> employment_base = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-58"><a href="#cb76-58" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> wapop_growth_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`employment_t'</span>/<span class="ot">`employment_base'</span></span>
<span id="cb76-59"><a href="#cb76-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-60"><a href="#cb76-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Value added */</span></span>
<span id="cb76-61"><a href="#cb76-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-62"><a href="#cb76-62" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> agriculture_va <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-63"><a href="#cb76-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> N_i = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-64"><a href="#cb76-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> agriculture_va <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-65"><a href="#cb76-65" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> N_base = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-66"><a href="#cb76-66" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> growth_agriculture_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`N_i'</span>/<span class="ot">`N_base'</span></span>
<span id="cb76-67"><a href="#cb76-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-68"><a href="#cb76-68" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> industry_va <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-69"><a href="#cb76-69" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> N_i = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-70"><a href="#cb76-70" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> industry_va <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-71"><a href="#cb76-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> N_base = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-72"><a href="#cb76-72" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> growth_industry_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`N_i'</span>/<span class="ot">`N_base'</span></span>
<span id="cb76-73"><a href="#cb76-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-74"><a href="#cb76-74" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> services_va <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-75"><a href="#cb76-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> N_i = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-76"><a href="#cb76-76" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> services_va <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-77"><a href="#cb76-77" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> N_base = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-78"><a href="#cb76-78" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> growth_services_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`N_i'</span>/<span class="ot">`N_base'</span></span>
<span id="cb76-79"><a href="#cb76-79" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb76-80"><a href="#cb76-80" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Nominal Wages */</span></span>
<span id="cb76-81"><a href="#cb76-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-82"><a href="#cb76-82" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> wage        <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-83"><a href="#cb76-83" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> N_i = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-84"><a href="#cb76-84" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> wage        <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-85"><a href="#cb76-85" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> N_base = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-86"><a href="#cb76-86" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> growth_wage_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`N_i'</span>/<span class="ot">`N_base'</span></span>
<span id="cb76-87"><a href="#cb76-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-88"><a href="#cb76-88" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Real Wages */</span></span>
<span id="cb76-89"><a href="#cb76-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-90"><a href="#cb76-90" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> rwage       <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`t'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-91"><a href="#cb76-91" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> N_i = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-92"><a href="#cb76-92" aria-hidden="true" tabindex="-1"></a>        <span class="kw">qui</span> <span class="kw">sum</span> rwage       <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">`minyear'</span> &amp; scenid==<span class="ot">`sc'</span></span>
<span id="cb76-93"><a href="#cb76-93" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> N_base = <span class="fu">r</span>(<span class="kw">sum</span>) </span>
<span id="cb76-94"><a href="#cb76-94" aria-hidden="true" tabindex="-1"></a>        <span class="kw">global</span> growth_rwage_t<span class="ot">`t'</span>_sc<span class="ot">`sc'</span> = <span class="ot">`N_i'</span>/<span class="ot">`N_base'</span></span>
<span id="cb76-95"><a href="#cb76-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-96"><a href="#cb76-96" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb76-97"><a href="#cb76-97" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb76-98"><a href="#cb76-98" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After finishing the calculations for all scenarios and years, the code then lists all global macros, giving you an overview of the generated variables. The block of Stata commands then ends.</p>
<p>In summary, this code processes the dataset to generate a comprehensive set of global macros containing values for various economic indicators, broken down by year and scenario. These global macros are then used in subsequent analyses or microsimulations.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> c:<span class="ot">all</span> globals</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="kw">macro</span> <span class="ot">list</span> c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="reweighting-using-education-projections-un-age-projections-and-sectoral-shares-from-mfmod" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Reweighting using education projections, UN age projections and sectoral shares from MFMOD</h1>
<p><strong>File:</strong> 03_MFmod.do</p>
<p>This code chunk pertains to a reweighting procedure using education projections, United Nations (UN) age projections, and sectoral shares from a macroeconomic model named “MFMOD”.</p>
<p>These commands clear the first timer and then start it. Stata’s <code>timer</code> functionality allows for tracking the time taken for specific operations, useful for benchmarking performance.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">timer</span> <span class="kw">clear</span> 1    </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="kw">timer</span> <span class="kw">on</span> 1    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The local macro <code>i</code> is initialized to 1. From the comments, it seems <code>i</code> will be used as a counter or reference number for the scenarios. Each scenario will likely be related to specific combinations of variants. The file is a massive loop.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> i = 1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Nested loops begin here. The outer loop iterates over each variant specified in a global macro called <code>variants</code>. The inner loop, for each variant, iterates over years specified in a global macro called <code>yearsto</code>.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> variant <span class="kw">of</span> <span class="kw">global</span> variants {</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">foreach</span> t <span class="kw">of</span> <span class="kw">global</span> yearsto {</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This conditional checks if the current scenario (tracked by <code>i</code>) is the first one and the year is 2021, or if the year is after 2021. If either of these conditions is true, the code inside the block will execute.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> ( (<span class="ot">`i'</span>==1 &amp; <span class="ot">`t'</span>==2021) | (<span class="ot">`t'</span>&gt;2021) ) {</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This line opens a dataset named <code>MAG_assigned.dta</code> from a specified path which we created previously. The <code>clear</code> option ensures that the current data in memory is replaced by the new dataset.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="st">"$path/data/MAG_assigned.dta"</span>, <span class="kw">clear</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This line renames the variable <code>ylbi</code> to <code>yflab</code>. A new variable, <code>pcnli</code>, is created. It is the result of dividing the <code>ynl</code> variable by <code>hhsize</code>, which represents the per capita non-labor income in the household.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ren</span> (ylbi) (yflab)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>g pcnli = ynl/hhsize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="define-key-variables-and-globalsrates" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="define-key-variables-and-globalsrates"><span class="header-section-number">4.1</span> Define key variables and globals/rates</h2>
<p>This command recodes the <code>educy</code> variable, which represents years of education. It bins the years into three categories: “0-3”, “3-7”, and “8+”. The newly created categorical variable is named <code>calif</code>.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">recode</span> educy (0/3 = 1 <span class="st">"0-3"</span>) (3/7 = 2 <span class="st">"3-7"</span>) (7/11 = 3 <span class="st">"8+"</span>), g(calif)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A matrix <code>industry_growth</code> is created, which is based on a combination of previously defined global variables and the matrix <code>E</code>, which you can recall we created before with the elasticities. The <code>industry_growth</code> matrix represents growth in different industry sectors.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>mat industry_growth = <span class="co">/// </span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    1+(<span class="ot">${growth_agriculture_t`t'</span>_sc<span class="ot">`i'</span>}-1)*E[1,1] \ <span class="co">///</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    1+(   <span class="ot">${growth_industry_t`t'</span>_sc<span class="ot">`i'</span>}-1)*E[2,1] \ <span class="co">///</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    1+(   <span class="ot">${growth_services_t`t'</span>_sc<span class="ot">`i'</span>}-1)*E[3,1]</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="kw">matlist</span> industry_growth</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A global variable <code>employment</code> is created based on employment rates for a particular year and scenario. This variable captures the growth in employment rate from the survey year to the target year.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> employment = (<span class="ot">${emp_rate_t`t'</span>_sc<span class="ot">`i'</span>})  / (<span class="ot">${emp_rate_t${surveyyear}_sc`i'</span>}) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="main-reweighting-command" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="main-reweighting-command"><span class="header-section-number">4.2</span> Main reweighting command</h2>
<p>This is the most important part of the code. The reweighting of the dataset.</p>
<p>The command <code>mfmodms_reweight</code> appears to be a custom command (possibly from a user-written package or an in-house module) that performs the reweighting based on several constraints. The variables and parameters to be considered in the reweighting process are specified.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>mfmodms_reweight, age(age) edu(calif) gender(gender) hhsize(hhsize)       <span class="co">// </span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>                  id(hhid) iw(wgt) country(<span class="st">"$country"</span>) iyear(<span class="ot">$surveyyear</span>) <span class="co">//</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>                  tyear(<span class="ot">`t'</span>) <span class="kw">generate</span>(wgtsim) industry(industry)          <span class="co">//</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>                  growth(industry_growth) <span class="fu">match</span>(HH) popdata(<span class="st">"$popdata"</span>)   <span class="co">//</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>                  employment(<span class="ot">$employment</span>) variant(<span class="ot">`variant'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="wage-bill-at-baseline" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="wage-bill-at-baseline"><span class="header-section-number">4.3</span> Wage bill at baseline</h2>
<p>The command quietly calculates the weighted sum of the <code>yflab</code> variable, which represents the family labor income. The result is stored as a scalar named <code>Y0</code>.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">sum</span> yflab [aw=wgt]</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">scalar</span> Y0 = <span class="fu">r</span>(<span class="kw">mean</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="wage-bill-at-simulated-yearscenario" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="wage-bill-at-simulated-yearscenario"><span class="header-section-number">4.4</span> Wage bill at simulated year/scenario</h2>
<p>This portion of the code takes the user through calculating the simulated wage bill for different scenarios and years and then modifies the distribution of labor income accordingly.</p>
<p>The comments suggest adjusting the <code>yflab</code> (probably representing labor income or wage) in such a way that it grows consistently with Value Added (VA), ensuring the share of the wage bill on VA remains constant. This is done for three sectors: agriculture, industry, and services.</p>
<p>Here, the wage bill for the simulated year and scenario is computed and stored in a scalar <code>Y1</code>.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* "wage" by sector grow in a way consistent with VA, </span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="co">    such that the share of the wage bill on VA is constant */</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">replace</span> yflab = yflab*(<span class="ot">${growth_agriculture_t`t'</span>_sc<span class="ot">`i'</span>} /    <span class="co">//</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>                    industry_growth[1,1]) <span class="kw">if</span> industry==1</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">replace</span> yflab = yflab*(<span class="ot">${growth_industry_t`t'</span>_sc<span class="ot">`i'</span>}    /    <span class="co">//</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>                    industry_growth[2,1]) <span class="kw">if</span> industry==2</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">replace</span> yflab = yflab*(<span class="ot">${growth_services_t`t'</span>_sc<span class="ot">`i'</span>}    /    <span class="co">//</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>                    industry_growth[3,1]) <span class="kw">if</span> industry==3</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Labor income (wage bill) at simulated year and scenario      </span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">qui</span> <span class="kw">sum</span> yflab [aw=wgtsim<span class="ot">`t'</span>]</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scalar</span> Y1 = <span class="fu">r</span>(<span class="kw">mean</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="re-center-and-simulated-welfare-aggregate" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="re-center-and-simulated-welfare-aggregate"><span class="header-section-number">4.5</span> Re-center and simulated welfare aggregate</h2>
<p>This section aims to adjust the labor income, aggregate it to the household level, then adjust it further with non-labor income and consumption projections. The comment suggests re-centering the labor income distribution, ensuring that only the distribution of labor income is modified. Labor income is aggregated at the household level, producing a new variable named <code>ysim_</code>t’_sc<code>i'</code>, which seems to represent simulated labor income for a specific year (<code>t</code>) and scenario (<code>i</code>). The simulated labor income is adjusted to become per capita values. To the simulated labor income per capita, non-labor income (denoted by <code>pcnli</code>) is added.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Re-center, so we only modify the distribution of "labor income" */</span>   </span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">replace</span> yflab = yflab * (Y0/Y1) </span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co">/* Aggregate to household again */</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="kw">bys</span> hhid: <span class="kw">egen</span> ysim_<span class="ot">`t'</span>_sc<span class="ot">`i'</span> = <span class="kw">sum</span>(yflab) </span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="co">/* Divide by hhsize to make per capita again */</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">replace</span> ysim_<span class="ot">`t'</span>_sc<span class="ot">`i'</span>=(ysim_<span class="ot">`t'</span>_sc<span class="ot">`i'</span>)/hhsize  </span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="co">/* Adding back "non-labor" income */</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">replace</span> ysim_<span class="ot">`t'</span>_sc<span class="ot">`i'</span>=ysim_<span class="ot">`t'</span>_sc<span class="ot">`i'</span> + pcnli   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="adjusting-the-consumption-according-to-the-projection" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="adjusting-the-consumption-according-to-the-projection"><span class="header-section-number">4.6</span> Adjusting the consumption according to the projection</h2>
<p>This portion adjusts the simulated labor income based on the growth in per capita consumption from projections. The conditional statement checks if it’s the base year (2021) and the first scenario. If it is, the dataset is saved anew. If not, the dataset is appended with new simulated values for the other years and scenarios.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">sum</span> pcc [aw=wgt]</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">scalar</span> pccY0 = <span class="fu">r</span>(<span class="kw">mean</span>)</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">sum</span> ysim_<span class="ot">`t'</span>_sc<span class="ot">`i'</span> [aw=wgtsim<span class="ot">`t'</span>]</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="fu">scalar</span> pccrwY1 = <span class="fu">r</span>(<span class="kw">mean</span>)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> <span class="kw">replace</span> ysim_<span class="ot">`t'</span>_sc<span class="ot">`i'</span> = ysim_<span class="ot">`t'</span>_sc<span class="ot">`i'</span> *   <span class="co">//</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>                             (pccY0*<span class="ot">${pcc_growth_t`t'</span>_sc<span class="ot">`i'</span>}) / pccrwY1</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">var</span> ysim_<span class="ot">`t'</span>_sc<span class="ot">`i'</span>  <span class="co">//</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>   <span class="st">"Simulated pcc - After reweighting and hh consumption growth, Year: `t'"</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="kw">ren</span> wgtsim<span class="ot">`t'</span> wgtsim<span class="ot">`t'</span>_sc<span class="ot">`i'</span> </span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> (<span class="ot">`i'</span>==1 &amp; <span class="ot">`t'</span>==2021) <span class="kw">save</span> <span class="st">"$path/data/MAG_simulated.dta"</span>,<span class="kw">replace</span> </span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a><span class="kw">else</span> {</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">qui</span> <span class="kw">merge</span> 1:1 hhid pid <span class="kw">using</span>  <span class="co">//</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>              <span class="st">"$path/data/MAG_simulated.dta"</span>, keepusing(ysim_*_sc* wgtsim*_sc* )</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">drop</span> <span class="dt">_merge</span></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">qui</span> <span class="kw">save</span> <span class="st">"$path/data/MAG_simulated.dta"</span>, <span class="kw">replace</span> </span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>} <span class="co">// This closes the loop.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After processing each scenario and year, a message is displayed in red, indicating the completion of the scenario-year pair.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>dis <span class="kw">in</span> <span class="kw">red</span> <span class="st">"DONE WITH SCENARIO `i' AND YEAR `t'"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These closing brackets represent the end of loops and conditions. The code runs through various scenarios and years, updating the variable <code>i</code> (scenario counter) for each iteration.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>} <span class="co">/* Conditional to skip scenarios for 2021 */</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>} <span class="co">/* Loop over years */</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> i = <span class="ot">`i'</span>+1</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>} <span class="co">/* Loop over scenarios */</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, the timer that was started at the beginning of the code is turned off, and the time taken is displayed.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">timer</span> <span class="kw">off</span> 1</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="kw">timer</span> <span class="ot">list</span> 1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>In summary:</strong> Overall, this code simulates labor income under different scenarios and years, adjusts it based on various factors, and then saves or appends the results to the file named <code>MAG_simulated.dta</code>.</p>
</section>
</section>
<section id="generating-indicators" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Generating indicators</h1>
<p><strong>File:</strong> 04_indicators.do</p>
<section id="poverty-statistics-by-regions-urbanrural-and-gender" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="poverty-statistics-by-regions-urbanrural-and-gender"><span class="header-section-number">5.1</span> Poverty statistics by regions, urban/rural, and gender</h2>
<p>This code is primarily involved in generating poverty and inequality indicators for different scenarios and years. Load the simulated data created before for further processing. Merge the data with another dataset that likely contains poverty lines or thresholds (based on variable names).</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="st">"$path/data/MAG_simulated"</span>,<span class="kw">clear</span>    </span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:1 hhid pid <span class="kw">using</span> <span class="st">"$path/data/MAG_assigned"</span>, keepusing(pline* lbpl ubpl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Define global macros for scenarios and years. Note that we only analyze every ten years.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> scenssim 1 2 3 4 5 6</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> nscsteps 2030(10)2050</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create a binary indicator for urban areas based on binary “rural”. If not present.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>*<span class="kw">gen</span> urban = rural!=1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Keep only the specified variables in the dataset.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> hhid pid wgt wgtsim* ysim* pcc region gender zone pline* lbpl ubpl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Define different poverty thresholds.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> pov19 = 1.9</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> pov32 = 3.2</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> pov55 = 5.5</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> pov10 = 10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create a variable called ‘country’ with value 1 for all observations. Also, define a new variable <code>Ysim_baseyear</code> equal to the <code>pcc</code> variable, which seems to represent per capita consumption.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>g country=1</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>g Ysim_baseyear = pcc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The next set of commands uses the <code>sp_groupfunction</code> command multiple times. This command seems to be a user-defined or package-specific function that calculates some group-specific statistics, likely poverty rates, and Gini coefficients. For example, This block calculates statistics for the base year at the country level:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    sp_groupfunction [aw=wgt], poverty(Ysim_baseyear)  <span class="co">//</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    povertyline(pline215 pline365 pline685 lbpl ubpl)  <span class="co">//</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>                gini(Ysim_baseyear) <span class="kw">mean</span>(Ysim_baseyear) <span class="kw">by</span>(country) </span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    g <span class="fu">year</span>=<span class="ot">$surveyyear</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">tempfile</span> resultsbase</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">qui</span> <span class="kw">save</span> <span class="ot">`resultsbase'</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Similar blocks are provided for calculating statistics at different levels: region, urban vs.&nbsp;rural (zone), and gender.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    sp_groupfunction [aw=wgt], poverty(Ysim_baseyear) <span class="co">//</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    povertyline(pline215 pline365 pline685 lbpl ubpl) <span class="co">//</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>                <span class="kw">mean</span>(Ysim_baseyear) <span class="kw">by</span>(country region) </span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    g <span class="fu">year</span>=<span class="ot">$surveyyear</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">tempfile</span> resultsbase_reg</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">qui</span> <span class="kw">save</span> <span class="ot">`resultsbase_reg'</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span> </span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>    sp_groupfunction [aw=wgt], poverty(Ysim_baseyear)  <span class="co">//</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>    povertyline(pline215 pline365 pline685 lbpl ubpl)  <span class="co">//</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>                <span class="kw">mean</span>(Ysim_baseyear) <span class="kw">by</span>(country zone) </span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>    g <span class="fu">year</span>=<span class="ot">$surveyyear</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">tempfile</span> resultsbase_urb</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">qui</span> <span class="kw">save</span> <span class="ot">`resultsbase_urb'</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span> </span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>    sp_groupfunction [aw=wgt], poverty(Ysim_baseyear)  <span class="co">//</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>    povertyline(pline215 pline365 pline685 lbpl ubpl)  <span class="co">//</span></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>                <span class="kw">mean</span>(Ysim_baseyear) <span class="kw">by</span>(country gender) </span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a>    g <span class="fu">year</span>=<span class="ot">$surveyyear</span></span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">tempfile</span> resultsbase_gender</span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">qui</span> <span class="kw">save</span> <span class="ot">`resultsbase_gender'</span></span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And then we drop the previously created variable <code>Ysim_baseyear</code>.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> Ysim_baseyear </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The following loop iterates over scenarios and years, calculating the same set of statistics for each combination. For each scenario-year combination, the results are saved in a temporary file.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="kw">sc</span> <span class="kw">in</span> <span class="ot">$scenssim</span> {  </span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">forvalues</span> i=<span class="ot">$nscsteps</span> { </span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">preserve</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">noisily</span> sp_groupfunction [aw=wgtsim<span class="ot">`i'</span>_sc<span class="ot">`sc'</span>], poverty(ysim_<span class="ot">`i'</span>_sc<span class="ot">`sc'</span>)..</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>      g <span class="fu">year</span>=<span class="ot">`i'</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">tempfile</span> results<span class="ot">`i'</span>_<span class="ot">`sc'</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">qui</span> <span class="kw">save</span> <span class="ot">`results`i'</span>_<span class="ot">`sc'</span>'</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">restore</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The following nested loops iterating over various scenarios (<code>$scenssim</code>) and years (<code>$nscsteps</code>) do the same. Within each loop, a function named <code>sp_groupfunction</code> is applied to the data, which likely computes poverty-related statistics. The results are then saved to separate temporary files for different combinations of scenarios, years, and groupings (region, urban/rural zone, and gender). The results are saved in temporary files named with the pattern <code>results[year]_[grouping]_[scenario]</code>. In summary, the code generates poverty statistics based on simulated data, breaking down the results by different groupings (regions, urban/rural zones, and gender) for various scenarios and years.</p>
<p>Then the code focuses on aggregating results from various files, preparing data for output, and then performing additional calculations on income percentiles. Here’s the step-by-step breakdown:</p>
<p>The script first loads the results from the base file (<code>resultsbase</code>) and then appends (or stacks) results from the different scenarios, regions, zones (urban/rural), and gender groupings created before.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="ot">`resultsbase'</span>,<span class="kw">clear</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="kw">append</span> <span class="kw">using</span> <span class="ot">`resultsbase_reg'</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="kw">append</span> <span class="kw">using</span> <span class="ot">`resultsbase_urb'</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="kw">append</span> <span class="kw">using</span> <span class="ot">`resultsbase_gender'</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="kw">sc</span> <span class="kw">in</span> <span class="ot">$scenssim</span> {</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">forvalues</span> i=<span class="ot">$nscsteps</span> {</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">append</span> <span class="kw">using</span> <span class="ot">`results`i'</span>_<span class="ot">`sc'</span>'</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">append</span> <span class="kw">using</span> <span class="ot">`results`i'</span>_reg_<span class="ot">`sc'</span>'</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">append</span> <span class="kw">using</span> <span class="ot">`results`i'</span>_urb_<span class="ot">`sc'</span>'</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">append</span> <span class="kw">using</span> <span class="ot">`results`i'</span>_gender_<span class="ot">`sc'</span>'</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We then create a Unique Identifier (<code>concat</code>) and Reorder.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="fu">concat</span> = measure +<span class="st">"_"</span>+ <span class="kw">variable</span>+<span class="st">"_"</span> +reference+<span class="st">"_"</span>+<span class="fu">string</span>(region)+ <span class="co">//</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"_"</span>+<span class="fu">string</span>(zone)+<span class="st">"_"</span>+<span class="fu">string</span>(gender)</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="fu">concat</span>, first</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> regionref = region</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The aggregated data is then exported to an Excel file and then saved in a Stata format.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">export</span> excel <span class="kw">using</span> <span class="st">"$scenario_file"</span>, sheet(<span class="st">"Indicators"</span>,modify) firstrow(varlabels)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="fu">concat</span> </span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="st">"$path/outputs\MAG_indicators"</span>,<span class="kw">replace</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The script switches to another dataset (<code>MAG_simulated</code>) and prepares to compute income percentiles.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="st">"$path\data\MAG_simulated"</span>,<span class="kw">clear</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:1 hhid pid <span class="kw">using</span> <span class="st">"$path/data/MAG_assigned"</span>, keepusing(pline* lbpl ubpl)</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> hhid pid wgt wgtsim* ysim* pcc pline* lbpl ubpl</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>g Ysim_baseyear = pcc</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>g country = 1</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> pcc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It first calculates the percentiles for the base year income.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>gquantiles Ysim_baseyear [aw=wgt], _pctile nq(100)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>mat quantiles = <span class="fu">r</span>(quantiles_used)</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">colnames</span> quantiles = Ysim_baseyear</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In essence, this code is primarily focused on organizing and summarizing the simulated results from different scenarios, then performing statistical analyses on the income distribution by quantiles.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="kw">sc</span> <span class="kw">in</span> <span class="ot">$scenssim</span> {</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>    forval simyear = <span class="ot">$nscsteps</span> {    </span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>        gquantiles ysim_<span class="ot">`simyear'</span>_sc<span class="ot">`sc'</span> [aw=wgtsim<span class="ot">`simyear'</span>_sc<span class="ot">`sc'</span>], _pctile nq(100)</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>        mat mat0 = <span class="fu">r</span>(quantiles_used)</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>        mat <span class="ot">colnames</span> mat0 = ysim_<span class="ot">`simyear'</span>_sc<span class="ot">`sc'</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>        mat quantiles = quantiles,mat0</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We export income by percentiles to our Excel file, modifying it (not replace). First, the data is cleared out of the current memory. The <code>quantiles</code> matrix is converted to a dataset format using <code>svmat</code>. Each column from the matrix becomes a variable in the dataset. A new variable, <code>percentil</code>, is created to indicate the row number (or the percentile). The dataset is exported to an Excel file under the sheet “Income_by_percentile”.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="kw">svmat</span> quantiles, names(col)</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>g percentil = <span class="dt">_n</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="kw">export</span> excel <span class="kw">using</span> <span class="st">"$scenario_file"</span>, sheet(<span class="st">"Income_by_percentile"</span>,modify) <span class="co">//</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>                   firstrow(varlabels)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="compute-deviations" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="compute-deviations"><span class="header-section-number">5.2</span> Compute deviations</h2>
<p>The dataset <code>MAG_indicators</code> is loaded into memory. Several variables are modified to replace missing or specific values:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="st">"$path/outputs\MAG_indicators"</span>, <span class="kw">clear</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> country</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> region = 99 <span class="kw">if</span> region==.</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> zone = 99 <span class="kw">if</span> zone==.</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> gender = 99 <span class="kw">if</span> gender==.</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> reference = <span class="st">"NA"</span> <span class="kw">if</span> reference==<span class="st">""</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> _population=_population*10e-7</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The dataset is then subsetted to keep observations where <code>measure</code> is “fgt0” (Foster-Greer-Thorbecke poverty measure with parameter 0). Some transformations are applied to the <code>value</code> variable based on the <code>measure</code> variable. A temporary file (<code>number_poor</code>) is saved. The original data is then restored and appended with this modified subset.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> <span class="kw">if</span> <span class="fu">inlist</span>(measure,<span class="st">"fgt0"</span>)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> <span class="ot">value</span>=<span class="ot">value</span>*_population</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> measure=<span class="st">"np_fgt0"</span> <span class="kw">if</span> measure==<span class="st">"fgt0"</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="kw">tempfile</span> number_poor </span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="ot">`number_poor'</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="kw">append</span> <span class="kw">using</span> <span class="ot">`number_poor'</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>        ```</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>Further transformations are performed:</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>```stata</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> <span class="ot">value</span>=100*<span class="ot">value</span> <span class="kw">if</span> <span class="fu">inlist</span>(measure,<span class="st">"fgt0"</span>,<span class="st">"fgt1"</span>,<span class="st">"fgt2"</span>,<span class="st">"gini"</span>)</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> <span class="kw">variable</span> = <span class="st">"ysim_base_sc0"</span> <span class="kw">if</span> <span class="kw">variable</span>==<span class="st">"Ysim_baseyear"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The code then proceeds to extract <code>scenid</code> (scenario ID) and creates labels for it. It also creates a variable, <code>Ysim</code>, by extracting a part of the <code>variable</code> column. Some cleanup operations are also performed.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>g scenid = <span class="fu">real</span>(<span class="fu">substr</span>(<span class="kw">variable</span>,13,2))</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">define</span> scenid 0 <span class="st">"base year"</span> <span class="ot">$scenid</span> ,<span class="kw">replace</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="kw">label</span> <span class="kw">values</span> scenid scenid</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>g Ysim = <span class="fu">substr</span>(<span class="kw">variable</span>,1,ustrpos(<span class="kw">variable</span>,<span class="st">"_sc"</span>)-5)</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> Ysim = <span class="st">"base"</span> <span class="kw">if</span> <span class="fu">year</span>==<span class="ot">$surveyyear</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="kw">variable</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The final version of the dataset is exported to an Excel file under the sheet “Results_long”.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">export</span> excel <span class="kw">using</span> <span class="st">"$scenario_file"</span>, sheet(<span class="st">"Results_long"</span>,modify) firstrow(varlabels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Overall, this code focuses on data manipulation tasks, including reshaping the data, generating new variables, making adjustments to existing variables, and exporting the processed data to Excel for further use.</p>
</section>
<section id="generating-deviations-from-baseline" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="generating-deviations-from-baseline"><span class="header-section-number">5.3</span> Generating Deviations from Baseline:</h2>
<p>Remove observations where the variable <code>Ysim</code> is equal to “base”. Keep only those observations where the gender is coded as 99. Drop the variable <code>_population</code> as it is not needed. Reshape the dataset from long format to wide format using the <code>value</code> variable, with new columns created for each <code>scenid</code>. This will generate variables like <code>value1</code>, <code>value2</code>, etc., for each scenario.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="kw">if</span> Ysim==<span class="st">"base"</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> <span class="kw">if</span> gender==99</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> _population</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">wide</span> <span class="ot">value</span>, i(measure reference region zone <span class="fu">year</span>) j(scenid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For each scenario, calculate the deviation as a percentage from the baseline (<code>value1</code>). This deviation indicates how much a value in a given scenario has changed relative to the baseline scenario. Similarly, compute the deviation in levels (absolute difference from the baseline).</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> num : <span class="ot">list</span> <span class="kw">sizeof</span> <span class="kw">global</span>(scenarios)</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="kw">forvalues</span> i=2(1)<span class="ot">`num'</span> {</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  g des_percent_<span class="ot">`i'</span> = 100*(value<span class="ot">`i'</span>-value1)/value1</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="kw">forvalues</span> i=2(1)<span class="ot">`num'</span> {</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>  g des_level_<span class="ot">`i'</span> = value<span class="ot">`i'</span>-value1</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Drop all the <code>value*</code> columns. Reshape the dataset back to long format based on the deviation columns. Rename the columns for better clarity.</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="ot">value</span>*</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">long</span> des_percent_ des_level_, i(Ysim measure reference region zone <span class="fu">year</span>) j(scenid)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="kw">rename</span> des_*_ des_*</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create a new variable, <code>concat</code>, that combines several variables into a single string. This is for uniquely identifying or categorizing each observation. Reorder the dataset so that <code>concat</code> appears first.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="fu">concat</span> = measure +<span class="st">"_"</span>+ Ysim+<span class="fu">string</span>(<span class="fu">year</span>)+<span class="st">"_"</span> <span class="co">//</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>             +<span class="fu">string</span>(scenid)+<span class="st">"_"</span>+reference+<span class="st">"_"</span>+  <span class="co">//</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>             <span class="fu">string</span>(region)+<span class="st">"_"</span>+<span class="fu">string</span>(zone)+<span class="st">"_"</span>+ <span class="co">//</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>             <span class="fu">string</span>(gender) </span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="fu">concat</span>, first</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, export the current dataset to an Excel file under the sheet “Deviations_long”.</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">export</span> excel <span class="kw">using</span> <span class="st">"$scenario_file"</span>, sheet(<span class="st">"Deviations_long"</span>,modify) <span class="co">//</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>                   firstrow(varlabels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code is mainly concerned with deriving deviations from a baseline across different scenarios and organizing the resulting dataset for further analysis and presentation. The computed deviations provide insights into how different scenarios compare to a reference or baseline scenario in the given dataset.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>